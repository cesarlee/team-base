<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Base — Collaborative Workspace</title>
<meta name="description" content="A Notion-like collaborative workspace for teams. Create pages, databases with table/board/gallery/calendar views, and manage projects together.">
<meta property="og:title" content="Team Base — Collaborative Workspace">
<meta property="og:description" content="A Notion-like collaborative workspace for teams. Create pages, databases, and manage projects together.">
<meta property="og:type" content="website">
<meta name="agent-spec" content="https://www.visimade.com/api/pages/961/agent-spec">
<script src="https://unpkg.com/lucide@0.309.0/dist/umd/lucide.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;border-radius:0!important}
html,body{height:100%;overflow:hidden}
body{font-family:'Segoe UI',-apple-system,system-ui,sans-serif;font-size:13px;color:#323130;line-height:1.4;background:#fff}
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#c8c6c4;border-radius:0!important}
::-webkit-scrollbar-thumb:hover{background:#a19f9d}
::selection{background:rgba(0,120,212,0.2)}
a{color:#0078d4;text-decoration:none}
a:hover{text-decoration:underline}
button{font-family:inherit;font-size:inherit;cursor:pointer;border:none;background:none;color:inherit}
input,textarea,select{font-family:inherit;font-size:inherit;color:#323130;border-radius:0!important}
[contenteditable]{outline:none}
[contenteditable]:empty::before{content:attr(data-placeholder);color:#a19f9d;font-style:italic;pointer-events:none}

#app{display:flex;height:100vh;width:100vw;overflow:hidden}

/* SIDEBAR */
#sidebar{width:240px;min-width:200px;max-width:400px;background:#f3f2f1;border-right:1px solid #ddd9d7;display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;position:relative;z-index:10}
#sidebar.collapsed{width:0;min-width:0;border-right:none;overflow:hidden}
.sidebar-header{padding:12px 12px 8px;display:flex;align-items:center;gap:8px}
.sidebar-search{display:flex;align-items:center;gap:6px;padding:4px 8px;margin:0 8px 8px;cursor:pointer;color:#605e5c;height:28px;background:#e1dfdd}
.sidebar-search:hover{background:#d2d0ce}
.sidebar-search svg{width:14px;height:14px;flex-shrink:0}
.sidebar-search span{font-size:12px}
.sidebar-section{padding:4px 0}
.sidebar-section-header{display:flex;align-items:center;padding:2px 12px;font-size:11px;font-weight:600;color:#a19f9d;text-transform:uppercase;letter-spacing:0.5px;user-select:none}
.sidebar-item{display:flex;align-items:center;height:28px;padding:0 8px 0 12px;cursor:pointer;gap:4px;position:relative;font-size:13px;color:#323130;user-select:none}
.sidebar-item:hover{background:#e1dfdd}
.sidebar-item.active{background:#fff;border-left:3px solid #0078d4;padding-left:9px}
.sidebar-item .expand-btn{width:18px;height:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:#a19f9d;transition:transform 100ms}
.sidebar-item .expand-btn.expanded{transform:rotate(90deg)}
.sidebar-item .expand-btn:hover{color:#323130}
.sidebar-item .page-icon{width:18px;flex-shrink:0;text-align:center;font-size:14px;line-height:18px}
.sidebar-item .page-icon svg{width:14px;height:14px;color:#605e5c}
.sidebar-item .page-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:13px}
.sidebar-item .item-actions{display:none;gap:2px;align-items:center;flex-shrink:0}
.sidebar-item:hover .item-actions{display:flex}
.sidebar-item .item-actions button{width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:#605e5c}
.sidebar-item .item-actions button:hover{background:#d2d0ce}
.sidebar-children{padding-left:16px}
.sidebar-footer{padding:8px;border-top:1px solid #ddd9d7;margin-top:auto}
.sidebar-footer button{display:flex;align-items:center;gap:6px;width:100%;padding:4px 8px;height:28px;color:#605e5c;font-size:13px}
.sidebar-footer button:hover{background:#e1dfdd}
.sidebar-footer button svg{width:14px;height:14px}
.sidebar-resize{position:absolute;top:0;right:-3px;width:6px;height:100%;cursor:col-resize;z-index:20}
.sidebar-resize:hover{background:rgba(0,120,212,0.3)}

/* MAIN AREA */
#main-wrapper{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
#topbar{height:44px;min-height:44px;background:#fff;border-bottom:1px solid #ddd9d7;display:flex;align-items:center;padding:0 12px;gap:8px;z-index:5}
.topbar-left{display:flex;align-items:center;gap:4px;flex:1;min-width:0}
.topbar-breadcrumb{display:flex;align-items:center;gap:4px;font-size:12px;color:#605e5c;min-width:0}
.topbar-breadcrumb span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px;cursor:pointer}
.topbar-breadcrumb span:hover{color:#0078d4}
.topbar-breadcrumb .sep{color:#a19f9d;flex-shrink:0}
.topbar-right{display:flex;align-items:center;gap:2px;flex-shrink:0}
.topbar-btn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;color:#605e5c;position:relative}
.topbar-btn:hover{background:#f3f2f1}
.topbar-btn.active{color:#0078d4}
.topbar-btn svg{width:16px;height:16px}
.topbar-btn .badge{position:absolute;top:4px;right:4px;background:#d13438;color:#fff;font-size:9px;min-width:14px;height:14px;display:flex;align-items:center;justify-content:center;font-weight:600;padding:0 3px}
.topbar-text-btn{height:32px;padding:0 10px;display:flex;align-items:center;gap:4px;font-size:12px;color:#605e5c}
.topbar-text-btn:hover{background:#f3f2f1}
.topbar-text-btn svg{width:14px;height:14px}
.edited-indicator{font-size:11px;color:#a19f9d;margin-left:8px;white-space:nowrap}

/* PAGE AREA */
#page-area{flex:1;overflow-y:auto;overflow-x:hidden;position:relative}
.page-cover{width:100%;height:200px;background-size:cover;background-position:center;position:relative;cursor:pointer}
.page-cover:hover .cover-actions{opacity:1}
.cover-actions{position:absolute;bottom:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity 150ms}
.cover-actions button{background:rgba(255,255,255,0.9);border:1px solid #d2d0ce;padding:4px 8px;font-size:11px;color:#605e5c}
.cover-actions button:hover{background:#fff}
.page-header{max-width:900px;margin:0 auto;padding:40px 80px 0}
.page-header.full-width{max-width:none}
.page-icon-btn{font-size:48px;line-height:1;cursor:pointer;padding:4px;margin-bottom:8px;display:inline-block}
.page-icon-btn:hover{background:#f3f2f1}
.page-title-input{width:100%;font-size:32px;font-weight:600;border:none;outline:none;background:transparent;color:#323130;padding:0;line-height:1.2;resize:none;overflow:hidden}
.page-title-input::placeholder{color:#a19f9d}
.page-content{max-width:900px;margin:0 auto;padding:8px 80px 100px}
.page-content.full-width{max-width:none}
.page-content.small-text{font-size:12px}
.page-content.font-serif{font-family:Georgia,Cambria,'Times New Roman',serif}
.page-content.font-mono{font-family:'Cascadia Code',Consolas,'Courier New',monospace}

/* BLOCKS */
.block{position:relative;padding:2px 0;margin-left:0}
.block:hover .block-handle,.block:hover .block-add{opacity:1}
.block-handle{position:absolute;left:-28px;top:2px;width:18px;height:22px;display:flex;align-items:center;justify-content:center;color:#a19f9d;cursor:grab;opacity:0;transition:opacity 100ms}
.block-handle:hover{color:#605e5c;background:#f3f2f1}
.block-add{position:absolute;left:-28px;top:24px;width:18px;height:18px;display:flex;align-items:center;justify-content:center;color:#a19f9d;cursor:pointer;opacity:0;font-size:14px;transition:opacity 100ms}
.block-add:hover{color:#605e5c;background:#f3f2f1}
.block.selected{border-left:2px solid #0078d4;margin-left:-2px}
.block-content{min-height:1.4em;outline:none;word-break:break-word}
.block-content:empty::before{content:attr(data-placeholder);color:#a19f9d;font-style:italic}
.block[data-indent="1"]{margin-left:24px}
.block[data-indent="2"]{margin-left:48px}
.block[data-indent="3"]{margin-left:72px}
.block[data-indent="4"]{margin-left:96px}
.block[data-indent="5"]{margin-left:120px}

/* Block types */
.block-heading1 .block-content{font-size:26px;font-weight:600;line-height:1.3;margin:16px 0 4px}
.block-heading2 .block-content{font-size:20px;font-weight:600;line-height:1.3;margin:12px 0 4px}
.block-heading3 .block-content{font-size:16px;font-weight:600;line-height:1.3;margin:8px 0 4px}
.block-bulleted{display:flex;gap:8px;align-items:flex-start}
.block-bulleted::before{content:"\2022";color:#605e5c;font-size:18px;line-height:1.4;flex-shrink:0;width:12px;text-align:center}
.block-numbered{display:flex;gap:8px;align-items:flex-start}
.block-numbered .num{color:#605e5c;font-size:13px;line-height:1.4;flex-shrink:0;min-width:12px;text-align:right}
.block-todo{display:flex;gap:8px;align-items:flex-start}
.block-todo input[type="checkbox"]{margin-top:3px;accent-color:#0078d4;flex-shrink:0;width:16px;height:16px}
.block-todo.checked .block-content{text-decoration:line-through;color:#a19f9d}
.block-toggle{cursor:pointer}
.block-toggle-header{display:flex;gap:4px;align-items:flex-start}
.block-toggle-arrow{width:18px;height:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform 150ms;color:#605e5c}
.block-toggle-arrow.open{transform:rotate(90deg)}
.block-toggle-children{padding-left:22px;display:none}
.block-toggle-children.open{display:block}
.block-quote{border-left:3px solid #323130;padding-left:14px;color:#605e5c}
.block-callout{display:flex;gap:8px;padding:12px;background:#f3f2f1;border:1px solid #ddd9d7}
.block-callout.blue{background:#d0e7f5;border-color:#a3cbe5}
.block-callout.green{background:#dff6dd;border-color:#b7e1b5}
.block-callout.yellow{background:#fff4ce;border-color:#ffe58f}
.block-callout.red{background:#fde7e9;border-color:#f5b4b8}
.block-callout.purple{background:#e8daef;border-color:#d0b8e0}
.block-callout-icon{font-size:18px;flex-shrink:0;width:24px;text-align:center;line-height:1.4}
.block-divider{border:none;border-top:1px solid #ddd9d7;margin:8px 0}
.block-code{background:#f3f2f1;border:1px solid #ddd9d7;padding:12px;font-family:'Cascadia Code',Consolas,'Courier New',monospace;font-size:12px;white-space:pre-wrap;tab-size:2;line-height:1.5;overflow-x:auto}
.block-code-lang{font-size:11px;color:#a19f9d;margin-bottom:4px;font-family:'Segoe UI',sans-serif}
.block-image img{max-width:100%;height:auto}
.block-image .caption{font-size:12px;color:#a19f9d;margin-top:4px;text-align:center}
.block-bookmark{display:flex;border:1px solid #ddd9d7;overflow:hidden}
.block-bookmark-info{flex:1;padding:12px}
.block-bookmark-title{font-weight:600;font-size:13px;margin-bottom:4px}
.block-bookmark-desc{font-size:12px;color:#605e5c;margin-bottom:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.block-bookmark-url{font-size:11px;color:#a19f9d}
.block-page-link{display:flex;align-items:center;gap:6px;padding:4px 8px;cursor:pointer;color:#323130}
.block-page-link:hover{background:#f3f2f1}
.block-page-link svg{width:16px;height:16px;color:#605e5c}

/* SLASH MENU */
#slash-menu{position:fixed;width:320px;max-height:360px;background:#fff;border:1px solid #d2d0ce;z-index:100;overflow-y:auto;display:none}
#slash-menu.visible{display:block}
.slash-menu-input{width:100%;padding:8px 12px;border:none;border-bottom:1px solid #ddd9d7;font-size:13px;outline:none}
.slash-menu-section{padding:4px 0}
.slash-menu-section-title{padding:4px 12px;font-size:11px;font-weight:600;color:#a19f9d;text-transform:uppercase}
.slash-menu-item{display:flex;align-items:center;gap:10px;padding:6px 12px;cursor:pointer}
.slash-menu-item:hover,.slash-menu-item.selected{background:#f3f2f1}
.slash-menu-item-icon{width:36px;height:36px;background:#f3f2f1;border:1px solid #ddd9d7;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.slash-menu-item-icon svg{width:18px;height:18px;color:#605e5c}
.slash-menu-item-info{flex:1;min-width:0}
.slash-menu-item-name{font-size:13px;font-weight:400;color:#323130}
.slash-menu-item-desc{font-size:11px;color:#a19f9d}

/* FORMAT TOOLBAR */
#format-toolbar{position:fixed;display:none;background:#fff;border:1px solid #d2d0ce;z-index:100;padding:4px;gap:2px;align-items:center}
#format-toolbar.visible{display:flex}
.fmt-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:#605e5c}
.fmt-btn:hover{background:#f3f2f1}
.fmt-btn.active{color:#0078d4;background:#d0e7f5}
.fmt-btn svg{width:14px;height:14px}
.fmt-sep{width:1px;height:20px;background:#ddd9d7;margin:0 2px}

/* DATABASE VIEWS */
.db-view-bar{display:flex;align-items:center;gap:4px;padding:8px 0;border-bottom:1px solid #ddd9d7;margin-bottom:8px;flex-wrap:wrap}
.db-view-tab{padding:4px 10px;font-size:12px;color:#605e5c;cursor:pointer;border-bottom:2px solid transparent}
.db-view-tab:hover{background:#f3f2f1}
.db-view-tab.active{color:#0078d4;border-bottom-color:#0078d4}
.db-view-add{height:28px;padding:0 10px;display:flex;align-items:center;justify-content:center;gap:4px;color:#0078d4;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap}
.db-view-add:hover{color:#004e8c;background:#d0e7f5}
.db-actions{display:flex;gap:4px;margin-left:auto;align-items:center}
.db-action-btn{display:flex;align-items:center;gap:4px;padding:4px 8px;font-size:12px;color:#605e5c;height:28px}
.db-action-btn:hover{background:#f3f2f1}
.db-action-btn svg{width:14px;height:14px}

/* Table view */
.db-table-wrapper{overflow:auto;border:1px solid #ddd9d7;max-height:calc(100vh - 180px)}
.db-table{border-collapse:collapse;font-size:12px;table-layout:fixed}
.db-table th{background:#faf9f8;border-bottom:2px solid #ddd9d7;border-right:1px solid #ddd9d7;padding:6px 8px;text-align:left;font-size:11px;font-weight:600;color:#605e5c;text-transform:uppercase;height:32px;position:sticky;top:0;z-index:2;white-space:nowrap;cursor:pointer;user-select:none;overflow:hidden;text-overflow:ellipsis}
.db-table th:hover{background:#f3f2f1}
.db-table th .col-edit-btn{position:absolute;right:12px;top:50%;transform:translateY(-50%);width:22px;height:22px;display:none;align-items:center;justify-content:center;color:#a19f9d;cursor:pointer;background:#f3f2f1;border:1px solid #d2d0ce}
.db-table th:hover .col-edit-btn{display:flex}
.db-table th .col-edit-btn:hover{color:#0078d4;background:#d0e7f5;border-color:#0078d4}
.db-table th .col-resize{position:absolute;right:0;top:0;width:5px;height:100%;cursor:col-resize;z-index:2}
.db-table th .col-resize:hover,.db-table th .col-resize.resizing{background:#0078d4}
.db-table td{border-bottom:1px solid #ddd9d7;border-right:1px solid #ddd9d7;padding:4px 8px;height:32px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:cell}
.db-table td.editing{overflow:visible;padding:0}
.db-table td.editing input,.db-table td.editing select{width:100%;height:100%;min-height:31px;border:2px solid #0078d4;outline:none;padding:2px 6px;font-size:12px;background:#fff;margin:0;box-sizing:border-box}
body.dark .db-table td.editing input,body.dark .db-table td.editing select{background:#2d2d2d;color:#d4d4d4;border-color:#0078d4}
.db-table td.cell-title{cursor:pointer}
.db-table td.cell-title:hover{color:#0078d4;text-decoration:underline}
.db-table .row-drag-handle{width:24px;min-width:24px;max-width:24px;padding:0;text-align:center;cursor:grab;color:transparent;user-select:none;vertical-align:middle}
.db-table tr:hover .row-drag-handle{color:#a19f9d}
.db-table .row-drag-handle:hover{color:#605e5c!important}
.db-table .row-drag-handle i{width:14px;height:14px;pointer-events:none}
.db-table tr.row-dragging{opacity:0.4}
.db-table tr.row-drag-over-above td{box-shadow:inset 0 2px 0 #0078d4}
.db-table tr.row-drag-over-below td{box-shadow:inset 0 -2px 0 #0078d4}
body.dark .db-table tr:hover .row-drag-handle{color:#888}
body.dark .db-table .row-drag-handle:hover{color:#ccc!important}
.cell-url-wrap{position:relative;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:12px}
.cell-url-open{display:none;position:absolute;right:0;top:50%;transform:translateY(-50%);width:20px;height:20px;align-items:center;justify-content:center;color:#0078d4;cursor:pointer;background:#fff;border-radius:3px}
.cell-url-open:hover{background:#d0e7f5}
td:hover .cell-url-open{display:inline-flex}
body.dark .cell-url-open{background:#2b2b2b}
body.dark .cell-url-open:hover{background:#1a3a4f}
.db-table tr:nth-child(even){background:#faf9f8}
.db-table tr:hover td{background:#f3f2f1}
.db-table tr.new-row td{border-bottom:none}
.db-table .cell-edit{width:100%;border:none;outline:none;background:transparent;font-size:12px;padding:0}
.db-table .add-row-btn{color:#a19f9d;cursor:pointer;font-size:12px;padding:6px 8px;display:flex;align-items:center;gap:4px}
.db-table .add-row-btn:hover{color:#605e5c;background:#f3f2f1}
.db-table th.col-dragging{opacity:0.4}
.db-table th.col-drag-over-left{box-shadow:inset 3px 0 0 #0078d4}
.db-table th.col-drag-over-right{box-shadow:inset -3px 0 0 #0078d4}
.db-table .add-col-btn{width:36px;min-width:36px;max-width:36px;text-align:center;cursor:pointer;color:#0078d4;font-size:12px;font-weight:600;letter-spacing:0;text-transform:none;padding:0}
.db-table .add-col-btn:hover{background:#d0e7f5;color:#004e8c}
.db-table .add-col-btn i{vertical-align:middle}

/* Add Property Modal */
#add-prop-modal .modal{max-width:440px}
.prop-type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin:12px 0}
.prop-type-option{border:1px solid #ddd9d7;padding:10px 8px;text-align:center;cursor:pointer;transition:border-color 100ms,background 100ms}
.prop-type-option:hover{border-color:#0078d4;background:#f0f6ff}
.prop-type-option.selected{border-color:#0078d4;background:#d0e7f5}
.prop-type-option svg,.prop-type-option i{display:block;margin:0 auto 4px;width:20px;height:20px;color:#605e5c}
.prop-type-option.selected svg,.prop-type-option.selected i{color:#0078d4}
.prop-type-option span{display:block;font-size:11px;color:#605e5c;line-height:1.3}
.prop-type-option.selected span{color:#004e8c;font-weight:600}
.choices-editor{margin-top:16px}
.choices-editor-label{font-size:12px;font-weight:600;color:#605e5c;margin-bottom:6px;display:block}
.choice-row{display:flex;align-items:center;gap:6px;margin-bottom:6px}
.choice-row input[type="text"]{flex:1;height:30px;border:1px solid #8a8886;padding:0 8px;font-size:13px;outline:none}
.choice-row input[type="text"]:focus{border-color:#0078d4}
.choice-color-btn{width:30px;height:30px;border:1px solid #d2d0ce;cursor:pointer;flex-shrink:0;position:relative}
.choice-color-btn:hover{border-color:#8a8886}
.choice-remove-btn{width:30px;height:30px;display:flex;align-items:center;justify-content:center;color:#a19f9d;flex-shrink:0;cursor:pointer}
.choice-remove-btn:hover{color:#d13438;background:#fde7e9}
.choice-add-btn{display:flex;align-items:center;gap:6px;padding:6px 0;color:#0078d4;font-size:12px;font-weight:600;cursor:pointer;margin-top:4px}
.choice-add-btn:hover{text-decoration:underline}
.color-picker-dropdown{position:absolute;top:100%;left:0;background:#fff;border:1px solid #d2d0ce;padding:6px;z-index:10;display:grid;grid-template-columns:repeat(5,1fr);gap:4px;width:160px}
.color-swatch{width:24px;height:24px;cursor:pointer;border:2px solid transparent}
.color-swatch:hover{border-color:#323130}
.color-swatch.active{border-color:#0078d4}
/* File property */
.file-list{display:flex;flex-direction:column;gap:4px}
.file-item{display:flex;align-items:center;gap:8px;padding:4px 8px;border:1px solid #ddd9d7;background:#faf9f8;font-size:12px}
.file-item:hover{background:#f3f2f1}
.file-item-icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center;color:#605e5c;flex-shrink:0}
.file-item-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#0078d4;cursor:pointer}
.file-item-name:hover{text-decoration:underline}
.file-item-size{font-size:11px;color:#a19f9d;flex-shrink:0}
.file-item-remove{width:22px;height:22px;display:flex;align-items:center;justify-content:center;color:#a19f9d;cursor:pointer;flex-shrink:0}
.file-item-remove:hover{color:#d13438;background:#fde7e9}
.file-upload-btn{display:flex;align-items:center;gap:6px;padding:6px 12px;border:1px dashed #8a8886;color:#605e5c;font-size:12px;cursor:pointer;margin-top:4px;justify-content:center;background:#faf9f8;transition:border-color 100ms,background 100ms}
.file-upload-btn:hover{border-color:#0078d4;color:#0078d4;background:#f0f6ff}
.file-upload-btn.uploading{opacity:0.6;pointer-events:none}
.file-cell-tag{display:inline-flex;align-items:center;gap:3px;padding:1px 6px;font-size:11px;background:#f3f2f1;color:#605e5c;margin-right:4px;white-space:nowrap}
.file-cell-tag i{width:10px;height:10px}

#edit-prop-modal .modal{max-width:440px}

/* Add View Modal */
#add-view-modal .modal{max-width:420px}
.sort-rule-row{display:flex;align-items:center;gap:8px;padding:6px 0}
.sort-rule-row select{flex:1;padding:6px 8px;border:1px solid #ddd9d7;border-radius:4px;font-size:13px;background:#fff;outline:none}
.sort-rule-row select:focus{border-color:#0078d4}
.sort-rule-remove{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border:none;background:none;cursor:pointer;color:#a19f9d;border-radius:4px}
.sort-rule-remove:hover{background:#f3f2f1;color:#d13438}
.sort-empty{padding:16px 0;text-align:center;color:#a19f9d;font-size:13px}
.col-toggle-row{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid #f3f2f1}
.col-toggle-row:last-child{border-bottom:none}
.col-toggle-row .col-toggle-name{flex:1;font-size:13px;display:flex;align-items:center;gap:6px}
.col-toggle-row .col-toggle-name i{width:14px;height:14px;color:#a19f9d}
.col-toggle-switch{position:relative;width:36px;height:20px;flex-shrink:0}
.col-toggle-switch input{opacity:0;width:0;height:0}
.col-toggle-switch .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#c8c6c4;border-radius:10px;transition:.2s}
.col-toggle-switch .slider:before{position:absolute;content:"";height:14px;width:14px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s}
.col-toggle-switch input:checked+.slider{background:#0078d4}
.col-toggle-switch input:checked+.slider:before{transform:translateX(16px)}
.col-toggle-row.disabled{opacity:.5}
.col-toggle-row .col-toggle-tag{font-size:10px;color:#a19f9d;margin-left:auto;margin-right:4px}
.view-type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin:12px 0}
.view-type-option{border:1px solid #ddd9d7;padding:14px 8px;text-align:center;cursor:pointer;transition:border-color 100ms,background 100ms}
.view-type-option:hover{border-color:#0078d4;background:#f0f6ff}
.view-type-option.selected{border-color:#0078d4;background:#d0e7f5}
.view-type-option svg,.view-type-option i{display:block;margin:0 auto 6px;width:24px;height:24px;color:#605e5c}
.view-type-option.selected svg,.view-type-option.selected i{color:#0078d4}
.view-type-option span{display:block;font-size:11px;color:#605e5c;line-height:1.3}
.view-type-option.selected span{color:#004e8c;font-weight:600}

/* Board view */
.db-board{display:flex;gap:12px;overflow-x:auto;padding-bottom:12px;align-items:flex-start}
.db-board-col{min-width:240px;max-width:280px;flex-shrink:0}
.db-board-col-header{display:flex;align-items:center;gap:6px;padding:6px 8px;margin-bottom:8px}
.db-board-col-title{font-size:12px;font-weight:600;color:#605e5c;flex:1}
.db-board-col-count{font-size:11px;color:#a19f9d;background:#e1dfdd;padding:0 6px;height:18px;display:flex;align-items:center}
.db-board-card{background:#fff;border:1px solid #ddd9d7;padding:10px;margin-bottom:6px;cursor:pointer;transition:opacity 150ms,box-shadow 150ms}
.db-board-card:hover{background:#faf9f8}
.db-board-card.dragging{opacity:0.4;box-shadow:none}
.db-board-card.drag-over-above{border-top:2px solid #0078d4;margin-top:-1px}
.db-board-card.drag-over-below{border-bottom:2px solid #0078d4;margin-bottom:4px}
.db-board-col.drag-col-over>.db-board-drop-zone{border-color:#0078d4;background:#f0f6ff;color:#0078d4}
.db-board-drop-zone{min-height:40px;border:2px dashed #e1dfdd;margin-bottom:6px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#c8c6c4;transition:border-color 150ms,background 150ms}
.db-board-card-title{font-size:13px;font-weight:400;margin-bottom:6px;color:#323130}
.db-board-card-props{display:flex;flex-wrap:wrap;gap:4px}
.db-board-add{display:flex;align-items:center;gap:4px;padding:6px 8px;color:#a19f9d;font-size:12px;cursor:pointer}
.db-board-add:hover{background:#f3f2f1;color:#605e5c}

/* List view */
.db-list-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-bottom:1px solid #ddd9d7;cursor:pointer}
.db-list-item:hover{background:#f3f2f1}
.db-list-item-title{font-size:13px;color:#323130;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.db-list-item-props{display:flex;gap:6px;align-items:center;flex-shrink:0}

/* Calendar view */
.db-calendar{border:1px solid #ddd9d7}
.db-calendar-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #ddd9d7}
.db-calendar-nav{display:flex;align-items:center;gap:8px}
.db-calendar-nav button{width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:#605e5c}
.db-calendar-nav button:hover{background:#f3f2f1}
.db-calendar-month{font-size:14px;font-weight:600}
.db-calendar-grid{display:grid;grid-template-columns:repeat(7,1fr)}
.db-calendar-day-header{padding:4px;text-align:center;font-size:11px;font-weight:600;color:#a19f9d;border-bottom:1px solid #ddd9d7;border-right:1px solid #ddd9d7}
.db-calendar-day{min-height:80px;padding:4px;border-bottom:1px solid #ddd9d7;border-right:1px solid #ddd9d7;cursor:pointer;font-size:12px}
.db-calendar-day:hover{background:#faf9f8}
.db-calendar-day.today{background:#f0f6ff}
.db-calendar-day.other-month{background:#faf9f8}
.db-calendar-day .day-num{font-size:12px;color:#605e5c;margin-bottom:2px}
.db-calendar-day.today .day-num{color:#0078d4;font-weight:600}
.db-calendar-event{padding:1px 4px;margin-bottom:1px;font-size:11px;border-left:3px solid #0078d4;background:#f3f2f1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer}

/* Gallery view */
.db-gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.db-gallery-card{border:1px solid #ddd9d7;cursor:pointer;overflow:hidden}
.db-gallery-card:hover{background:#faf9f8}
.db-gallery-cover{height:140px;background:#f3f2f1;background-size:cover;background-position:center}
.db-gallery-info{padding:10px}
.db-gallery-title{font-size:13px;font-weight:600;margin-bottom:6px}
.db-gallery-props{display:flex;flex-wrap:wrap;gap:4px}

/* Property tags */
.prop-tag{display:inline-flex;align-items:center;padding:1px 6px;font-size:11px;white-space:nowrap;line-height:1.5}
.prop-tag.light_gray{background:#f3f2f1;color:#605e5c}
.prop-tag.gray{background:#e1dfdd;color:#323130}
.prop-tag.brown{background:#e8dcd2;color:#6e4b2d}
.prop-tag.orange{background:#fde7d0;color:#c45d1a}
.prop-tag.yellow{background:#fff4ce;color:#7a6400}
.prop-tag.green{background:#dff6dd;color:#107c10}
.prop-tag.blue{background:#d0e7f5;color:#004e8c}
.prop-tag.purple{background:#e8daef;color:#5c2d91}
.prop-tag.pink{background:#fce4ec;color:#b4009e}
.prop-tag.red{background:#fde7e9;color:#a80000}

/* RIGHT PANEL */
#right-panel{width:0;overflow:hidden;border-left:1px solid #ddd9d7;background:#fff;flex-shrink:0;transition:width 200ms ease-out;display:flex;flex-direction:column}
#right-panel.open{width:360px}
.panel-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #ddd9d7;min-height:44px}
.panel-header-title{font-size:14px;font-weight:600;color:#323130}
.panel-close{width:28px;height:28px;display:flex;align-items:center;justify-content:center;color:#605e5c}
.panel-close:hover{background:#f3f2f1}
.panel-body{flex:1;overflow-y:auto;padding:12px 16px}
.panel-footer{padding:12px 16px;border-top:1px solid #ddd9d7}

/* Comments */
.comment-item{margin-bottom:16px}
.comment-author{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.comment-avatar{width:24px;height:24px;background:#0078d4;color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;flex-shrink:0}
.comment-name{font-size:12px;font-weight:600;color:#323130}
.comment-time{font-size:11px;color:#a19f9d}
.comment-body{background:#f3f2f1;border:1px solid #ddd9d7;padding:8px 10px;font-size:13px;margin-left:30px}
.comment-actions{display:flex;gap:8px;margin-left:30px;margin-top:4px}
.comment-actions button{font-size:11px;color:#605e5c}
.comment-actions button:hover{color:#0078d4}
.comment-resolved{opacity:0.5}
.comment-input{width:100%;min-height:60px;border:1px solid #8a8886;padding:8px;font-size:13px;resize:vertical;outline:none}
.comment-input:focus{border:2px solid #0078d4}
.comment-submit{margin-top:8px;background:#0078d4;color:#fff;padding:0 16px;height:32px;font-size:12px;font-weight:600}
.comment-submit:hover{filter:brightness(0.95)}

/* MODALS */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:200;display:none;align-items:flex-start;justify-content:center;padding-top:10vh}
.modal-overlay.visible{display:flex}
.modal{background:#fff;border:1px solid #d2d0ce;width:100%;position:relative}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #ddd9d7}
.modal-header h2{font-size:16px;font-weight:600}
.modal-body{padding:16px;max-height:60vh;overflow-y:auto}
.modal-footer{padding:12px 16px;border-top:1px solid #ddd9d7;display:flex;justify-content:flex-end;gap:8px}

/* Search modal */
#search-modal .modal{max-width:640px}
.search-input{width:100%;padding:12px 16px;border:none;border-bottom:1px solid #ddd9d7;font-size:16px;outline:none}
.search-results{max-height:400px;overflow-y:auto}
.search-result-group{padding:8px 0}
.search-result-group-title{padding:4px 16px;font-size:11px;font-weight:600;color:#a19f9d;text-transform:uppercase}
.search-result-item{display:flex;align-items:center;gap:10px;padding:8px 16px;cursor:pointer}
.search-result-item:hover{background:#f3f2f1}
.search-result-item .result-icon{width:24px;flex-shrink:0;text-align:center;font-size:16px}
.search-result-item .result-info{flex:1;min-width:0}
.search-result-item .result-title{font-size:13px;color:#323130;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.search-result-item .result-path{font-size:11px;color:#a19f9d}
.search-empty{padding:40px;text-align:center;color:#a19f9d}

/* Template modal */
#template-modal .modal{max-width:800px}
.template-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.template-card{border:1px solid #ddd9d7;padding:16px;cursor:pointer}
.template-card:hover{background:#faf9f8;border-color:#d2d0ce}
.template-card-icon{font-size:28px;margin-bottom:8px}
.template-card-title{font-size:13px;font-weight:600;margin-bottom:4px}
.template-card-desc{font-size:12px;color:#605e5c}
.template-category-title{font-size:14px;font-weight:600;margin:16px 0 8px;color:#323130}

/* Share modal */
#share-modal .modal{max-width:480px}
.perm-list{margin-bottom:16px}
.perm-item{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #ddd9d7}
.perm-item .perm-avatar{width:28px;height:28px;background:#0078d4;color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;flex-shrink:0}
.perm-item .perm-name{flex:1;font-size:13px}
.perm-item select{border:1px solid #8a8886;padding:2px 6px;height:28px;font-size:12px}

/* Record detail modal */
#record-modal .modal{max-width:700px}
.record-props{margin-bottom:16px}
.record-prop{display:flex;align-items:flex-start;gap:12px;padding:6px 0;border-bottom:1px solid #ddd9d7}
.record-prop-label{width:120px;flex-shrink:0;font-size:12px;color:#605e5c;font-weight:600;padding-top:4px}
.record-prop-value{flex:1;font-size:13px}
.record-prop-value input,.record-prop-value select,.record-prop-value textarea{width:100%;border:1px solid #8a8886;padding:4px 8px;height:28px;font-size:12px}
.record-prop-value textarea{height:60px;resize:vertical}

/* Emoji picker */
#emoji-picker{position:fixed;width:320px;max-height:300px;background:#fff;border:1px solid #d2d0ce;z-index:110;overflow-y:auto;padding:8px;display:none}
#emoji-picker.visible{display:block}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px}
.emoji-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer}
.emoji-btn:hover{background:#f3f2f1}

/* Context menu */
#context-menu{position:fixed;background:#fff;border:1px solid #d2d0ce;z-index:120;min-width:180px;padding:4px 0;display:none}
#context-menu.visible{display:block}
.ctx-item{display:flex;align-items:center;gap:8px;padding:6px 12px;cursor:pointer;font-size:13px}
.ctx-item:hover{background:#f3f2f1}
.ctx-item svg{width:14px;height:14px;color:#605e5c}
.ctx-item.danger{color:#d13438}
.ctx-item.danger svg{color:#d13438}
.ctx-sep{height:1px;background:#ddd9d7;margin:4px 0}

/* Toast notifications */
#toast-container{position:fixed;bottom:16px;right:16px;z-index:300;display:flex;flex-direction:column;gap:8px}
.toast{background:#323130;color:#fff;padding:10px 16px;font-size:13px;display:flex;align-items:center;gap:8px;animation:toastIn 200ms ease-out}
.toast.success{border-left:3px solid #107c10}
.toast.error{border-left:3px solid #d13438}
@keyframes toastIn{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}

/* Buttons */
.btn-primary{background:#0078d4;color:#fff;border:none;padding:0 16px;height:32px;font-size:13px;font-weight:600;cursor:pointer}
.btn-primary:hover{filter:brightness(0.95)}
.btn-secondary{background:#fff;color:#323130;border:1px solid #8a8886;padding:0 16px;height:32px;font-size:13px;cursor:pointer}
.btn-secondary:hover{background:#f3f2f1}
.btn-danger{background:#d13438;color:#fff;border:none;padding:0 16px;height:32px;font-size:13px;font-weight:600;cursor:pointer}
.btn-danger:hover{filter:brightness(0.95)}
.btn-ghost{background:transparent;color:#605e5c;padding:0 8px;height:28px;font-size:12px;cursor:pointer}
.btn-ghost:hover{background:#f3f2f1}

/* Trash view */
.trash-table{width:100%;border-collapse:collapse;font-size:12px}
.trash-table th{background:#faf9f8;border-bottom:2px solid #ddd9d7;padding:8px;text-align:left;font-size:11px;font-weight:600;color:#605e5c;text-transform:uppercase}
.trash-table td{border-bottom:1px solid #ddd9d7;padding:8px}
.trash-table tr:hover td{background:#f3f2f1}

/* Empty state */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:#a19f9d}
.empty-state svg{width:48px;height:48px;margin-bottom:12px;color:#d2d0ce}
.empty-state p{font-size:14px;margin-bottom:8px}
.empty-state .sub{font-size:12px}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;padding:40px;color:#a19f9d}
.spinner{width:20px;height:20px;border:2px solid #ddd9d7;border-top-color:#0078d4;animation:spin 600ms linear infinite;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* View filter/sort dropdowns */
.dropdown-panel{position:absolute;top:100%;left:0;background:#fff;border:1px solid #d2d0ce;z-index:50;min-width:280px;padding:12px;display:none}
.dropdown-panel.visible{display:block}
.filter-row{display:flex;gap:6px;align-items:center;margin-bottom:6px}
.filter-row select,.filter-row input{height:28px;border:1px solid #8a8886;padding:0 6px;font-size:12px;flex:1}
.sort-row{display:flex;gap:6px;align-items:center;margin-bottom:6px}
.sort-row select{height:28px;border:1px solid #8a8886;padding:0 6px;font-size:12px;flex:1}

/* New view modal */
.view-type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:12px 0}
.view-type-option{border:1px solid #ddd9d7;padding:12px;text-align:center;cursor:pointer}
.view-type-option:hover{border-color:#0078d4;background:#f0f6ff}
.view-type-option.selected{border-color:#0078d4;background:#d0e7f5}
.view-type-option svg{width:24px;height:24px;color:#605e5c;margin-bottom:4px}
.view-type-option span{display:block;font-size:12px}

/* ============================================================
   DARK THEME
   ============================================================ */
body.dark{background:#1e1e1e;color:#d4d4d4}
body.dark ::-webkit-scrollbar-thumb{background:#555}
body.dark ::-webkit-scrollbar-thumb:hover{background:#777}
body.dark ::selection{background:rgba(0,120,212,0.35)}
body.dark input,body.dark textarea,body.dark select{color:#d4d4d4;background:#2d2d2d;border-color:#555!important}
body.dark input:focus,body.dark textarea:focus,body.dark select:focus{border-color:#0078d4!important}

/* Sidebar */
body.dark #sidebar{background:#252526;border-right-color:#333}
body.dark .sidebar-search{background:#333;color:#aaa}
body.dark .sidebar-search:hover{background:#3c3c3c}
body.dark .sidebar-item{color:#ccc}
body.dark .sidebar-item:hover{background:#2a2d2e}
body.dark .sidebar-item.active{background:#37373d;border-left-color:#0078d4}
body.dark .sidebar-item .page-icon svg{color:#999}
body.dark .sidebar-item .item-actions button:hover{background:#3c3c3c}
body.dark .sidebar-footer{border-top-color:#333}
body.dark .sidebar-footer button{color:#aaa}
body.dark .sidebar-footer button:hover{background:#2a2d2e}
body.dark .sidebar-resize:hover{background:rgba(0,120,212,0.4)}

/* Topbar */
body.dark #topbar{background:#1e1e1e;border-bottom-color:#333}
body.dark .topbar-breadcrumb span{color:#aaa}
body.dark .topbar-breadcrumb span:hover{color:#4fc3f7}
body.dark .topbar-breadcrumb .sep{color:#666}
body.dark .topbar-btn{color:#aaa}
body.dark .topbar-btn:hover{background:#2a2d2e}
body.dark .topbar-text-btn{color:#aaa}
body.dark .topbar-text-btn:hover{background:#2a2d2e}

/* Page area */
body.dark .page-title-input{color:#e0e0e0}
body.dark .page-title-input::placeholder{color:#666}
body.dark .page-icon-btn:hover{background:#2a2d2e}

/* Blocks */
body.dark .block-handle:hover{color:#ccc;background:#2a2d2e}
body.dark .block-add:hover{color:#ccc;background:#2a2d2e}
body.dark .block-content:empty::before{color:#666}
body.dark .block-bulleted::before{color:#aaa}
body.dark .block-numbered .num{color:#aaa}
body.dark .block-todo.checked .block-content{color:#666}
body.dark .block-toggle-arrow{color:#aaa}
body.dark .block-quote{border-left-color:#888;color:#aaa}
body.dark .block-callout{background:#2a2d2e;border-color:#444}
body.dark .block-callout.blue{background:#1a3a4f;border-color:#2a5a7f}
body.dark .block-callout.green{background:#1a3a1a;border-color:#2a6a2a}
body.dark .block-callout.yellow{background:#3a3a1a;border-color:#6a6a2a}
body.dark .block-callout.red{background:#3a1a1a;border-color:#6a2a2a}
body.dark .block-callout.purple{background:#2a1a3a;border-color:#4a2a6a}
body.dark .block-divider{border-top-color:#444}
body.dark .block-code{background:#2d2d2d;border-color:#444;color:#d4d4d4}
body.dark .block-code-lang{color:#888}
body.dark .block-page-link{color:#d4d4d4}
body.dark .block-page-link:hover{background:#2a2d2e}
body.dark .block-page-link svg{color:#999}
body.dark .block-bookmark{border-color:#444}
body.dark .block-bookmark-title{color:#d4d4d4}
body.dark .block-bookmark-desc{color:#aaa}

/* Slash menu */
body.dark #slash-menu{background:#252526;border-color:#444}
body.dark .slash-menu-input{background:#2d2d2d;border-bottom-color:#444;color:#d4d4d4}
body.dark .slash-menu-item:hover,body.dark .slash-menu-item.selected{background:#2a2d2e}
body.dark .slash-menu-item-icon{background:#333;border-color:#444}
body.dark .slash-menu-item-icon svg{color:#aaa}
body.dark .slash-menu-item-name{color:#d4d4d4}
body.dark .slash-menu-item-desc{color:#888}

/* Format toolbar */
body.dark #format-toolbar{background:#252526;border-color:#444}
body.dark .fmt-btn{color:#aaa}
body.dark .fmt-btn:hover{background:#2a2d2e}
body.dark .fmt-btn.active{color:#4fc3f7;background:#1a3a4f}
body.dark .fmt-sep{background:#444}

/* Database views */
body.dark .db-view-bar{border-bottom-color:#444}
body.dark .db-view-tab{color:#aaa}
body.dark .db-view-tab:hover{background:#2a2d2e}
body.dark .db-view-tab.active{color:#4fc3f7;border-bottom-color:#0078d4}
body.dark .db-action-btn{color:#aaa}
body.dark .db-action-btn:hover{background:#2a2d2e}

/* Table */
body.dark .db-table-wrapper{border-color:#444}
body.dark .db-table th{background:#252526;border-bottom-color:#444;border-right-color:#444;color:#aaa}
body.dark .db-table th:hover{background:#2a2d2e}
body.dark .db-table th .col-edit-btn{background:#333;border-color:#555;color:#aaa}
body.dark .db-table th .col-edit-btn:hover{color:#4fc3f7;background:#1a3a4f;border-color:#0078d4}
body.dark .db-table td{border-bottom-color:#333;border-right-color:#333;color:#ccc}
body.dark .db-table tr:nth-child(even){background:#252526}
body.dark .db-table tr:hover td{background:#2a2d2e}
body.dark .db-table .add-row-btn{color:#888}
body.dark .db-table .add-row-btn:hover{color:#ccc;background:#2a2d2e}

/* Board */
body.dark .db-board-card{background:#252526;border-color:#444;color:#ccc}
body.dark .db-board-card:hover{background:#2a2d2e}
body.dark .db-board-card-title{color:#d4d4d4}
body.dark .db-board-col-count{background:#333;color:#aaa}
body.dark .db-board-add{color:#888}
body.dark .db-board-add:hover{background:#2a2d2e;color:#ccc}
body.dark .db-board-drop-zone{border-color:#444}

/* List */
body.dark .db-list-item{border-bottom-color:#333}
body.dark .db-list-item:hover{background:#2a2d2e}
body.dark .db-list-item-title{color:#d4d4d4}

/* Calendar */
body.dark .db-cal-header{border-bottom-color:#444;color:#ccc}
body.dark .db-cal-grid{border-color:#444}
body.dark .db-cal-grid th{background:#252526;border-color:#444;color:#aaa}
body.dark .db-cal-grid td{border-color:#333}
body.dark .db-cal-grid td.today{background:#1a3a4f}
body.dark .db-cal-grid td:hover{background:#2a2d2e}
body.dark .db-cal-grid .day-num{color:#aaa}
body.dark .db-cal-grid .day-num.other{color:#555}
body.dark .db-cal-grid .cal-item{background:#333;color:#ccc}
body.dark .db-cal-grid .cal-item:hover{background:#3c3c3c}

/* Gallery */
body.dark .db-gallery-card{border-color:#444}
body.dark .db-gallery-card:hover{background:#2a2d2e}
body.dark .db-gallery-cover{background:#333}
body.dark .db-gallery-title{color:#d4d4d4}

/* Right panel */
body.dark #right-panel{background:#1e1e1e;border-left-color:#333}
body.dark .panel-header{border-bottom-color:#333}
body.dark .panel-header-title{color:#d4d4d4}
body.dark .panel-close{color:#aaa}
body.dark .panel-close:hover{background:#2a2d2e}
body.dark .panel-footer{border-top-color:#333}
body.dark .comment-name{color:#d4d4d4}
body.dark .comment-body{background:#2d2d2d;border-color:#444;color:#ccc}
body.dark .comment-input{background:#2d2d2d;border-color:#555;color:#d4d4d4}

/* Modals */
body.dark .modal-overlay{background:rgba(0,0,0,0.6)}
body.dark .modal{background:#252526;border-color:#444}
body.dark .modal-header{border-bottom-color:#444}
body.dark .modal-header h2{color:#d4d4d4}
body.dark .modal-body{color:#ccc}
body.dark .modal-footer{border-top-color:#444}
body.dark .search-input{background:#2d2d2d;border-bottom-color:#444;color:#d4d4d4}
body.dark .search-result-item:hover{background:#2a2d2e}
body.dark .search-result-item .result-title{color:#d4d4d4}
body.dark .template-card{border-color:#444;color:#ccc}
body.dark .template-card:hover{background:#2a2d2e;border-color:#555}
body.dark .template-card-title{color:#d4d4d4}
body.dark .template-category-title{color:#d4d4d4}

/* Record modal */
body.dark .record-prop{border-bottom-color:#444}
body.dark .record-prop-label{color:#aaa}

/* Property modals */
body.dark .prop-type-option{border-color:#444;color:#ccc}
body.dark .prop-type-option:hover{border-color:#0078d4;background:#1a3a4f}
body.dark .prop-type-option.selected{border-color:#0078d4;background:#1a4a6f}
body.dark .prop-type-option svg,body.dark .prop-type-option i{color:#aaa}
body.dark .prop-type-option.selected svg,body.dark .prop-type-option.selected i{color:#4fc3f7}
body.dark .prop-type-option span{color:#aaa}
body.dark .prop-type-option.selected span{color:#4fc3f7}
body.dark .view-type-option{border-color:#444;color:#ccc}
body.dark .view-type-option:hover{border-color:#0078d4;background:#1a3a4f}
body.dark .view-type-option.selected{border-color:#0078d4;background:#1a4a6f}
body.dark .view-type-option svg{color:#aaa}
body.dark .view-type-option.selected svg{color:#4fc3f7}
body.dark .sort-rule-row select{background:#2b2b2b;border-color:#444;color:#e0e0e0}
body.dark .sort-rule-row select:focus{border-color:#4fc3f7}
body.dark .sort-rule-remove:hover{background:#3a3a3a;color:#f44}
body.dark .col-toggle-row{border-bottom-color:#3a3a3a}
body.dark .col-toggle-switch .slider{background:#555}
body.dark .col-toggle-switch input:checked+.slider{background:#4fc3f7}
body.dark .choices-editor-label{color:#aaa}
body.dark .choice-color-btn{border-color:#555}
body.dark .color-picker-dropdown{background:#252526;border-color:#444}
body.dark .choice-remove-btn{color:#888}
body.dark .choice-remove-btn:hover{color:#f44;background:#3a1a1a}
body.dark .choice-add-btn{color:#4fc3f7}

/* File items */
body.dark .file-item{border-color:#444;background:#2d2d2d;color:#ccc}
body.dark .file-item:hover{background:#333}
body.dark .file-item-icon{color:#aaa}
body.dark .file-item-name{color:#4fc3f7}
body.dark .file-item-remove{color:#888}
body.dark .file-item-remove:hover{color:#f44;background:#3a1a1a}
body.dark .file-upload-btn{border-color:#555;color:#aaa;background:#2d2d2d}
body.dark .file-upload-btn:hover{border-color:#0078d4;color:#4fc3f7;background:#1a3a4f}

/* Context menu */
body.dark #context-menu{background:#252526;border-color:#444}
body.dark .ctx-item{color:#ccc}
body.dark .ctx-item:hover{background:#2a2d2e}
body.dark .ctx-item svg{color:#aaa}
body.dark .ctx-item.danger{color:#f44}
body.dark .ctx-item.danger svg{color:#f44}
body.dark .ctx-sep{background:#444}

/* Group-by menu */
body.dark #group-by-menu{background:#252526;border-color:#444;box-shadow:0 4px 12px rgba(0,0,0,0.4)}

/* Buttons */
body.dark .btn-secondary{background:#2d2d2d;color:#ccc;border-color:#555}
body.dark .btn-secondary:hover{background:#333}
body.dark .btn-ghost{color:#aaa}
body.dark .btn-ghost:hover{background:#2a2d2e}

/* Emoji picker */
body.dark #emoji-picker{background:#252526;border-color:#444}
body.dark .emoji-btn:hover{background:#2a2d2e}

/* Trash table */
body.dark .trash-table th{background:#252526;border-bottom-color:#444;color:#aaa}
body.dark .trash-table td{border-bottom-color:#333;color:#ccc}
body.dark .trash-table tr:hover td{background:#2a2d2e}

/* Empty state / loading */
body.dark .empty-state{color:#888}
body.dark .empty-state svg{color:#555}
body.dark .loading{color:#888}
body.dark .spinner{border-color:#444;border-top-color:#0078d4}

/* Dropdown panel */
body.dark .dropdown-panel{background:#252526;border-color:#444}

/* Description panel in type selectors */
body.dark div[style*="background:#faf9f8"]{background:#2d2d2d!important;border-color:#444!important}

/* Upgrade modal */
#upgrade-modal .modal{max-width:420px;text-align:center;padding:32px 28px}
.upgrade-icon{font-size:48px;margin-bottom:16px}
.upgrade-title{font-size:20px;font-weight:600;color:#323130;margin-bottom:8px}
.upgrade-msg{font-size:14px;color:#605e5c;margin-bottom:24px;line-height:1.5}
.upgrade-btn{display:inline-flex;align-items:center;gap:6px;background:#0078d4;color:#fff;padding:10px 24px;font-size:14px;font-weight:600;cursor:pointer;text-decoration:none;border:none;transition:background 150ms}
.upgrade-btn:hover{background:#106ebe;text-decoration:none;color:#fff}
.upgrade-dismiss{display:block;margin-top:12px;font-size:12px;color:#a19f9d;cursor:pointer;background:none;border:none}
.upgrade-dismiss:hover{color:#605e5c}
.plan-badge{display:inline-flex;align-items:center;gap:4px;font-size:11px;padding:2px 8px;font-weight:600;letter-spacing:0.3px}
.plan-badge.free{background:#fff3cd;color:#856404}
.plan-badge.pro{background:#d4edda;color:#155724}
body.dark .upgrade-title{color:#d4d4d4}
body.dark .upgrade-msg{color:#aaa}
body.dark .plan-badge.free{background:#5c4a00;color:#ffe69c}
body.dark .plan-badge.pro{background:#0a3622;color:#75d6a1}
</style>
</head>
<body data-page-id="{{PAGE_ID}}">
<div id="app"></div>

<!-- Modals -->
<div id="search-modal" class="modal-overlay" onclick="if(event.target===this)closeSearch()">
  <div class="modal"><div id="search-content"></div></div>
</div>
<div id="template-modal" class="modal-overlay" onclick="if(event.target===this)closeTemplates()">
  <div class="modal"><div id="template-content"></div></div>
</div>
<div id="share-modal" class="modal-overlay" onclick="if(event.target===this)closeShare()">
  <div class="modal"><div id="share-content"></div></div>
</div>
<div id="record-modal" class="modal-overlay" onclick="if(event.target===this)closeRecordModal()">
  <div class="modal"><div id="record-content"></div></div>
</div>
<div id="upgrade-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeUpgradeModal()">
  <div class="modal"><div id="upgrade-content"></div></div>
</div>
<div id="add-prop-modal" class="modal-overlay" onclick="if(event.target===this)closeAddPropModal()">
  <div class="modal"><div id="add-prop-content"></div></div>
</div>
<div id="edit-prop-modal" class="modal-overlay" onclick="if(event.target===this)closeEditPropModal()">
  <div class="modal"><div id="edit-prop-content"></div></div>
</div>
<div id="add-view-modal" class="modal-overlay" onclick="if(event.target===this)closeAddViewModal()">
  <div class="modal"><div id="add-view-content"></div></div>
</div>
<div id="sort-modal" class="modal-overlay" onclick="if(event.target===this)closeSortModal()">
  <div class="modal" style="max-width:520px"><div id="sort-modal-content"></div></div>
</div>
<div id="columns-modal" class="modal-overlay" onclick="if(event.target===this)closeColumnsModal()">
  <div class="modal" style="max-width:420px"><div id="columns-modal-content"></div></div>
</div>
<div id="slash-menu"></div>
<div id="format-toolbar"></div>
<div id="emoji-picker"></div>
<div id="context-menu"></div>
<div id="toast-container"></div>

<script>
// ============================================================
// CONFIGURATION
// ============================================================
const TAG_COLORS = {
  light_gray:{bg:'#f3f2f1',fg:'#605e5c'},gray:{bg:'#e1dfdd',fg:'#323130'},
  brown:{bg:'#e8dcd2',fg:'#6e4b2d'},orange:{bg:'#fde7d0',fg:'#c45d1a'},
  yellow:{bg:'#fff4ce',fg:'#7a6400'},green:{bg:'#dff6dd',fg:'#107c10'},
  blue:{bg:'#d0e7f5',fg:'#004e8c'},purple:{bg:'#e8daef',fg:'#5c2d91'},
  pink:{bg:'#fce4ec',fg:'#b4009e'},red:{bg:'#fde7e9',fg:'#a80000'}
};

const EMOJIS = ['📄','📝','📋','📌','📎','📁','📂','💡','🎯','🚀','⭐','🔥','💻','🎨','📊','📈','🗂️','📒','📕','📗','📘','📙','🏠','👤','👥','🔧','⚙️','🔍','📅','✅','❌','⚠️','💬','🎉','🏗️','📐','🧪','🔬','🎓','🌍'];

const BLOCK_TYPES = [
  {section:'Basic Blocks',items:[
    {type:'paragraph',name:'Text',desc:'Plain text block',icon:'type'},
    {type:'heading_1',name:'Heading 1',desc:'Large section heading',icon:'heading-1'},
    {type:'heading_2',name:'Heading 2',desc:'Medium section heading',icon:'heading-2'},
    {type:'heading_3',name:'Heading 3',desc:'Small section heading',icon:'heading-3'},
    {type:'bulleted_list',name:'Bulleted List',desc:'Unordered list item',icon:'list'},
    {type:'numbered_list',name:'Numbered List',desc:'Ordered list item',icon:'list-ordered'},
    {type:'to_do',name:'To-do',desc:'Checkbox item',icon:'check-square'},
    {type:'toggle',name:'Toggle',desc:'Collapsible content',icon:'chevron-right'},
    {type:'quote',name:'Quote',desc:'Block quote',icon:'quote'},
    {type:'callout',name:'Callout',desc:'Highlighted block with icon',icon:'alert-circle'},
    {type:'divider',name:'Divider',desc:'Horizontal line separator',icon:'minus'},
    {type:'code',name:'Code',desc:'Code block with syntax',icon:'code'}
  ]},
  {section:'Media',items:[
    {type:'image',name:'Image',desc:'Upload or embed image',icon:'image'},
    {type:'bookmark',name:'Bookmark',desc:'Link preview',icon:'bookmark'}
  ]},
  {section:'Database',items:[
    {type:'database_inline',name:'Table Database',desc:'Inline database table',icon:'table'}
  ]},
  {section:'Advanced',items:[
    {type:'page_link',name:'Page Link',desc:'Link to another page',icon:'file-text'},
  ]}
];

// ============================================================
// UTILITIES
// ============================================================
function uid(){ return crypto.randomUUID(); }
function esc(s){ if(!s)return ''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function toast(msg,type='success'){
  const c=document.getElementById('toast-container');
  const el=document.createElement('div');
  el.className='toast '+type;
  el.textContent=msg;
  c.appendChild(el);
  setTimeout(()=>el.remove(),3000);
}
function relTime(iso){
  if(!iso)return '';
  const d=new Date(iso),n=Date.now(),s=Math.floor((n-d)/1000);
  if(s<60)return 'just now';
  if(s<3600)return Math.floor(s/60)+'m ago';
  if(s<86400)return Math.floor(s/3600)+'h ago';
  return d.toLocaleDateString();
}
function renderIcons(root){
  try{lucide.createIcons({nameAttr:'data-lucide',attrs:{class:'lucide-icon'},root:root||document.body})}catch(e){}
}

// ============================================================
// API MODULE (wraps injected TeamData SDK)
// ============================================================
const api = {
  async list(col, params={}) {
    const opts = {};
    if(params.where) opts.where = params.where;
    if(params.orderBy) opts.orderBy = params.orderBy;
    if(params.order) opts.order = params.order;
    if(params.limit) opts.limit = params.limit;
    if(params.offset) opts.offset = params.offset;
    return TeamData.find(col, opts);
  },
  async get(col, id) { return TeamData.findById(col, id); },
  async create(col, data) { return TeamData.create(col, data); },
  async update(col, id, data) { return TeamData.update(col, id, data); },
  async delete(col, id) { return TeamData.delete(col, id); }
};

// ============================================================
// PLAN LIMITS
// ============================================================
const PLAN = {
  name: 'Free',
  maxTables: 10,
  maxRowsPerTable: 100,
  upgradeUrl: 'https://www.visimade.com/p/team-base-pro/purchase',
  showUpgrade: true,
};

// ============================================================
// STATE
// ============================================================
const S = {
  user: null,
  settings: null,
  settingsId: null,
  pages: [],
  currentPageId: null,
  currentPage: null,
  expandedPages: new Set(),
  favorites: [],
  favMap: {},
  rightPanel: null,
  comments: [],
  dbSchemas: {},
  dbRecords: {},
  dbViews: {},
  currentViewId: null,
  slashBlock: null,
  slashFilter: '',
  slashIdx: 0,
  editingRecordId: null,
  editingDbPageId: null,
  trashView: false,
  loading: true,
};

// ============================================================
// RICH TEXT HELPERS
// ============================================================
function rtToHtml(rt) {
  if(!rt) return '';
  if(typeof rt === 'string') return esc(rt);
  if(!Array.isArray(rt)) return '';
  return rt.map(seg => {
    let h = esc(seg.text || '');
    const a = seg.annotations || {};
    if(a.code) h = '<code style="background:#f3f2f1;padding:1px 4px;font-family:Consolas,monospace;font-size:12px">'+h+'</code>';
    if(a.bold) h = '<strong>'+h+'</strong>';
    if(a.italic) h = '<em>'+h+'</em>';
    if(a.underline) h = '<u>'+h+'</u>';
    if(a.strikethrough) h = '<s>'+h+'</s>';
    if(a.link) h = '<a href="'+esc(a.link)+'">'+h+'</a>';
    if(a.color && a.color!=='default'){
      const c = TAG_COLORS[a.color];
      if(c) h = '<span style="color:'+c.fg+'">'+h+'</span>';
    }
    if(a.background && a.background!=='default'){
      const c = TAG_COLORS[a.background];
      if(c) h = '<span style="background:'+c.bg+';padding:1px 2px">'+h+'</span>';
    }
    return h;
  }).join('');
}

function htmlToRt(html) {
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  const text = tmp.textContent || '';
  if(!text) return [];
  return [{text, annotations:{}}];
}

function rtToText(rt) {
  if(!rt) return '';
  if(typeof rt === 'string') return rt;
  if(!Array.isArray(rt)) return '';
  return rt.map(s => s.text || '').join('');
}

function plainRt(text) {
  return [{text, annotations:{}}];
}

// ============================================================
// SIDEBAR
// ============================================================
function renderSidebar() {
  const sb = document.getElementById('sidebar');
  if(!sb) return;
  const favPages = S.favorites.map(f => S.pages.find(p => p.id === f.data.page_id)).filter(Boolean);
  const rootPages = S.pages.filter(p => !p.data.parent_page_id && !p.data.is_archived && !p.data.is_template);
  rootPages.sort((a,b) => (a.data.sort_order||0) - (b.data.sort_order||0));

  sb.innerHTML = `
    <div class="sidebar-header">
      <span class="sidebar-title" style="font-size:14px;font-weight:600;flex:1">Workspace</span>
      <button onclick="toggleSidebarCollapse()" title="Collapse" style="width:24px;height:24px;display:flex;align-items:center;justify-content:center;color:#605e5c">
        <i data-lucide="panel-left-close" style="width:14px;height:14px"></i>
      </button>
    </div>
    <div class="sidebar-search" onclick="openSearch()">
      <i data-lucide="search"></i>
      <span>Search</span>
      <span style="margin-left:auto;font-size:11px;color:#a19f9d">Ctrl+K</span>
    </div>
    <div style="flex:1;overflow-y:auto;overflow-x:hidden">
      ${favPages.length ? `
        <div class="sidebar-section">
          <div class="sidebar-section-header">Favorites</div>
          ${favPages.map(p => sidebarItem(p, 0)).join('')}
        </div>
      ` : ''}
      <div class="sidebar-section">
        <div class="sidebar-section-header">Pages</div>
        ${rootPages.map(p => sidebarTree(p, 0)).join('')}
        ${rootPages.length === 0 ? '<div style="padding:8px 12px;font-size:12px;color:#a19f9d">No pages yet</div>' : ''}
      </div>
    </div>
    <div class="sidebar-footer">
      <button onclick="createNewPage()"><i data-lucide="plus"></i> New Page</button>
      <button onclick="createNewDatabase()"><i data-lucide="database"></i> New Database</button>
      <button onclick="openTemplates()"><i data-lucide="layout-template"></i> Templates</button>
      <button onclick="showTrash()"><i data-lucide="trash-2"></i> Trash</button>
      ${PLAN.showUpgrade ? `<div style="padding:6px 8px;margin-top:4px;border-top:1px solid #ddd9d7"><a href="${PLAN.upgradeUrl}" target="_blank" style="display:flex;align-items:center;gap:6px;font-size:12px;color:#0078d4;text-decoration:none"><span class="plan-badge free">FREE</span> Upgrade to Pro</a></div>` : `<div style="padding:6px 8px;margin-top:4px;border-top:1px solid #ddd9d7"><span class="plan-badge pro">PRO</span></div>`}
    </div>
    <div class="sidebar-resize" onmousedown="startSidebarResize(event)"></div>
  `;
  renderIcons(sb);
}

function sidebarTree(page, depth) {
  const children = S.pages.filter(p => p.data.parent_page_id === page.id && !p.data.is_archived);
  children.sort((a,b) => (a.data.sort_order||0) - (b.data.sort_order||0));
  const expanded = S.expandedPages.has(page.id);
  let html = sidebarItem(page, depth, children.length > 0);
  if(expanded && children.length > 0) {
    html += '<div class="sidebar-children">' + children.map(c => sidebarTree(c, depth+1)).join('') + '</div>';
  }
  return html;
}

function sidebarItem(page, depth, hasChildren) {
  const d = page.data;
  const isActive = S.currentPageId === page.id;
  const icon = d.icon || (d.page_type === 'database' ? '🗃️' : '📄');
  const isEmoji = /\p{Emoji}/u.test(icon);
  const iconHtml = isEmoji ? `<span class="page-icon">${icon}</span>` : `<span class="page-icon"><i data-lucide="${icon}"></i></span>`;
  return `
    <div class="sidebar-item${isActive?' active':''}" onclick="navigateTo('${page.id}')" style="padding-left:${12+depth*16}px" data-page-id="${page.id}">
      ${hasChildren ? `<span class="expand-btn${S.expandedPages.has(page.id)?' expanded':''}" onclick="event.stopPropagation();toggleExpand('${page.id}')"><i data-lucide="chevron-right" style="width:12px;height:12px"></i></span>` : '<span style="width:18px;flex-shrink:0"></span>'}
      ${iconHtml}
      <span class="page-title">${esc(d.title || 'Untitled')}</span>
      <span class="item-actions">
        <button onclick="event.stopPropagation();createSubPage('${page.id}')" title="Add sub-page"><i data-lucide="plus" style="width:12px;height:12px"></i></button>
        <button onclick="event.stopPropagation();showPageMenu(event,'${page.id}')" title="More"><i data-lucide="more-horizontal" style="width:12px;height:12px"></i></button>
      </span>
    </div>`;
}

function toggleExpand(pageId) {
  if(S.expandedPages.has(pageId)) S.expandedPages.delete(pageId);
  else S.expandedPages.add(pageId);
  renderSidebar();
}

function toggleSidebarCollapse() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

function startSidebarResize(e) {
  e.preventDefault();
  const sb = document.getElementById('sidebar');
  const startX = e.clientX, startW = sb.offsetWidth;
  function onMove(e2) { sb.style.width = Math.max(200, Math.min(400, startW + e2.clientX - startX)) + 'px'; }
  function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); }
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
}

function showPageMenu(e, pageId) {
  const menu = document.getElementById('context-menu');
  const page = S.pages.find(p => p.id === pageId);
  if(!page) return;
  const isFav = S.favMap[pageId];
  menu.innerHTML = `
    <div class="ctx-item" onclick="duplicatePage('${pageId}')"><i data-lucide="copy"></i> Duplicate</div>
    <div class="ctx-item" onclick="${isFav ? `removeFavorite('${pageId}')` : `addFavorite('${pageId}')`}"><i data-lucide="${isFav?'star-off':'star'}"></i> ${isFav?'Remove from favorites':'Add to favorites'}</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item danger" onclick="archivePage('${pageId}')"><i data-lucide="trash-2"></i> Move to Trash</div>
  `;
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('visible');
  renderIcons(menu);
  setTimeout(() => {
    const close = (ev) => { if(!menu.contains(ev.target)){ menu.classList.remove('visible'); document.removeEventListener('click', close); }};
    document.addEventListener('click', close);
  }, 10);
}
// ============================================================
// TOPBAR
// ============================================================
function renderTopbar() {
  const tb = document.getElementById('topbar');
  if(!tb || !S.currentPage) return;
  const d = S.currentPage.data;
  const breadcrumbs = getBreadcrumbs(S.currentPageId);
  const isFav = S.favMap[S.currentPageId];
  const commentCount = S.comments.filter(c => !c.data.is_resolved && !c.data.parent_comment_id).length;

  tb.innerHTML = `
    <div class="topbar-left">
      <button onclick="toggleSidebarCollapse()" class="topbar-btn" title="Toggle sidebar" style="display:none" id="sidebar-toggle-btn">
        <i data-lucide="panel-left-open"></i>
      </button>
      <div class="topbar-breadcrumb">
        ${breadcrumbs.map((b,i) => `<span onclick="navigateTo('${b.id}')">${esc(b.title||'Untitled')}</span>${i<breadcrumbs.length-1?'<span class="sep">/</span>':''}`).join('')}
      </div>
      ${d.last_edited_by_username ? `<span class="edited-indicator">Edited by ${esc(d.last_edited_by_username)} ${relTime(S.currentPage.updatedAt)}</span>` : ''}
    </div>
    <div class="topbar-right">
      <button class="topbar-text-btn" onclick="openShare()"><i data-lucide="share-2"></i> Share</button>
      <button class="topbar-btn${S.rightPanel==='comments'?' active':''}" onclick="togglePanel('comments')" title="Comments">
        <i data-lucide="message-square"></i>
        ${commentCount > 0 ? `<span class="badge">${commentCount}</span>` : ''}
      </button>
      <button class="topbar-btn${S.rightPanel==='history'?' active':''}" onclick="togglePanel('history')" title="History">
        <i data-lucide="clock"></i>
      </button>
      <button class="topbar-btn${isFav?' active':''}" onclick="${isFav?`removeFavorite('${S.currentPageId}')`:`addFavorite('${S.currentPageId}')`}" title="${isFav?'Remove from favorites':'Add to favorites'}">
        <i data-lucide="${isFav?'star':'star'}"></i>
      </button>
      <button class="topbar-btn" onclick="showMoreMenu(event)" title="More">
        <i data-lucide="more-horizontal"></i>
      </button>
    </div>
  `;
  renderIcons(tb);
  // Show sidebar toggle if sidebar is collapsed
  const sbc = document.getElementById('sidebar');
  const stb = document.getElementById('sidebar-toggle-btn');
  if(sbc && stb && sbc.classList.contains('collapsed')) stb.style.display = 'flex';
}

function getBreadcrumbs(pageId) {
  const result = [];
  let current = S.pages.find(p => p.id === pageId);
  while(current) {
    result.unshift({id: current.id, title: current.data.title});
    if(current.data.parent_page_id) {
      current = S.pages.find(p => p.id === current.data.parent_page_id);
    } else {
      break;
    }
  }
  return result;
}

function showMoreMenu(e) {
  if(!S.currentPage) return;
  const d = S.currentPage.data;
  const menu = document.getElementById('context-menu');
  menu.innerHTML = `
    <div class="ctx-item" onclick="togglePageProp('is_locked')"><i data-lucide="${d.is_locked?'unlock':'lock'}"></i> ${d.is_locked?'Unlock page':'Lock page'}</div>
    <div class="ctx-item" onclick="togglePageProp('full_width')"><i data-lucide="${d.full_width?'minimize-2':'maximize-2'}"></i> ${d.full_width?'Default width':'Full width'}</div>
    <div class="ctx-item" onclick="togglePageProp('small_text')"><i data-lucide="type"></i> ${d.small_text?'Normal text':'Small text'}</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item" onclick="setPageFont('sans')"><i data-lucide="type"></i> Sans-serif${d.font==='sans'||!d.font?' ✓':''}</div>
    <div class="ctx-item" onclick="setPageFont('serif')"><i data-lucide="type"></i> Serif${d.font==='serif'?' ✓':''}</div>
    <div class="ctx-item" onclick="setPageFont('mono')"><i data-lucide="type"></i> Monospace${d.font==='mono'?' ✓':''}</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item" onclick="setTheme('dark')"><i data-lucide="moon"></i> Dark theme${document.body.classList.contains('dark')?' ✓':''}</div>
    <div class="ctx-item" onclick="setTheme('light')"><i data-lucide="sun"></i> Light theme${!document.body.classList.contains('dark')?' ✓':''}</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item" onclick="duplicatePage('${S.currentPageId}')"><i data-lucide="copy"></i> Duplicate</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item danger" onclick="archivePage('${S.currentPageId}')"><i data-lucide="trash-2"></i> Move to Trash</div>
  `;
  menu.style.left = (e.clientX - 160) + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('visible');
  renderIcons(menu);
  setTimeout(() => {
    const close = (ev) => { if(!menu.contains(ev.target)){ menu.classList.remove('visible'); document.removeEventListener('click', close); }};
    document.addEventListener('click', close);
  }, 10);
}

async function togglePageProp(prop) {
  if(!S.currentPage) return;
  closeContextMenu();
  const newVal = !S.currentPage.data[prop];
  S.currentPage.data[prop] = newVal;
  await api.update('pages', S.currentPageId, {[prop]: newVal});
  renderPage();
  renderTopbar();
}

async function setPageFont(font) {
  if(!S.currentPage) return;
  closeContextMenu();
  S.currentPage.data.font = font;
  await api.update('pages', S.currentPageId, {font});
  renderPage();
}

function setTheme(theme) {
  closeContextMenu();
  if(theme === 'dark') {
    document.body.classList.add('dark');
  } else {
    document.body.classList.remove('dark');
  }
  localStorage.setItem('wiki_theme', theme);
}

// Apply saved theme on load
(function() {
  const saved = localStorage.getItem('wiki_theme');
  if(saved === 'dark') document.body.classList.add('dark');
})();

function closeContextMenu() {
  document.getElementById('context-menu').classList.remove('visible');
}
// ============================================================
// PAGE RENDERING & BLOCK EDITOR
// ============================================================
function renderPage() {
  const area = document.getElementById('page-area');
  if(!area) return;

  if(S.trashView) { renderTrashView(area); return; }
  if(!S.currentPage) {
    area.innerHTML = '<div class="empty-state"><i data-lucide="file-text" style="width:48px;height:48px"></i><p>Select a page or create a new one</p></div>';
    renderIcons(area);
    return;
  }

  const d = S.currentPage.data;
  const fontClass = d.font === 'serif' ? 'font-serif' : d.font === 'mono' ? 'font-mono' : '';
  const wClass = d.full_width ? 'full-width' : '';
  const sClass = d.small_text ? 'small-text' : '';
  const icon = d.icon || (d.page_type === 'database' ? '🗃️' : '📄');

  let html = '';
  if(d.cover_image_url) {
    html += `<div class="page-cover" style="background-image:url('${esc(d.cover_image_url)}');background-position-y:${d.cover_position_y||50}%">
      <div class="cover-actions"><button onclick="changeCover()">Change cover</button><button onclick="removeCover()">Remove</button></div></div>`;
  }
  html += `<div class="page-header ${wClass}">`;
  html += `<div class="page-icon-btn" onclick="showEmojiPicker(event,'page-icon')" title="Change icon">${icon}</div>`;
  if(!d.cover_image_url) html += `<button class="btn-ghost" onclick="addCover()" style="font-size:11px;color:#a19f9d;margin-bottom:8px"><i data-lucide="image" style="width:12px;height:12px"></i> Add cover</button>`;
  html += `<textarea class="page-title-input" placeholder="Untitled" oninput="autoResizeTitle(this);debouncedSaveTitle(this.value)" rows="1">${esc(d.title||'')}</textarea>`;
  html += `</div>`;

  if(d.page_type === 'database') {
    html += `<div class="page-content ${wClass} ${fontClass} ${sClass}" id="db-content"></div>`;
  } else {
    const blocks = d.content_blocks || [];
    html += `<div class="page-content ${wClass} ${fontClass} ${sClass}" id="blocks-container">`;
    if(blocks.length === 0) {
      html += renderBlock({id:uid(),type:'paragraph',content:[],properties:{},children:[],indent_level:0}, 0);
    } else {
      blocks.forEach((b,i) => { html += renderBlock(b, i); });
    }
    html += `</div>`;
  }
  area.innerHTML = html;
  area.scrollTop = 0;

  // Auto-resize title
  const titleEl = area.querySelector('.page-title-input');
  if(titleEl) autoResizeTitle(titleEl);

  if(d.page_type === 'database') {
    renderDatabasePage();
  } else {
    initBlockEditing();
  }
  renderIcons(area);
}

function autoResizeTitle(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}

const debouncedSaveTitle = debounce(async (title) => {
  if(!S.currentPage) return;
  S.currentPage.data.title = title;
  S.currentPage.data.last_edited_by_user_id = S.user?.id;
  S.currentPage.data.last_edited_by_username = S.user?.username;
  await api.update('pages', S.currentPageId, {title, last_edited_by_user_id:S.user?.id, last_edited_by_username:S.user?.username});
  renderSidebar();
  renderTopbar();
}, 500);

function renderBlock(block, index) {
  const b = block;
  const type = b.type || 'paragraph';
  const indent = b.indent_level || 0;
  const content = rtToHtml(b.content);
  const contentText = rtToText(b.content);

  let inner = '';
  switch(type) {
    case 'paragraph':
      inner = `<div class="block-content" contenteditable="true" data-placeholder="Type '/' for commands" data-block-id="${b.id}">${content}</div>`;
      break;
    case 'heading_1':
      inner = `<div class="block-content" contenteditable="true" data-placeholder="Heading 1" data-block-id="${b.id}">${content}</div>`;
      break;
    case 'heading_2':
      inner = `<div class="block-content" contenteditable="true" data-placeholder="Heading 2" data-block-id="${b.id}">${content}</div>`;
      break;
    case 'heading_3':
      inner = `<div class="block-content" contenteditable="true" data-placeholder="Heading 3" data-block-id="${b.id}">${content}</div>`;
      break;
    case 'bulleted_list':
      inner = `<div class="block-bulleted"><div class="block-content" contenteditable="true" data-placeholder="List item" data-block-id="${b.id}" style="flex:1">${content}</div></div>`;
      break;
    case 'numbered_list':
      inner = `<div class="block-numbered"><span class="num">${index+1}.</span><div class="block-content" contenteditable="true" data-placeholder="List item" data-block-id="${b.id}" style="flex:1">${content}</div></div>`;
      break;
    case 'to_do':
      const checked = b.properties?.checked;
      inner = `<div class="block-todo${checked?' checked':''}">
        <input type="checkbox" ${checked?'checked':''} onchange="toggleTodo('${b.id}',this.checked)">
        <div class="block-content" contenteditable="true" data-placeholder="To-do" data-block-id="${b.id}" style="flex:1">${content}</div></div>`;
      break;
    case 'toggle':
      const open = b.properties?.open;
      inner = `<div class="block-toggle">
        <div class="block-toggle-header">
          <span class="block-toggle-arrow${open?' open':''}" onclick="toggleToggle('${b.id}')"><i data-lucide="chevron-right" style="width:14px;height:14px"></i></span>
          <div class="block-content" contenteditable="true" data-placeholder="Toggle heading" data-block-id="${b.id}" style="flex:1">${content}</div>
        </div>
        <div class="block-toggle-children${open?' open':''}">
          ${(b.children||[]).map((c,ci) => renderBlock(c,ci)).join('')}
          ${(b.children||[]).length===0?'<div style="padding:4px 0;color:#a19f9d;font-size:12px;cursor:pointer" onclick="addToggleChild(\''+b.id+'\')">Empty toggle. Click to add content.</div>':''}
        </div></div>`;
      break;
    case 'quote':
      inner = `<div class="block-quote"><div class="block-content" contenteditable="true" data-placeholder="Quote" data-block-id="${b.id}">${content}</div></div>`;
      break;
    case 'callout':
      const calloutColor = b.properties?.color || 'gray';
      const calloutIcon = b.properties?.icon || '💡';
      inner = `<div class="block-callout ${calloutColor}">
        <span class="block-callout-icon" onclick="showEmojiPicker(event,'callout-${b.id}')">${calloutIcon}</span>
        <div class="block-content" contenteditable="true" data-placeholder="Callout text" data-block-id="${b.id}" style="flex:1">${content}</div></div>`;
      break;
    case 'divider':
      inner = '<hr class="block-divider">';
      break;
    case 'code':
      const lang = b.properties?.language || '';
      inner = `${lang?`<div class="block-code-lang">${esc(lang)}</div>`:''}
        <pre class="block-code" contenteditable="true" data-block-id="${b.id}" data-placeholder="Code">${esc(typeof b.content==='string'?b.content:contentText)}</pre>`;
      break;
    case 'image':
      const url = b.properties?.url || '';
      const caption = b.properties?.caption || '';
      inner = `<div class="block-image">${url?`<img src="${esc(url)}" alt="${esc(caption)}">`:'<div style="padding:20px;background:#f3f2f1;text-align:center;color:#a19f9d;cursor:pointer" onclick="promptImageUrl(\''+b.id+'\')">Click to add image URL</div>'}
        ${caption?`<div class="caption">${esc(caption)}</div>`:''}</div>`;
      break;
    case 'bookmark':
      inner = `<div class="block-bookmark">
        <div class="block-bookmark-info">
          <div class="block-bookmark-title">${esc(b.properties?.title||'')}</div>
          <div class="block-bookmark-desc">${esc(b.properties?.description||'')}</div>
          <div class="block-bookmark-url">${esc(b.properties?.url||'')}</div>
        </div></div>`;
      break;
    case 'page_link':
      const linkedPage = S.pages.find(p => p.id === b.properties?.linked_page_id);
      inner = `<div class="block-page-link" onclick="navigateTo('${b.properties?.linked_page_id||''}')">
        <i data-lucide="file-text"></i>
        <span>${esc(linkedPage?.data?.title || 'Untitled')}</span></div>`;
      break;
    case 'database_inline':
      inner = `<div data-db-inline="${b.properties?.database_page_id||''}" style="margin:8px 0">Loading database...</div>`;
      break;
    default:
      inner = `<div class="block-content" contenteditable="true" data-block-id="${b.id}">${content}</div>`;
  }

  return `<div class="block block-${type.replace(/_/g,'')}" data-block-id="${b.id}" data-type="${type}" data-indent="${indent}">
    <span class="block-handle" draggable="true" ondragstart="dragBlock(event,'${b.id}')" title="Drag to reorder"><i data-lucide="grip-vertical" style="width:12px;height:12px"></i></span>
    ${type!=='divider'?`<span class="block-add" onclick="showSlashMenu(event,'${b.id}')" title="Add block below">+</span>`:''}
    ${inner}
  </div>`;
}

function initBlockEditing() {
  const container = document.getElementById('blocks-container');
  if(!container) return;

  container.addEventListener('keydown', handleBlockKeydown);
  container.addEventListener('input', handleBlockInput);
  container.addEventListener('mouseup', handleTextSelection);

  // Focus first empty block
  const firstBlock = container.querySelector('.block-content[contenteditable]');
  if(firstBlock && !firstBlock.textContent.trim()) {
    setTimeout(() => firstBlock.focus(), 100);
  }
}

function handleBlockKeydown(e) {
  const el = e.target;
  if(!el.matches('[contenteditable]') || !el.dataset.blockId) return;
  const blockId = el.dataset.blockId;

  if(e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    closeSlashMenu();
    insertBlockAfter(blockId, 'paragraph');
  }
  else if(e.key === 'Backspace' && getBlockText(el) === '' && !e.shiftKey) {
    e.preventDefault();
    deleteBlock(blockId);
  }
  else if(e.key === 'Tab') {
    e.preventDefault();
    if(e.shiftKey) outdentBlock(blockId);
    else indentBlock(blockId);
  }
  else if(e.key === '/' && getBlockText(el) === '') {
    // Will be handled by input event
  }
  else if(e.key === 'ArrowUp' && isAtStart(el)) {
    e.preventDefault();
    focusPrevBlock(blockId);
  }
  else if(e.key === 'ArrowDown' && isAtEnd(el)) {
    e.preventDefault();
    focusNextBlock(blockId);
  }
  else if(e.key === 'Escape') {
    closeSlashMenu();
    closeFormatToolbar();
  }
  // Format shortcuts
  else if((e.ctrlKey || e.metaKey) && !e.shiftKey) {
    if(e.key === 'b') { e.preventDefault(); document.execCommand('bold'); }
    else if(e.key === 'i') { e.preventDefault(); document.execCommand('italic'); }
    else if(e.key === 'u') { e.preventDefault(); document.execCommand('underline'); }
    else if(e.key === 'e') { e.preventDefault(); wrapInlineCode(); }
    else if(e.key === 'd') { e.preventDefault(); duplicateBlock(blockId); }
    else if(e.key === 'z') { /* Let browser handle undo */ }
  }
  else if((e.ctrlKey || e.metaKey) && e.shiftKey) {
    if(e.key === 'S' || e.key === 's') { e.preventDefault(); document.execCommand('strikeThrough'); }
    const numMap = {'1':'heading_1','2':'heading_2','3':'heading_3','4':'to_do','5':'bulleted_list','6':'numbered_list','7':'toggle','8':'code'};
    if(numMap[e.key]) { e.preventDefault(); convertBlock(blockId, numMap[e.key]); }
  }
}

function handleBlockInput(e) {
  const el = e.target;
  if(!el.matches('[contenteditable]') || !el.dataset.blockId) return;
  const text = el.textContent || '';
  const blockId = el.dataset.blockId;

  // Slash command detection
  if(text === '/') {
    S.slashBlock = blockId;
    S.slashFilter = '';
    S.slashIdx = 0;
    showSlashMenuAt(el);
    return;
  }
  if(text.startsWith('/') && S.slashBlock === blockId) {
    S.slashFilter = text.substring(1).toLowerCase();
    S.slashIdx = 0;
    updateSlashMenu();
    return;
  }
  if(S.slashBlock === blockId && !text.startsWith('/')) {
    closeSlashMenu();
  }

  debouncedSaveBlocks();
}

function handleTextSelection(e) {
  const sel = window.getSelection();
  if(!sel || sel.isCollapsed || !sel.toString().trim()) {
    closeFormatToolbar();
    return;
  }
  const el = sel.anchorNode?.parentElement?.closest('[contenteditable]');
  if(!el || !el.dataset.blockId) { closeFormatToolbar(); return; }
  showFormatToolbar(sel);
}

function getBlockText(el) {
  return el.textContent || '';
}

function isAtStart(el) {
  const sel = window.getSelection();
  return sel && sel.anchorOffset === 0;
}

function isAtEnd(el) {
  const sel = window.getSelection();
  if(!sel) return false;
  return sel.anchorOffset >= (sel.anchorNode?.textContent?.length || 0);
}

function focusPrevBlock(currentId) {
  const blocks = Array.from(document.querySelectorAll('#blocks-container [contenteditable][data-block-id]'));
  const idx = blocks.findIndex(b => b.dataset.blockId === currentId);
  if(idx > 0) { blocks[idx-1].focus(); placeCaretEnd(blocks[idx-1]); }
}

function focusNextBlock(currentId) {
  const blocks = Array.from(document.querySelectorAll('#blocks-container [contenteditable][data-block-id]'));
  const idx = blocks.findIndex(b => b.dataset.blockId === currentId);
  if(idx < blocks.length-1) { blocks[idx+1].focus(); placeCaretStart(blocks[idx+1]); }
}

function placeCaretEnd(el) {
  const r = document.createRange(), s = window.getSelection();
  r.selectNodeContents(el); r.collapse(false);
  s.removeAllRanges(); s.addRange(r);
}

function placeCaretStart(el) {
  const r = document.createRange(), s = window.getSelection();
  r.selectNodeContents(el); r.collapse(true);
  s.removeAllRanges(); s.addRange(r);
}

function insertBlockAfter(afterId, type, content) {
  if(!S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const idx = blocks.findIndex(b => b.id === afterId);
  const afterBlock = blocks[idx];
  const indent = afterBlock ? afterBlock.indent_level || 0 : 0;
  // Inherit list type
  let newType = type;
  if(type === 'paragraph' && afterBlock && ['bulleted_list','numbered_list','to_do'].includes(afterBlock.type)) {
    newType = afterBlock.type;
  }
  const newBlock = {id:uid(),type:newType,content:content||[],properties:{},children:[],indent_level:indent};
  blocks.splice(idx+1, 0, newBlock);
  S.currentPage.data.content_blocks = blocks;

  // Re-render and focus
  const container = document.getElementById('blocks-container');
  if(!container) return;
  const blockEl = container.querySelector(`[data-block-id="${afterId}"]`)?.closest('.block');
  const newHtml = renderBlock(newBlock, idx+1);
  if(blockEl) {
    blockEl.insertAdjacentHTML('afterend', newHtml);
  } else {
    container.insertAdjacentHTML('beforeend', newHtml);
  }
  renderIcons(container);
  setTimeout(() => {
    const newEl = container.querySelector(`[data-block-id="${newBlock.id}"][contenteditable]`);
    if(newEl) { newEl.focus(); placeCaretStart(newEl); }
  }, 20);
  debouncedSaveBlocks();
}

function deleteBlock(blockId) {
  if(!S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const idx = blocks.findIndex(b => b.id === blockId);
  if(idx < 0) return;
  if(blocks.length <= 1) return; // Keep at least one block

  blocks.splice(idx, 1);
  S.currentPage.data.content_blocks = blocks;

  const blockEl = document.querySelector(`#blocks-container .block[data-block-id="${blockId}"]`);
  if(blockEl) blockEl.remove();

  // Focus previous block
  if(idx > 0) {
    const prevBlock = blocks[idx-1];
    const prevEl = document.querySelector(`[data-block-id="${prevBlock.id}"][contenteditable]`);
    if(prevEl) { prevEl.focus(); placeCaretEnd(prevEl); }
  }
  debouncedSaveBlocks();
}

function indentBlock(blockId) {
  if(!S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const block = blocks.find(b => b.id === blockId);
  if(!block || (block.indent_level||0) >= 5) return;
  block.indent_level = (block.indent_level||0) + 1;
  const el = document.querySelector(`#blocks-container .block[data-block-id="${blockId}"]`);
  if(el) el.dataset.indent = block.indent_level;
  debouncedSaveBlocks();
}

function outdentBlock(blockId) {
  if(!S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const block = blocks.find(b => b.id === blockId);
  if(!block || (block.indent_level||0) <= 0) return;
  block.indent_level = (block.indent_level||0) - 1;
  const el = document.querySelector(`#blocks-container .block[data-block-id="${blockId}"]`);
  if(el) el.dataset.indent = block.indent_level;
  debouncedSaveBlocks();
}

function convertBlock(blockId, newType) {
  if(!S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const block = blocks.find(b => b.id === blockId);
  if(!block) return;
  block.type = newType;
  if(newType === 'to_do') block.properties = {...block.properties, checked: false};
  if(newType === 'toggle') block.properties = {...block.properties, open: true};
  if(newType === 'callout') block.properties = {...block.properties, icon: '💡', color: 'gray'};
  if(newType === 'code' && Array.isArray(block.content)) block.content = rtToText(block.content);
  if(newType !== 'code' && typeof block.content === 'string') block.content = plainRt(block.content);

  // Re-render this block
  const blockEl = document.querySelector(`#blocks-container .block[data-block-id="${blockId}"]`);
  if(blockEl) {
    const idx = blocks.indexOf(block);
    blockEl.outerHTML = renderBlock(block, idx);
    renderIcons(document.getElementById('blocks-container'));
    setTimeout(() => {
      const newEl = document.querySelector(`[data-block-id="${blockId}"][contenteditable]`);
      if(newEl) { newEl.focus(); placeCaretEnd(newEl); }
    }, 20);
  }
  debouncedSaveBlocks();
}

function duplicateBlock(blockId) {
  if(!S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const block = blocks.find(b => b.id === blockId);
  if(!block) return;
  const clone = JSON.parse(JSON.stringify(block));
  clone.id = uid();
  const idx = blocks.indexOf(block);
  blocks.splice(idx+1, 0, clone);
  S.currentPage.data.content_blocks = blocks;
  renderPage();
  debouncedSaveBlocks();
}

function toggleTodo(blockId, checked) {
  if(!S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const block = blocks.find(b => b.id === blockId);
  if(!block) return;
  block.properties = {...block.properties, checked};
  const todoEl = document.querySelector(`#blocks-container .block[data-block-id="${blockId}"] .block-todo`);
  if(todoEl) { if(checked) todoEl.classList.add('checked'); else todoEl.classList.remove('checked'); }
  debouncedSaveBlocks();
}

function toggleToggle(blockId) {
  if(!S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const block = blocks.find(b => b.id === blockId);
  if(!block) return;
  block.properties = {...block.properties, open: !block.properties?.open};
  const arrow = document.querySelector(`#blocks-container .block[data-block-id="${blockId}"] .block-toggle-arrow`);
  const children = document.querySelector(`#blocks-container .block[data-block-id="${blockId}"] .block-toggle-children`);
  if(arrow) arrow.classList.toggle('open');
  if(children) children.classList.toggle('open');
  debouncedSaveBlocks();
}

function addToggleChild(blockId) {
  if(!S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const block = blocks.find(b => b.id === blockId);
  if(!block) return;
  if(!block.children) block.children = [];
  const child = {id:uid(),type:'paragraph',content:[],properties:{},children:[],indent_level:0};
  block.children.push(child);
  block.properties = {...block.properties, open: true};
  renderPage();
  debouncedSaveBlocks();
}

function promptImageUrl(blockId) {
  const url = prompt('Enter image URL:');
  if(!url) return;
  if(!S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const block = blocks.find(b => b.id === blockId);
  if(!block) return;
  block.properties = {...block.properties, url};
  renderPage();
  debouncedSaveBlocks();
}

function dragBlock(e, blockId) {
  e.dataTransfer.setData('text/plain', blockId);
  e.dataTransfer.effectAllowed = 'move';
}

function wrapInlineCode() {
  document.execCommand('insertHTML', false, '<code style="background:#f3f2f1;padding:1px 4px;font-family:Consolas,monospace;font-size:12px">' + window.getSelection().toString() + '</code>');
}

const debouncedSaveBlocks = debounce(async () => {
  if(!S.currentPage) return;
  // Collect content from DOM
  const container = document.getElementById('blocks-container');
  if(!container) return;
  const blocks = S.currentPage.data.content_blocks || [];
  container.querySelectorAll('[contenteditable][data-block-id]').forEach(el => {
    const block = blocks.find(b => b.id === el.dataset.blockId);
    if(block) {
      if(block.type === 'code') {
        block.content = el.textContent || '';
      } else {
        block.content = htmlToRt(el.innerHTML);
      }
    }
  });
  S.currentPage.data.last_edited_by_user_id = S.user?.id;
  S.currentPage.data.last_edited_by_username = S.user?.username;
  await api.update('pages', S.currentPageId, {
    content_blocks: blocks,
    last_edited_by_user_id: S.user?.id,
    last_edited_by_username: S.user?.username
  });
}, 800);

// ============================================================
// SLASH MENU
// ============================================================
function showSlashMenu(e, afterBlockId) {
  S.slashBlock = afterBlockId;
  S.slashFilter = '';
  S.slashIdx = 0;
  const rect = e.target.getBoundingClientRect();
  const menu = document.getElementById('slash-menu');
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 4) + 'px';
  updateSlashMenu();
  menu.classList.add('visible');
}

function showSlashMenuAt(el) {
  const rect = el.getBoundingClientRect();
  const menu = document.getElementById('slash-menu');
  menu.style.left = rect.left + 'px';
  menu.style.top = (rect.bottom + 4) + 'px';
  updateSlashMenu();
  menu.classList.add('visible');
}

function updateSlashMenu() {
  const menu = document.getElementById('slash-menu');
  const filter = S.slashFilter.toLowerCase();
  let html = '';
  let itemIdx = 0;
  BLOCK_TYPES.forEach(section => {
    const items = section.items.filter(i => !filter || i.name.toLowerCase().includes(filter) || i.type.includes(filter));
    if(items.length === 0) return;
    html += `<div class="slash-menu-section"><div class="slash-menu-section-title">${section.section}</div>`;
    items.forEach(item => {
      html += `<div class="slash-menu-item${itemIdx===S.slashIdx?' selected':''}" onclick="selectSlashItem('${item.type}')" onmouseenter="S.slashIdx=${itemIdx};updateSlashMenu()">
        <div class="slash-menu-item-icon"><i data-lucide="${item.icon}"></i></div>
        <div class="slash-menu-item-info"><div class="slash-menu-item-name">${item.name}</div><div class="slash-menu-item-desc">${item.desc}</div></div>
      </div>`;
      itemIdx++;
    });
    html += '</div>';
  });
  if(!html) html = '<div style="padding:16px;text-align:center;color:#a19f9d">No results</div>';
  menu.innerHTML = html;
  renderIcons(menu);

  // Keyboard nav for slash menu
  document.onkeydown = (e) => {
    if(!menu.classList.contains('visible')) return;
    if(e.key === 'ArrowDown') { e.preventDefault(); S.slashIdx++; updateSlashMenu(); }
    else if(e.key === 'ArrowUp') { e.preventDefault(); S.slashIdx = Math.max(0, S.slashIdx-1); updateSlashMenu(); }
    else if(e.key === 'Enter') {
      e.preventDefault();
      const allItems = BLOCK_TYPES.flatMap(s => s.items).filter(i => !S.slashFilter || i.name.toLowerCase().includes(S.slashFilter) || i.type.includes(S.slashFilter));
      if(allItems[S.slashIdx]) selectSlashItem(allItems[S.slashIdx].type);
    }
    else if(e.key === 'Escape') { closeSlashMenu(); }
  };
}

function selectSlashItem(type) {
  closeSlashMenu();
  if(!S.slashBlock || !S.currentPage) return;
  const blocks = S.currentPage.data.content_blocks || [];
  const block = blocks.find(b => b.id === S.slashBlock);
  if(block && getBlockText(document.querySelector(`[data-block-id="${S.slashBlock}"][contenteditable]`) || document.createElement('div')).startsWith('/')) {
    // Convert existing block
    convertBlock(S.slashBlock, type);
    const el = document.querySelector(`[data-block-id="${S.slashBlock}"][contenteditable]`);
    if(el) { el.textContent = ''; el.focus(); }
  } else {
    insertBlockAfter(S.slashBlock, type);
  }
  debouncedSaveBlocks();
}

function closeSlashMenu() {
  document.getElementById('slash-menu').classList.remove('visible');
  S.slashBlock = null;
  document.onkeydown = null;
}

// ============================================================
// FORMAT TOOLBAR
// ============================================================
function showFormatToolbar(sel) {
  const range = sel.getRangeAt(0);
  const rect = range.getBoundingClientRect();
  const tb = document.getElementById('format-toolbar');
  tb.innerHTML = `
    <button class="fmt-btn" onclick="document.execCommand('bold')" title="Bold (Ctrl+B)"><i data-lucide="bold"></i></button>
    <button class="fmt-btn" onclick="document.execCommand('italic')" title="Italic (Ctrl+I)"><i data-lucide="italic"></i></button>
    <button class="fmt-btn" onclick="document.execCommand('underline')" title="Underline (Ctrl+U)"><i data-lucide="underline"></i></button>
    <button class="fmt-btn" onclick="document.execCommand('strikeThrough')" title="Strikethrough"><i data-lucide="strikethrough"></i></button>
    <span class="fmt-sep"></span>
    <button class="fmt-btn" onclick="wrapInlineCode()" title="Code (Ctrl+E)"><i data-lucide="code"></i></button>
    <button class="fmt-btn" onclick="promptLink()" title="Link"><i data-lucide="link"></i></button>
  `;
  tb.style.left = Math.max(8, rect.left + rect.width/2 - 120) + 'px';
  tb.style.top = (rect.top - 40) + 'px';
  tb.classList.add('visible');
  renderIcons(tb);
}

function closeFormatToolbar() {
  document.getElementById('format-toolbar').classList.remove('visible');
}

function promptLink() {
  const url = prompt('Enter URL:');
  if(url) document.execCommand('createLink', false, url);
  closeFormatToolbar();
}

// ============================================================
// EMOJI PICKER
// ============================================================
function showEmojiPicker(e, target) {
  e.stopPropagation();
  const picker = document.getElementById('emoji-picker');
  picker.innerHTML = '<div class="emoji-grid">' + EMOJIS.map(em => `<button class="emoji-btn" onclick="selectEmoji('${em}','${target}')">${em}</button>`).join('') + '</div>';
  picker.style.left = e.clientX + 'px';
  picker.style.top = e.clientY + 'px';
  picker.classList.add('visible');
  setTimeout(() => {
    const close = (ev) => { if(!picker.contains(ev.target)){ picker.classList.remove('visible'); document.removeEventListener('click', close); }};
    document.addEventListener('click', close);
  }, 10);
}

async function selectEmoji(emoji, target) {
  document.getElementById('emoji-picker').classList.remove('visible');
  if(target === 'page-icon' && S.currentPage) {
    S.currentPage.data.icon = emoji;
    await api.update('pages', S.currentPageId, {icon: emoji});
    renderPage();
    renderSidebar();
  } else if(target.startsWith('callout-')) {
    const blockId = target.replace('callout-','');
    const blocks = S.currentPage?.data.content_blocks || [];
    const block = blocks.find(b => b.id === blockId);
    if(block) { block.properties = {...block.properties, icon: emoji}; renderPage(); debouncedSaveBlocks(); }
  }
}
// ============================================================
// DATABASE VIEWS
// ============================================================
async function renderDatabasePage() {
  const dbContent = document.getElementById('db-content');
  if(!dbContent || !S.currentPage) return;
  const pageId = S.currentPageId;

  // Load schema, records, views
  try {
    const [schemaRes, recordsRes, viewsRes] = await Promise.all([
      api.list('database_schemas', {where:{page_id:pageId}}),
      api.list('database_records', {where:{database_page_id:pageId}, limit:100}),
      api.list('database_views', {where:{database_page_id:pageId}})
    ]);
    S.dbSchemas[pageId] = schemaRes.records?.[0] || null;
    S.dbRecords[pageId] = recordsRes.records || [];
    S.dbViews[pageId] = viewsRes.records || [];
  } catch(e) {
    S.dbSchemas[pageId] = null;
    S.dbRecords[pageId] = [];
    S.dbViews[pageId] = [];
  }

  // If no schema, create default
  if(!S.dbSchemas[pageId]) {
    const titlePropId = uid(), statusPropId = uid();
    const schema = {
      page_id: pageId,
      properties: [
        {id:titlePropId, name:'Name', type:'title', options:{}, sort_order:0, visible:true, width:250},
        {id:statusPropId, name:'Status', type:'select', options:{choices:[
          {id:uid(),name:'Not Started',color:'light_gray'},
          {id:uid(),name:'In Progress',color:'blue'},
          {id:uid(),name:'Done',color:'green'}
        ]}, sort_order:1, visible:true, width:150},
        {id:uid(), name:'Priority', type:'select', options:{choices:[
          {id:uid(),name:'Low',color:'gray'},
          {id:uid(),name:'Medium',color:'yellow'},
          {id:uid(),name:'High',color:'orange'},
          {id:uid(),name:'Urgent',color:'red'}
        ]}, sort_order:2, visible:true, width:120},
        {id:uid(), name:'Due Date', type:'date', options:{include_time:false}, sort_order:3, visible:true, width:140},
        {id:uid(), name:'Notes', type:'text', options:{}, sort_order:4, visible:true, width:200}
      ],
      title_property_id: titlePropId
    };
    const created = await api.create('database_schemas', schema);
    S.dbSchemas[pageId] = created;

    // Create default table view
    const viewRec = await api.create('database_views', {
      database_page_id:pageId, name:'Table', view_type:'table',
      filter_rules:[], sort_rules:[], visible_property_ids:schema.properties.map(p=>p.id),
      is_default:true, sort_order:0
    });
    S.dbViews[pageId] = [viewRec];

    // Create board view
    const boardView = await api.create('database_views', {
      database_page_id:pageId, name:'Board', view_type:'board',
      filter_rules:[], sort_rules:[], group_by_property_id:statusPropId,
      visible_property_ids:schema.properties.map(p=>p.id),
      is_default:false, sort_order:1
    });
    S.dbViews[pageId].push(boardView);
  }

  if(!S.currentViewId && S.dbViews[pageId].length > 0) {
    const def = S.dbViews[pageId].find(v => v.data.is_default) || S.dbViews[pageId][0];
    S.currentViewId = def.id;
  }

  renderDatabaseContent(dbContent, pageId);
}

function renderDatabaseContent(container, pageId) {
  const schema = S.dbSchemas[pageId]?.data;
  const records = S.dbRecords[pageId] || [];
  const views = S.dbViews[pageId] || [];
  const currentView = views.find(v => v.id === S.currentViewId) || views[0];
  if(!schema || !currentView) { container.innerHTML = '<div class="loading">Loading database...</div>'; return; }

  const props = schema.properties || [];
  const viewData = currentView.data;
  const activeRecords = records.filter(r => !r.data.is_archived);

  // Apply filters
  let filtered = activeRecords;
  if(viewData.filter_rules?.length) {
    filtered = applyFilters(filtered, viewData.filter_rules, props);
  }

  // Apply sorts
  if(viewData.sort_rules?.length) {
    filtered = applySorts(filtered, viewData.sort_rules, props);
  } else {
    // Default: sort by sort_order (from drag-and-drop reordering)
    filtered.sort((a,b) => (a.data.sort_order??9999) - (b.data.sort_order??9999));
  }

  // View bar
  let html = `<div class="db-view-bar">
    ${views.map(v => `<div class="db-view-tab${v.id===S.currentViewId?' active':''}" onclick="switchView('${v.id}')">${esc(v.data.name)}</div>`).join('')}
    <div class="db-view-add" onclick="addNewView()" title="Add view"><i data-lucide="plus" style="width:14px;height:14px"></i> Add view</div>
    <div class="db-actions">
      ${viewData.view_type === 'board' ? `<div style="position:relative;display:inline-block">
        <button class="db-action-btn" onclick="toggleGroupByMenu(event)"><i data-lucide="columns"></i> Group by: ${esc((props.find(p=>p.id===viewData.group_by_property_id)||{}).name||'None')}</button>
      </div>` : ''}
      <button class="db-action-btn" onclick="toggleDbFilter(event)"><i data-lucide="filter"></i> Filter</button>
      <button class="db-action-btn" onclick="toggleDbSort(event)"><i data-lucide="arrow-up-down"></i> Sort</button>
      <button class="db-action-btn" onclick="openColumnsModal()"><i data-lucide="columns-3"></i> Columns</button>
      <button class="btn-primary" style="height:28px;font-size:12px;padding:0 12px" onclick="addNewRecord('${pageId}')"><i data-lucide="plus" style="width:12px;height:12px"></i> New</button>
    </div>
  </div>`;

  // Render view
  switch(viewData.view_type) {
    case 'table': html += renderTableView(filtered, props, schema, pageId, viewData); break;
    case 'board': html += renderBoardView(filtered, props, schema, viewData, pageId); break;
    case 'list': html += renderListView(filtered, props, schema, pageId, viewData); break;
    case 'calendar': html += renderCalendarView(filtered, props, schema, viewData, pageId); break;
    case 'gallery': html += renderGalleryView(filtered, props, schema, pageId, viewData); break;
    default: html += renderTableView(filtered, props, schema, pageId, viewData);
  }

  container.innerHTML = html;
  renderIcons(container);
}

function renderTableView(records, props, schema, pageId, viewData) {
  const vpIds = viewData?.visible_property_ids;
  const visibleProps = vpIds?.length ? props.filter(p => vpIds.includes(p.id)) : props;
  let html = '<div class="db-table-wrapper"><table class="db-table" data-page-id="' + pageId + '"><thead><tr>';
  html += '<th style="width:24px;min-width:24px;max-width:24px;padding:0;border-right:none"></th>';
  visibleProps.forEach(p => {
    html += `<th style="width:${p.width||150}px" draggable="true" data-prop-id="${p.id}" data-page-id="${pageId}" ondragstart="colDragStart(event)" ondragend="colDragEnd(event)" ondragover="colDragOver(event)" ondragleave="colDragLeave(event)" ondrop="colDrop(event,'${pageId}')">${esc(p.name)}<span class="col-edit-btn" onclick="event.stopPropagation();openEditPropModal('${pageId}','${p.id}')" title="Edit property"><i data-lucide="pencil" style="width:12px;height:12px"></i></span><span class="col-resize" onmousedown="colResizeStart(event,'${pageId}','${p.id}')"></span></th>`;
  });
  html += '<th class="add-col-btn" style="width:36px" onclick="openAddPropModal(\'' + pageId + '\')"><i data-lucide="plus" style="width:14px;height:14px;vertical-align:middle"></i></th></tr></thead><tbody>';

  records.forEach(rec => {
    html += `<tr data-record-id="${rec.id}">`;
    html += `<td class="row-drag-handle" onmousedown="rowDragStart(event,'${pageId}')"><i data-lucide="grip-vertical"></i></td>`;
    visibleProps.forEach(p => {
      const val = rec.data.values?.[p.id];
      if(p.type === 'title') {
        html += `<td class="cell-title" onclick="openRecord('${rec.id}','${pageId}')">${renderCellValue(val, p, rec, props)}</td>`;
      } else if(p.type === 'checkbox') {
        html += `<td onclick="toggleCellCheckbox(event,'${rec.id}','${pageId}','${p.id}')" style="cursor:pointer">${renderCellValue(val, p, rec, props)}</td>`;
      } else if(p.type === 'files' || p.type === 'multi_select') {
        html += `<td onclick="openRecord('${rec.id}','${pageId}')" style="cursor:pointer">${renderCellValue(val, p, rec, props)}</td>`;
      } else if(p.type === 'formula') {
        html += `<td style="cursor:default">${renderCellValue(val, p, rec, props)}</td>`;
      } else {
        html += `<td onclick="startCellEdit(event,'${rec.id}','${pageId}','${p.id}')">${renderCellValue(val, p, rec, props)}</td>`;
      }
    });
    html += '<td></td></tr>';
  });

  html += `<tr class="new-row"><td colspan="${visibleProps.length+2}">
    <div class="add-row-btn" onclick="event.stopPropagation();addNewRecord('${pageId}')"><i data-lucide="plus" style="width:12px;height:12px"></i> New row</div>
  </td></tr>`;
  html += '</tbody></table></div>';
  return html;
}

// Inline cell editing
function startCellEdit(e, recordId, pageId, propId) {
  e.stopPropagation();
  const td = e.currentTarget;
  if(td.classList.contains('editing')) return;

  const records = S.dbRecords[pageId] || [];
  const record = records.find(r => r.id === recordId);
  if(!record) return;
  const schema = S.dbSchemas[pageId]?.data;
  if(!schema) return;
  const prop = schema.properties.find(p => p.id === propId);
  if(!prop) return;
  if(prop.type === 'formula') return;

  const val = record.data.values?.[propId];
  td.classList.add('editing');

  switch(prop.type) {
    case 'text': case 'url': case 'email': case 'phone': {
      td.innerHTML = `<input type="text" value="${esc(val||'')}" data-orig="${esc(val||'')}">`;
      const input = td.querySelector('input');
      input.focus();
      input.addEventListener('blur', () => finishCellEdit(td, input.value, record, propId, pageId));
      input.addEventListener('keydown', (ev) => {
        if(ev.key === 'Enter') input.blur();
        if(ev.key === 'Escape') { input.value = input.dataset.orig; input.blur(); }
      });
      break;
    }
    case 'number': case 'currency': {
      const numVal = val != null ? val : '';
      td.innerHTML = `<input type="number" value="${numVal}" step="any" data-orig="${numVal}">`;
      const input = td.querySelector('input');
      input.focus();
      input.addEventListener('blur', () => {
        const v = input.value ? parseFloat(input.value) : null;
        finishCellEdit(td, v, record, propId, pageId);
      });
      input.addEventListener('keydown', (ev) => {
        if(ev.key === 'Enter') input.blur();
        if(ev.key === 'Escape') { input.value = input.dataset.orig; input.blur(); }
      });
      break;
    }
    case 'date': {
      const dv = val?.start || val || '';
      td.innerHTML = `<input type="date" value="${esc(dv)}">`;
      const input = td.querySelector('input');
      input.focus();
      input.addEventListener('blur', () => {
        const v = input.value ? {start: input.value} : null;
        finishCellEdit(td, v, record, propId, pageId);
      });
      input.addEventListener('change', () => {
        const v = input.value ? {start: input.value} : null;
        finishCellEdit(td, v, record, propId, pageId);
      });
      input.addEventListener('keydown', (ev) => {
        if(ev.key === 'Escape') input.blur();
      });
      break;
    }
    case 'select': {
      const choices = prop.options?.choices || [];
      const selected = val?.selected || val || '';
      td.innerHTML = `<select>
        <option value="">-- Select --</option>
        ${choices.map(c => `<option value="${esc(c.name)}"${c.name===selected?' selected':''}>${esc(c.name)}</option>`).join('')}
      </select>`;
      const sel = td.querySelector('select');
      sel.focus();
      sel.addEventListener('change', () => {
        const v = sel.value ? {selected: sel.value} : null;
        finishCellEdit(td, v, record, propId, pageId);
      });
      sel.addEventListener('blur', () => {
        const v = sel.value ? {selected: sel.value} : null;
        finishCellEdit(td, v, record, propId, pageId);
      });
      sel.addEventListener('keydown', (ev) => {
        if(ev.key === 'Escape') sel.blur();
      });
      break;
    }
    default: {
      // Fallback: text input
      td.innerHTML = `<input type="text" value="${esc(val!=null?String(val):'')}" data-orig="${esc(val!=null?String(val):'')}">`;
      const input = td.querySelector('input');
      input.focus();
      input.addEventListener('blur', () => finishCellEdit(td, input.value, record, propId, pageId));
      input.addEventListener('keydown', (ev) => {
        if(ev.key === 'Enter') input.blur();
        if(ev.key === 'Escape') { input.value = input.dataset.orig; input.blur(); }
      });
    }
  }
}

async function finishCellEdit(td, value, record, propId, pageId) {
  if(!td.classList.contains('editing')) return;
  td.classList.remove('editing');
  if(!record.data.values) record.data.values = {};
  record.data.values[propId] = value;

  // Re-render the cell display
  const schema = S.dbSchemas[pageId]?.data;
  const prop = schema?.properties?.find(p => p.id === propId);
  td.innerHTML = prop ? renderCellValue(value, prop, record, schema?.properties) : esc(String(value||''));
  renderIcons(td);

  // Save
  await api.update('database_records', record.id, record.data);
}

function toggleCellCheckbox(e, recordId, pageId, propId) {
  e.stopPropagation();
  const records = S.dbRecords[pageId] || [];
  const record = records.find(r => r.id === recordId);
  if(!record) return;
  if(!record.data.values) record.data.values = {};
  const newVal = !record.data.values[propId];
  record.data.values[propId] = newVal;

  // Re-render this cell
  const td = e.currentTarget;
  const schema = S.dbSchemas[pageId]?.data;
  const prop = schema?.properties?.find(p => p.id === propId);
  td.innerHTML = prop ? renderCellValue(newVal, prop, record, schema?.properties) : '';
  renderIcons(td);

  api.update('database_records', record.id, record.data);
}

// Row drag and drop (mouse-event based for table compatibility)
function rowDragStart(e, pageId) {
  e.preventDefault();
  const tr = e.target.closest('tr');
  if(!tr || !tr.dataset.recordId) return;
  const draggedId = tr.dataset.recordId;
  const tbody = tr.closest('tbody');
  if(!tbody) return;

  tr.classList.add('row-dragging');
  document.body.style.cursor = 'grabbing';
  document.body.style.userSelect = 'none';

  const onMove = (ev) => {
    // Clear old indicators
    tbody.querySelectorAll('tr.row-drag-over-above,tr.row-drag-over-below').forEach(el => {
      el.classList.remove('row-drag-over-above','row-drag-over-below');
    });
    // Find target row under cursor
    const rows = [...tbody.querySelectorAll('tr[data-record-id]')];
    for(const row of rows) {
      if(row.dataset.recordId === draggedId) continue;
      const rect = row.getBoundingClientRect();
      if(ev.clientY >= rect.top && ev.clientY <= rect.bottom) {
        if(ev.clientY < rect.top + rect.height / 2) {
          row.classList.add('row-drag-over-above');
        } else {
          row.classList.add('row-drag-over-below');
        }
        break;
      }
    }
  };

  const onUp = async (ev) => {
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    tr.classList.remove('row-dragging');

    // Find the drop target
    const targetRow = tbody.querySelector('tr.row-drag-over-above,tr.row-drag-over-below');
    if(!targetRow || !targetRow.dataset.recordId) {
      tbody.querySelectorAll('tr.row-drag-over-above,tr.row-drag-over-below').forEach(el => el.classList.remove('row-drag-over-above','row-drag-over-below'));
      return;
    }

    const above = targetRow.classList.contains('row-drag-over-above');
    targetRow.classList.remove('row-drag-over-above','row-drag-over-below');

    const records = S.dbRecords[pageId] || [];
    const activeRecords = records.filter(r => !r.data.is_archived);
    activeRecords.sort((a,b) => (a.data.sort_order??9999) - (b.data.sort_order??9999));

    const dragIdx = activeRecords.findIndex(r => r.id === draggedId);
    const targetId = targetRow.dataset.recordId;
    if(dragIdx === -1) return;

    const [dragged] = activeRecords.splice(dragIdx, 1);
    let newIdx = activeRecords.findIndex(r => r.id === targetId);
    if(newIdx === -1) { activeRecords.push(dragged); }
    else { if(!above) newIdx += 1; activeRecords.splice(newIdx, 0, dragged); }

    activeRecords.forEach((r, i) => { r.data.sort_order = i; });

    // Optimistic UI update (render local state only, no API fetch)
    const dbContent = document.getElementById('db-content');
    if(dbContent) renderDatabaseContent(dbContent, pageId);

    // Persist via batch, then verify — refresh from server on failure
    try {
      const res = await TeamData.batch('database_records', activeRecords.map(r => ({ op: 'update', id: r.id, data: r.data })));
      const allOk = res && res.results && res.results.length === activeRecords.length && res.results.every(r => r.success);
      if(!allOk) await renderDatabasePage();
    } catch(e) {
      await renderDatabasePage();
    }
  };

  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
}

// Column drag and drop
let _colDragPropId = null;

function colDragStart(e) {
  if(e.target.classList.contains('col-resize')) { e.preventDefault(); return; }
  const th = e.target.closest('th');
  if(!th) return;
  _colDragPropId = th.dataset.propId;
  th.classList.add('col-dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', _colDragPropId);
}

function colDragEnd(e) {
  _colDragPropId = null;
  document.querySelectorAll('.db-table th.col-dragging,.db-table th.col-drag-over-left,.db-table th.col-drag-over-right').forEach(el => {
    el.classList.remove('col-dragging','col-drag-over-left','col-drag-over-right');
  });
}

function colDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  const th = e.target.closest('th');
  if(!th || !th.dataset.propId || th.dataset.propId === _colDragPropId) return;
  // Clear other indicators in this row
  th.closest('tr').querySelectorAll('th').forEach(el => {
    if(el !== th) el.classList.remove('col-drag-over-left','col-drag-over-right');
  });
  const rect = th.getBoundingClientRect();
  const midX = rect.left + rect.width / 2;
  if(e.clientX < midX) {
    th.classList.add('col-drag-over-left');
    th.classList.remove('col-drag-over-right');
  } else {
    th.classList.add('col-drag-over-right');
    th.classList.remove('col-drag-over-left');
  }
}

function colDragLeave(e) {
  const th = e.target.closest('th');
  if(th && !th.contains(e.relatedTarget)) {
    th.classList.remove('col-drag-over-left','col-drag-over-right');
  }
}

async function colDrop(e, pageId) {
  e.preventDefault();
  e.stopPropagation();
  const draggedId = _colDragPropId || e.dataTransfer.getData('text/plain');
  if(!draggedId) return;

  const th = e.target.closest('th');
  if(!th || !th.dataset.propId) return;
  const targetId = th.dataset.propId;
  if(draggedId === targetId) return;

  const schema = S.dbSchemas[pageId];
  if(!schema) return;
  const properties = schema.data.properties;

  const dragIdx = properties.findIndex(p => p.id === draggedId);
  const targetIdx = properties.findIndex(p => p.id === targetId);
  if(dragIdx === -1 || targetIdx === -1) return;

  // Determine insert position based on mouse
  const rect = th.getBoundingClientRect();
  const insertBefore = e.clientX < rect.left + rect.width / 2;

  // Remove dragged property
  const [dragged] = properties.splice(dragIdx, 1);

  // Find new target index (may have shifted after splice)
  let newIdx = properties.findIndex(p => p.id === targetId);
  if(!insertBefore) newIdx += 1;

  properties.splice(newIdx, 0, dragged);

  // Update sort_order
  properties.forEach((p, i) => { p.sort_order = i; });

  await api.update('database_schemas', schema.id, {properties: properties});
  colDragEnd(e);
  renderDatabasePage();
}

// Column resizing
let _colResize = null;

function colResizeStart(e, pageId, propId) {
  e.preventDefault();
  e.stopPropagation();
  const th = e.target.closest('th');
  if(!th) return;
  const startX = e.clientX;
  const startW = th.offsetWidth;
  const handle = e.target;
  handle.classList.add('resizing');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';

  const onMove = (ev) => {
    const diff = ev.clientX - startX;
    const newW = Math.max(60, startW + diff);
    th.style.width = newW + 'px';
  };

  const onUp = async () => {
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    handle.classList.remove('resizing');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';

    const finalW = th.offsetWidth;
    const schema = S.dbSchemas[pageId];
    if(schema) {
      const prop = schema.data.properties.find(p => p.id === propId);
      if(prop) {
        prop.width = finalW;
        await api.update('database_schemas', schema.id, {properties: schema.data.properties});
      }
    }
  };

  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
}

function renderBoardView(records, props, schema, viewData, pageId) {
  const groupProp = props.find(p => p.id === viewData.group_by_property_id);
  if(!groupProp || groupProp.type !== 'select') {
    return '<div style="padding:20px;color:#a19f9d">Board view requires a select property to group by.</div>';
  }

  const choices = groupProp.options?.choices || [];
  const groups = {};
  choices.forEach(c => { groups[c.name] = []; });
  groups['No Status'] = [];

  records.forEach(rec => {
    const val = rec.data.values?.[groupProp.id];
    const selected = val?.selected || val;
    if(typeof selected === 'string' && groups[selected] !== undefined) {
      groups[selected].push(rec);
    } else {
      groups['No Status'].push(rec);
    }
  });
  // Sort within each group by sort_order (from drag-and-drop)
  Object.values(groups).forEach(arr => arr.sort((a,b) => (a.data.sort_order??9999) - (b.data.sort_order??9999)));

  const titleProp = props.find(p => p.type === 'title') || props[0];
  const bvpIds = viewData?.visible_property_ids;
  const visibleProps = (bvpIds?.length ? props.filter(p => bvpIds.includes(p.id)) : props).filter(p => p.id !== groupProp.id && p.id !== titleProp?.id).slice(0,3);

  let html = `<div class="db-board" data-page-id="${pageId}" data-group-prop-id="${groupProp.id}">`;
  const allGroups = [...choices.map(c=>({name:c.name,color:c.color})), {name:'No Status',color:'light_gray'}];
  allGroups.forEach(g => {
    const items = groups[g.name] || [];
    html += `<div class="db-board-col" data-group="${esc(g.name)}" ondragover="boardDragOver(event)" ondragleave="boardDragLeave(event)" ondrop="boardDrop(event)">
      <div class="db-board-col-header">
        <span class="prop-tag ${g.color}">${esc(g.name)}</span>
        <span class="db-board-col-count">${items.length}</span>
      </div>`;
    items.forEach((rec, idx) => {
      const title = rec.data.values?.[titleProp?.id] || 'Untitled';
      html += `<div class="db-board-card" draggable="true" data-record-id="${rec.id}" data-sort="${idx}"
        ondragstart="boardDragStart(event)" ondragend="boardDragEnd(event)"
        ondragover="cardDragOver(event)" ondragleave="cardDragLeave(event)"
        onclick="openRecord('${rec.id}','${pageId}')">
        <div class="db-board-card-title">${esc(typeof title==='string'?title:String(title))}</div>
        <div class="db-board-card-props">
          ${visibleProps.map(p => {
            const v = rec.data.values?.[p.id];
            if(p.type === 'formula') return renderCellValue(v, p, rec, props);
            return v ? renderCellValue(v, p, rec, props) : '';
          }).join('')}
        </div>
      </div>`;
    });
    html += `<div class="db-board-drop-zone" ondragover="boardDragOver(event)" ondrop="boardDrop(event)"></div>`;
    html += `<div class="db-board-add" onclick="addNewRecord('${pageId}',{propId:'${groupProp.id}',value:'${esc(g.name)}'})"><i data-lucide="plus" style="width:12px;height:12px"></i> New</div>`;
    html += '</div>';
  });
  html += '</div>';
  return html;
}

// Board drag and drop
let _boardDragRecordId = null;
let _boardDragSourceGroup = null;

function boardDragStart(e) {
  const card = e.target.closest('.db-board-card');
  if(!card) return;
  _boardDragRecordId = card.dataset.recordId;
  _boardDragSourceGroup = card.closest('.db-board-col')?.dataset.group;
  card.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', _boardDragRecordId);
}

function boardDragEnd(e) {
  _boardDragRecordId = null;
  _boardDragSourceGroup = null;
  document.querySelectorAll('.db-board-card.dragging').forEach(el => el.classList.remove('dragging'));
  document.querySelectorAll('.db-board-card.drag-over-above,.db-board-card.drag-over-below').forEach(el => {
    el.classList.remove('drag-over-above','drag-over-below');
  });
  document.querySelectorAll('.db-board-col.drag-col-over').forEach(el => el.classList.remove('drag-col-over'));
}

function cardDragOver(e) {
  e.preventDefault();
  e.stopPropagation();
  e.dataTransfer.dropEffect = 'move';
  const card = e.target.closest('.db-board-card');
  if(!card || card.dataset.recordId === _boardDragRecordId) return;
  // Clear sibling indicators
  card.closest('.db-board-col').querySelectorAll('.db-board-card').forEach(el => {
    if(el !== card) el.classList.remove('drag-over-above','drag-over-below');
  });
  const rect = card.getBoundingClientRect();
  const midY = rect.top + rect.height / 2;
  if(e.clientY < midY) {
    card.classList.add('drag-over-above');
    card.classList.remove('drag-over-below');
  } else {
    card.classList.add('drag-over-below');
    card.classList.remove('drag-over-above');
  }
}

function cardDragLeave(e) {
  const card = e.target.closest('.db-board-card');
  if(!card) return;
  if(!card.contains(e.relatedTarget)) {
    card.classList.remove('drag-over-above','drag-over-below');
  }
}

function boardDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  const col = e.target.closest('.db-board-col');
  if(col) col.classList.add('drag-col-over');
}

function boardDragLeave(e) {
  const col = e.target.closest('.db-board-col');
  if(col && !col.contains(e.relatedTarget)) {
    col.classList.remove('drag-col-over');
  }
}

async function boardDrop(e) {
  e.preventDefault();
  e.stopPropagation();
  const draggedId = _boardDragRecordId || e.dataTransfer.getData('text/plain');
  if(!draggedId) return;

  const col = e.target.closest('.db-board-col');
  if(!col) return;
  const targetGroup = col.dataset.group;
  const board = col.closest('.db-board');
  const pageId = board?.dataset.pageId;
  const groupPropId = board?.dataset.groupPropId;
  if(!pageId || !groupPropId) return;

  const records = S.dbRecords[pageId] || [];
  const record = records.find(r => r.id === draggedId);
  if(!record) return;

  // Determine insert position
  const targetCard = e.target.closest('.db-board-card');
  let insertIdx = -1;
  if(targetCard && targetCard.dataset.recordId !== draggedId) {
    // Get all card IDs in this column in DOM order
    const colCards = [...col.querySelectorAll('.db-board-card:not(.dragging)')];
    const targetIdx = colCards.indexOf(targetCard);
    const rect = targetCard.getBoundingClientRect();
    const above = e.clientY < rect.top + rect.height / 2;
    insertIdx = above ? targetIdx : targetIdx + 1;
  }

  // Update the group/select value
  const newValue = targetGroup === 'No Status' ? null : {selected: targetGroup};
  if(!record.data.values) record.data.values = {};
  record.data.values[groupPropId] = newValue;

  // Update sort_order for ordering within the column
  const colRecords = records.filter(r => {
    if(r.id === draggedId) return false;
    const v = r.data.values?.[groupPropId];
    const sel = v?.selected || v;
    if(targetGroup === 'No Status') return !sel || sel === 'No Status';
    return sel === targetGroup;
  });

  if(insertIdx >= 0 && insertIdx < colRecords.length) {
    colRecords.splice(insertIdx, 0, record);
  } else {
    colRecords.push(record);
  }

  // Assign sort_order to all records in the column
  colRecords.forEach((r, i) => {
    if(!r.data) r.data = {};
    r.data.sort_order = i;
  });

  // Optimistic UI update (render local state only, no API fetch)
  boardDragEnd(e);
  const dbContent = document.getElementById('db-content');
  if(dbContent) renderDatabaseContent(dbContent, pageId);

  // Persist via batch, then verify — refresh from server on failure
  try {
    const res = await TeamData.batch('database_records', colRecords.map(r => ({ op: 'update', id: r.id, data: r.data })));
    const allOk = res && res.results && res.results.length === colRecords.length && res.results.every(r => r.success);
    if(!allOk) await renderDatabasePage();
  } catch(e) {
    await renderDatabasePage();
  }
}

function renderListView(records, props, schema, pageId, viewData) {
  const titleProp = props.find(p => p.type === 'title') || props[0];
  const lvpIds = viewData?.visible_property_ids;
  const visibleProps = (lvpIds?.length ? props.filter(p => lvpIds.includes(p.id)) : props).filter(p => p.id !== titleProp?.id).slice(0,4);

  let html = '<div class="db-list">';
  records.forEach(rec => {
    const title = rec.data.values?.[titleProp?.id] || 'Untitled';
    html += `<div class="db-list-item" onclick="openRecord('${rec.id}','${pageId}')">
      <span class="db-list-item-title">${esc(typeof title==='string'?title:String(title))}</span>
      <span class="db-list-item-props">
        ${visibleProps.map(p => renderCellValue(rec.data.values?.[p.id], p, rec, props)).join('')}
      </span>
    </div>`;
  });
  if(records.length === 0) html += '<div style="padding:20px;text-align:center;color:#a19f9d">No records</div>';
  html += `<div class="db-board-add" onclick="addNewRecord('${pageId}')"><i data-lucide="plus" style="width:12px;height:12px"></i> New</div>`;
  html += '</div>';
  return html;
}

function renderCalendarView(records, props, schema, viewData, pageId) {
  const dateProp = props.find(p => p.id === viewData.calendar_by_property_id) || props.find(p => p.type === 'date');
  if(!dateProp) return '<div style="padding:20px;color:#a19f9d">Calendar view requires a date property.</div>';

  const titleProp = props.find(p => p.type === 'title') || props[0];
  const now = new Date();
  const year = S._calYear || now.getFullYear();
  const month = S._calMonth !== undefined ? S._calMonth : now.getMonth();
  const firstDay = new Date(year, month, 1);
  const startDay = firstDay.getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const today = now.toISOString().split('T')[0];

  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  let html = `<div class="db-calendar">
    <div class="db-calendar-header">
      <div class="db-calendar-nav">
        <button onclick="calNav(-1)"><i data-lucide="chevron-left" style="width:14px;height:14px"></i></button>
        <span class="db-calendar-month">${monthNames[month]} ${year}</span>
        <button onclick="calNav(1)"><i data-lucide="chevron-right" style="width:14px;height:14px"></i></button>
      </div>
      <button class="btn-ghost" onclick="calToday()">Today</button>
    </div>
    <div class="db-calendar-grid">`;

  dayNames.forEach(d => { html += `<div class="db-calendar-day-header">${d}</div>`; });

  // Fill empty cells before first day
  for(let i=0;i<startDay;i++) html += '<div class="db-calendar-day other-month"></div>';

  for(let day=1;day<=daysInMonth;day++) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const isToday = dateStr === today;
    const dayRecords = records.filter(r => {
      const v = r.data.values?.[dateProp.id];
      const d = v?.start || v;
      return typeof d === 'string' && d.startsWith(dateStr);
    });
    html += `<div class="db-calendar-day${isToday?' today':''}" onclick="addNewRecord('${pageId}',{propId:'${dateProp.id}',value:'${dateStr}'})">
      <div class="day-num">${day}</div>
      ${dayRecords.slice(0,3).map(r => `<div class="db-calendar-event" onclick="event.stopPropagation();openRecord('${r.id}','${pageId}')">${esc(r.data.values?.[titleProp?.id]||'Untitled')}</div>`).join('')}
      ${dayRecords.length > 3 ? `<div style="font-size:10px;color:#a19f9d">+${dayRecords.length-3} more</div>` : ''}
    </div>`;
  }

  // Fill remaining cells
  const totalCells = startDay + daysInMonth;
  const remaining = (7 - (totalCells % 7)) % 7;
  for(let i=0;i<remaining;i++) html += '<div class="db-calendar-day other-month"></div>';

  html += '</div></div>';
  return html;
}

function calNav(dir) {
  const now = new Date();
  S._calMonth = (S._calMonth !== undefined ? S._calMonth : now.getMonth()) + dir;
  S._calYear = S._calYear || now.getFullYear();
  if(S._calMonth < 0) { S._calMonth = 11; S._calYear--; }
  if(S._calMonth > 11) { S._calMonth = 0; S._calYear++; }
  renderDatabasePage();
}

function calToday() {
  const now = new Date();
  S._calMonth = now.getMonth();
  S._calYear = now.getFullYear();
  renderDatabasePage();
}

function getFileUrl(f) {
  if(f.url) return f.url;
  if(f.file_id && typeof TeamData !== 'undefined') return TeamData.getDownloadUrl(f.file_id);
  return null;
}

function getGalleryCoverImage(rec, props) {
  const fileProps = props.filter(p => p.type === 'files');
  for(const fp of fileProps) {
    const files = rec.data.values?.[fp.id];
    if(!Array.isArray(files)) continue;
    const img = files.find(f => /\.(jpg|jpeg|png|gif|svg|webp|bmp|avif)$/i.test(f.filename||'') || (f.content_type||'').startsWith('image/'));
    if(img) { const u = getFileUrl(img); if(u) return u; }
  }
  return null;
}

function renderGalleryView(records, props, schema, pageId, viewData) {
  const titleProp = props.find(p => p.type === 'title') || props[0];
  const gvpIds = viewData?.visible_property_ids;
  const visibleProps = (gvpIds?.length ? props.filter(p => gvpIds.includes(p.id)) : props).filter(p => p.id !== titleProp?.id).slice(0,3);

  let html = '<div class="db-gallery">';
  records.forEach(rec => {
    const title = rec.data.values?.[titleProp?.id] || 'Untitled';
    const coverUrl = getGalleryCoverImage(rec, props);
    const coverStyle = coverUrl ? `background-image:url('${esc(coverUrl)}')` : '';
    const coverPlaceholder = coverUrl ? '' : `<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#c8c6c4"><i data-lucide="image" style="width:32px;height:32px"></i></div>`;
    html += `<div class="db-gallery-card" onclick="openRecord('${rec.id}','${pageId}')">
      <div class="db-gallery-cover" style="${coverStyle}">${coverPlaceholder}</div>
      <div class="db-gallery-info">
        <div class="db-gallery-title">${esc(typeof title==='string'?title:String(title))}</div>
        <div class="db-gallery-props">
          ${visibleProps.map(p => renderCellValue(rec.data.values?.[p.id], p, rec, props)).join('')}
        </div>
      </div>
    </div>`;
  });
  if(records.length === 0) html += '<div style="padding:40px;text-align:center;color:#a19f9d;grid-column:1/-1">No records</div>';
  html += '</div>';
  html += `<div class="db-board-add" style="margin-top:8px" onclick="addNewRecord('${pageId}')"><i data-lucide="plus" style="width:12px;height:12px"></i> New</div>`;
  return html;
}

// ── Formula Evaluator ──
function resolveFormulaValue(name, record, properties) {
  const prop = properties.find(p => p.type !== 'formula' && p.name.toLowerCase() === name.toLowerCase());
  if(!prop) return undefined;
  const raw = record?.data?.values?.[prop.id];
  if(raw && typeof raw === 'object' && raw.selected !== undefined) return raw.selected;
  if(raw && typeof raw === 'object' && raw.start !== undefined) return raw.start;
  return raw;
}

function evaluateFormula(expression, record, properties) {
  try {
    if(!expression || !expression.trim()) return '';
    // Tokenize
    const tokens = []; let i = 0; const expr = expression;
    while(i < expr.length) {
      if(expr[i] === ' ' || expr[i] === '\t') { i++; continue; }
      if(/[0-9]/.test(expr[i]) || (expr[i] === '.' && i+1 < expr.length && /[0-9]/.test(expr[i+1]))) {
        let num = '';
        while(i < expr.length && /[0-9.]/.test(expr[i])) num += expr[i++];
        tokens.push({t:'N', v:parseFloat(num)}); continue;
      }
      if(expr[i] === '"') {
        let s = ''; i++;
        while(i < expr.length && expr[i] !== '"') s += expr[i++];
        i++; tokens.push({t:'S', v:s}); continue;
      }
      if(expr[i] === '[') {
        let s = ''; i++;
        while(i < expr.length && expr[i] !== ']') s += expr[i++];
        i++; tokens.push({t:'I', v:s.trim()}); continue;
      }
      if(expr[i] === '!' && expr[i+1] === '=') { tokens.push({t:'C', v:'!='}); i+=2; continue; }
      if(expr[i] === '<' && expr[i+1] === '=') { tokens.push({t:'C', v:'<='}); i+=2; continue; }
      if(expr[i] === '>' && expr[i+1] === '=') { tokens.push({t:'C', v:'>='}); i+=2; continue; }
      if('+-*/&(),'.includes(expr[i])) { tokens.push({t:'O', v:expr[i]}); i++; continue; }
      if(expr[i] === '=' || expr[i] === '<' || expr[i] === '>') { tokens.push({t:'C', v:expr[i]}); i++; continue; }
      let id = '';
      while(i < expr.length && !'+-*/&(),=<>!\"[]\t '.includes(expr[i])) id += expr[i++];
      if(id) tokens.push({t:'I', v:id.trim()});
    }
    // Parse & evaluate
    let pos = 0;
    const peek = () => tokens[pos];
    const eat = (v) => { const tk = tokens[pos++]; if(v && tk?.v !== v) throw 0; return tk; };
    const toNum = (v) => { if(typeof v === 'number') return v; if(typeof v === 'boolean') return v?1:0; const n=parseFloat(v); return isNaN(n)?0:n; };

    function parseExpr() { return parseCmp(); }
    function parseCmp() {
      let l = parseAdd();
      const t = peek();
      if(t && t.t === 'C') { pos++; const r = parseAdd();
        switch(t.v) { case '=': return l==r; case '!=': return l!=r; case '<': return l<r; case '>': return l>r; case '<=': return l<=r; case '>=': return l>=r; }
      } return l;
    }
    function parseAdd() {
      let l = parseMul();
      while(peek() && (peek().v==='+' || peek().v==='-' || peek().v==='&')) {
        const op=eat().v; const r=parseMul();
        if(op==='+') l=toNum(l)+toNum(r); else if(op==='-') l=toNum(l)-toNum(r); else l=String(l??'')+String(r??'');
      } return l;
    }
    function parseMul() {
      let l = parseUn();
      while(peek() && (peek().v==='*' || peek().v==='/')) {
        const op=eat().v; const r=parseUn();
        if(op==='*') l=toNum(l)*toNum(r); else l=toNum(r)!==0?toNum(l)/toNum(r):0;
      } return l;
    }
    function parseUn() { if(peek()&&peek().v==='-'&&peek().t==='O'){pos++;return -toNum(parseUn());} return parsePri(); }
    function parsePri() {
      const t=peek(); if(!t) return '';
      if(t.t==='N'){pos++;return t.v;} if(t.t==='S'){pos++;return t.v;}
      if(t.t==='O'&&t.v==='('){pos++;const v=parseExpr();eat(')');return v;}
      if(t.t==='I'){pos++;
        if(peek()&&peek().v==='('){return callFn(t.v,parseArgs());}
        const v=resolveFormulaValue(t.v,record,properties); return v!==undefined&&v!==null?v:0;
      } pos++; return '';
    }
    function parseArgs(){eat('(');const a=[];if(peek()&&peek().v!==')'){a.push(parseExpr());while(peek()&&peek().v===','){eat(',');a.push(parseExpr());}}eat(')');return a;}
    function callFn(n,a){
      switch(n.toUpperCase()){
        case 'IF':return a[0]?a[1]:(a[2]??'');
        case 'SUM':return a.reduce((s,x)=>s+toNum(x),0);
        case 'MIN':return Math.min(...a.map(toNum));
        case 'MAX':return Math.max(...a.map(toNum));
        case 'ROUND':return parseFloat(toNum(a[0]).toFixed(toNum(a[1]??0)));
        case 'CONCAT':return a.map(x=>String(x??'')).join('');
        case 'UPPER':return String(a[0]??'').toUpperCase();
        case 'LOWER':return String(a[0]??'').toLowerCase();
        case 'LEN':return String(a[0]??'').length;
        case 'ABS':return Math.abs(toNum(a[0]));
        default:return '';
      }
    }
    const result = parseExpr();
    if(typeof result==='boolean') return result?'Yes':'No';
    if(typeof result==='number'&&!Number.isInteger(result)) return parseFloat(result.toFixed(10));
    return result;
  } catch(e) { return ''; }
}

function renderCellValue(val, prop, record, props) {
  if(prop.type !== 'formula' && (val === undefined || val === null || val === '')) return '';
  switch(prop.type) {
    case 'title':
    case 'text':
    case 'email':
    case 'phone':
      return `<span style="font-size:12px">${esc(String(val))}</span>`;
    case 'url':
      return `<div class="cell-url-wrap">${esc(String(val))}<span class="cell-url-open" onclick="event.stopPropagation();window.open('${esc(String(val))}','_blank')" title="Open link"><i data-lucide="external-link" style="width:12px;height:12px"></i></span></div>`;
    case 'number':
      const fmt = prop.options?.format || 'number';
      const prefix = {dollar:'$',euro:'€',pound:'£',yen:'¥'}[fmt] || '';
      const suffix = fmt === 'percent' ? '%' : '';
      return `<span style="font-size:12px">${prefix}${val}${suffix}</span>`;
    case 'select':
      const selected = val?.selected || val;
      if(!selected) return '';
      const choice = (prop.options?.choices||[]).find(c => c.name === selected);
      return `<span class="prop-tag ${choice?.color||'light_gray'}">${esc(String(selected))}</span>`;
    case 'multi_select':
      const items = val?.selected || val || [];
      if(!Array.isArray(items)) return esc(String(items));
      return items.map(item => {
        const c = (prop.options?.choices||[]).find(ch => ch.name === item);
        return `<span class="prop-tag ${c?.color||'light_gray'}">${esc(item)}</span>`;
      }).join(' ');
    case 'date':
      const d = val?.start || val;
      return `<span style="font-size:12px">${esc(String(d))}</span>`;
    case 'checkbox':
      return val ? '<i data-lucide="check-square" style="width:14px;height:14px;color:#107c10"></i>' : '<i data-lucide="square" style="width:14px;height:14px;color:#a19f9d"></i>';
    case 'currency':
      const curr = CURRENCIES.find(c => c.code === (prop.options?.currency || 'USD')) || CURRENCIES[0];
      const cDecimals = curr.decimals !== undefined ? curr.decimals : 2;
      const cNum = parseFloat(val);
      if(isNaN(cNum)) return '';
      const cFormatted = cNum.toLocaleString(undefined, {minimumFractionDigits:cDecimals, maximumFractionDigits:cDecimals});
      return `<span style="font-size:12px">${curr.position==='before' ? curr.symbol + cFormatted : cFormatted + ' ' + curr.symbol}</span>`;
    case 'files':
      const files = Array.isArray(val) ? val : [];
      if(files.length === 0) return '';
      return files.map(f => `<span class="file-cell-tag"><i data-lucide="paperclip"></i>${esc(f.filename||'file')}</span>`).join('');
    case 'person':
      return `<span style="font-size:12px">${esc(val?.username||String(val))}</span>`;
    case 'formula': {
      if(!record || !props || !prop.options?.expression) return '';
      const result = evaluateFormula(prop.options.expression, record, props);
      if(result === '' || result === undefined || result === null) return '';
      return `<span style="font-size:12px;color:#605e5c">${esc(String(result))}</span>`;
    }
    default:
      return `<span style="font-size:12px">${esc(String(val))}</span>`;
  }
}

function applyFilters(records, rules, props) {
  return records.filter(rec => {
    return rules.every(rule => {
      const val = rec.data.values?.[rule.property_id];
      const prop = props.find(p => p.id === rule.property_id);
      if(!prop) return true;
      const v = typeof val === 'object' && val?.selected ? val.selected : val;
      switch(rule.operator) {
        case 'equals': return v == rule.value;
        case 'not_equals': return v != rule.value;
        case 'contains': return String(v||'').toLowerCase().includes(String(rule.value).toLowerCase());
        case 'is_empty': return !v;
        case 'is_not_empty': return !!v;
        default: return true;
      }
    });
  });
}

function applySorts(records, rules, props) {
  return [...records].sort((a,b) => {
    for(const rule of rules) {
      const prop = props.find(p => p.id === rule.property_id);
      let va, vb;
      if(prop && prop.type === 'formula' && prop.options?.expression) {
        va = evaluateFormula(prop.options.expression, a, props);
        vb = evaluateFormula(prop.options.expression, b, props);
      } else {
        va = a.data.values?.[rule.property_id];
        vb = b.data.values?.[rule.property_id];
      }
      const sa = typeof va === 'object' && va?.selected ? va.selected : va;
      const sb = typeof vb === 'object' && vb?.selected ? vb.selected : vb;
      let cmp = 0;
      if(sa < sb) cmp = -1;
      else if(sa > sb) cmp = 1;
      if(rule.direction === 'desc') cmp *= -1;
      if(cmp !== 0) return cmp;
    }
    return 0;
  });
}

function switchView(viewId) {
  S.currentViewId = viewId;
  renderDatabasePage();
}

function toggleGroupByMenu(e) {
  e.stopPropagation();
  const existing = document.getElementById('group-by-menu');
  if(existing) { existing.remove(); return; }

  const pageId = S.currentPageId;
  const schema = S.dbSchemas[pageId]?.data;
  if(!schema) return;
  const view = (S.dbViews[pageId]||[]).find(v => v.id === S.currentViewId);
  if(!view) return;

  const selectProps = schema.properties.filter(p => p.type === 'select');
  const currentGroupId = view.data.group_by_property_id;

  const btn = e.currentTarget;
  const rect = btn.getBoundingClientRect();

  const menu = document.createElement('div');
  menu.id = 'group-by-menu';
  menu.style.cssText = `position:fixed;top:${rect.bottom+4}px;left:${rect.left}px;background:#fff;border:1px solid #d2d0ce;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;min-width:200px;padding:4px 0`;

  if(selectProps.length === 0) {
    menu.innerHTML = '<div style="padding:10px 14px;font-size:12px;color:#a19f9d">No select properties available.<br>Add a select property to use board grouping.</div>';
  } else {
    menu.innerHTML = '<div style="padding:6px 14px;font-size:11px;font-weight:600;color:#a19f9d;text-transform:uppercase;letter-spacing:0.5px">Group by</div>' +
      selectProps.map(p => `<div style="padding:7px 14px;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:8px;${p.id===currentGroupId?'background:#f0f6ff;color:#0078d4;font-weight:600':''}" onmouseover="this.style.background='${p.id===currentGroupId?'#d0e7f5':'#f3f2f1'}'" onmouseout="this.style.background='${p.id===currentGroupId?'#f0f6ff':''}'" onclick="setGroupByProperty('${p.id}')">
        <i data-lucide="chevron-down" style="width:14px;height:14px"></i>
        <span>${esc(p.name)}</span>
        ${p.id===currentGroupId ? '<i data-lucide="check" style="width:14px;height:14px;margin-left:auto"></i>' : ''}
      </div>`).join('');
  }

  document.body.appendChild(menu);
  renderIcons(menu);

  const close = (ev) => { if(!menu.contains(ev.target) && ev.target !== btn) { menu.remove(); document.removeEventListener('click', close); } };
  setTimeout(() => document.addEventListener('click', close), 0);
}

async function setGroupByProperty(propId) {
  const pageId = S.currentPageId;
  const view = (S.dbViews[pageId]||[]).find(v => v.id === S.currentViewId);
  if(!view) return;
  view.data.group_by_property_id = propId;
  await api.update('database_views', view.id, {group_by_property_id: propId});
  const menu = document.getElementById('group-by-menu');
  if(menu) menu.remove();
  renderDatabasePage();
  toast('Board grouped by updated');
}

const VIEW_TYPES = [
  {type:'table',    name:'Table',    icon:'table',     desc:'Rows and columns, like a spreadsheet'},
  {type:'board',    name:'Board',    icon:'columns',   desc:'Kanban board grouped by a select property'},
  {type:'list',     name:'List',     icon:'list',      desc:'Simple vertical list of records'},
  {type:'calendar', name:'Calendar', icon:'calendar',  desc:'Records on a monthly calendar grid'},
  {type:'gallery',  name:'Gallery',  icon:'layout-grid',desc:'Card-based visual grid layout'},
];

function addNewView() {
  S._addViewType = 'table';
  S._addViewName = '';
  const modal = document.getElementById('add-view-modal');
  modal.classList.add('visible');
  renderAddViewModal();
  setTimeout(() => document.getElementById('new-view-name')?.focus(), 100);
}

function closeAddViewModal() {
  document.getElementById('add-view-modal').classList.remove('visible');
}

function selectViewType(type) {
  S._addViewName = document.getElementById('new-view-name')?.value ?? S._addViewName ?? '';
  S._addViewType = type;
  renderAddViewModal();
}

function renderAddViewModal() {
  const content = document.getElementById('add-view-content');
  const selected = S._addViewType || 'table';
  const nameVal = document.getElementById('new-view-name')?.value ?? S._addViewName ?? '';
  S._addViewName = nameVal;

  content.innerHTML = `
    <div class="modal-header">
      <h2>Add View</h2>
      <button class="panel-close" onclick="closeAddViewModal()"><i data-lucide="x"></i></button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:16px">
        <label style="display:block;font-size:12px;font-weight:600;color:#605e5c;margin-bottom:6px">View Name</label>
        <input type="text" id="new-view-name" value="${esc(nameVal)}" placeholder="e.g. Sprint Board, Task Calendar..." style="width:100%;height:36px;border:1px solid #8a8886;padding:0 10px;font-size:14px;outline:none" onfocus="this.style.borderColor='#0078d4'" onblur="this.style.borderColor='#8a8886'" oninput="S._addViewName=this.value">
      </div>
      <div>
        <label style="display:block;font-size:12px;font-weight:600;color:#605e5c;margin-bottom:6px">View Type</label>
        <div class="view-type-grid">
          ${VIEW_TYPES.map(vt => `
            <div class="view-type-option${vt.type===selected?' selected':''}" onclick="selectViewType('${vt.type}')">
              <i data-lucide="${vt.icon}"></i>
              <span>${vt.name}</span>
            </div>
          `).join('')}
        </div>
        <div style="margin-top:8px;padding:10px;background:#faf9f8;border:1px solid #ddd9d7">
          <div style="font-size:12px;font-weight:600;color:#323130;margin-bottom:2px">${VIEW_TYPES.find(vt=>vt.type===selected)?.name||'Table'}</div>
          <div style="font-size:11px;color:#605e5c">${VIEW_TYPES.find(vt=>vt.type===selected)?.desc||''}</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeAddViewModal()">Cancel</button>
      <button class="btn-primary" onclick="confirmAddView()">Add View</button>
    </div>
  `;
  renderIcons(content);
}

async function confirmAddView() {
  const nameEl = document.getElementById('new-view-name');
  const name = nameEl?.value?.trim();
  if(!name) { nameEl?.focus(); toast('Please enter a view name','error'); return; }
  const type = S._addViewType || 'table';

  const pageId = S.currentPageId;
  const schema = S.dbSchemas[pageId]?.data;
  const viewData = {
    database_page_id: pageId, name, view_type: type,
    filter_rules:[], sort_rules:[],
    visible_property_ids: (schema?.properties||[]).map(p=>p.id),
    is_default:false, sort_order: (S.dbViews[pageId]||[]).length
  };

  if(type === 'board') {
    const selectProp = schema?.properties?.find(p => p.type === 'select');
    if(selectProp) viewData.group_by_property_id = selectProp.id;
  }
  if(type === 'calendar') {
    const dateProp = schema?.properties?.find(p => p.type === 'date');
    if(dateProp) viewData.calendar_by_property_id = dateProp.id;
  }

  const rec = await api.create('database_views', viewData);
  S.dbViews[pageId].push(rec);
  S.currentViewId = rec.id;
  closeAddViewModal();
  renderDatabasePage();
  toast('View "' + name + '" added');
}

async function addNewRecord(pageId, preset) {
  const schema = S.dbSchemas[pageId]?.data;
  if(!schema) return;
  const rowCount = (S.dbRecords[pageId] || []).filter(r => !r.data.is_archived).length;
  if(rowCount >= PLAN.maxRowsPerTable) {
    if(PLAN.showUpgrade) {
      showUpgradeModal('Row limit reached', `The Free plan supports up to ${PLAN.maxRowsPerTable} rows per table. Upgrade to Pro for up to 10,000 rows per table.`);
    }
    return;
  }
  const values = {};
  schema.properties.forEach(p => {
    if(p.type === 'title') values[p.id] = '';
    else if(p.type === 'checkbox') values[p.id] = false;
    else values[p.id] = null;
  });
  if(preset?.propId) {
    const prop = schema.properties.find(p => p.id === preset.propId);
    if(prop) {
      if(prop.type === 'select') values[preset.propId] = {selected: preset.value};
      else if(prop.type === 'date') values[preset.propId] = {start: preset.value};
      else values[preset.propId] = preset.value;
    }
  }
  const rec = await api.create('database_records', {database_page_id:pageId, values, sub_page_content_blocks:[], is_archived:false});
  S.dbRecords[pageId] = S.dbRecords[pageId] || [];
  S.dbRecords[pageId].push(rec);
  openRecord(rec.id, pageId);
  renderDatabasePage();
}

// ============================================================
// ADD PROPERTY MODAL
// ============================================================
const PROP_TYPES = [
  {type:'text',     name:'Text',         icon:'type',          desc:'Plain text content'},
  {type:'number',   name:'Number',       icon:'hash',          desc:'Numeric values'},
  {type:'select',   name:'Select',       icon:'chevron-down',  desc:'Single choice from a list'},
  {type:'multi_select', name:'Multi Select', icon:'list-checks', desc:'Multiple choices from a list'},
  {type:'date',     name:'Date',         icon:'calendar',      desc:'Date or date range'},
  {type:'checkbox', name:'Checkbox',     icon:'check-square',  desc:'True or false toggle'},
  {type:'url',      name:'URL',          icon:'link',          desc:'Web link'},
  {type:'email',    name:'Email',        icon:'mail',          desc:'Email address'},
  {type:'phone',    name:'Phone',        icon:'phone',         desc:'Phone number'},
  {type:'files',    name:'Files',        icon:'paperclip',     desc:'Upload and attach files'},
  {type:'currency', name:'Currency',     icon:'dollar-sign',   desc:'Monetary values with currency symbol'},
  {type:'formula',  name:'Formula',      icon:'sigma',         desc:'Computed value from other properties'},
];

const CURRENCIES = [
  {code:'USD', name:'US Dollar',         symbol:'$',  position:'before'},
  {code:'EUR', name:'Euro',              symbol:'\u20AC', position:'before'},
  {code:'GBP', name:'British Pound',     symbol:'\u00A3', position:'before'},
  {code:'JPY', name:'Japanese Yen',      symbol:'\u00A5', position:'before', decimals:0},
  {code:'CNY', name:'Chinese Yuan',      symbol:'\u00A5', position:'before'},
  {code:'KRW', name:'South Korean Won',  symbol:'\u20A9', position:'before', decimals:0},
  {code:'INR', name:'Indian Rupee',      symbol:'\u20B9', position:'before'},
  {code:'BRL', name:'Brazilian Real',    symbol:'R$', position:'before'},
  {code:'CAD', name:'Canadian Dollar',   symbol:'CA$', position:'before'},
  {code:'AUD', name:'Australian Dollar', symbol:'A$', position:'before'},
  {code:'CHF', name:'Swiss Franc',       symbol:'CHF ', position:'before'},
  {code:'MXN', name:'Mexican Peso',      symbol:'MX$', position:'before'},
  {code:'SGD', name:'Singapore Dollar',  symbol:'S$', position:'before'},
  {code:'HKD', name:'Hong Kong Dollar',  symbol:'HK$', position:'before'},
  {code:'SEK', name:'Swedish Krona',     symbol:'kr ', position:'before'},
  {code:'NOK', name:'Norwegian Krone',   symbol:'kr ', position:'before'},
  {code:'TWD', name:'New Taiwan Dollar', symbol:'NT$', position:'before', decimals:0},
  {code:'RUB', name:'Russian Ruble',     symbol:'\u20BD', position:'after'},
  {code:'TRY', name:'Turkish Lira',      symbol:'\u20BA', position:'before'},
  {code:'ZAR', name:'South African Rand',symbol:'R', position:'before'},
];

const CHOICE_COLORS = ['light_gray','gray','brown','orange','yellow','green','blue','purple','pink','red'];

function openAddPropModal(pageId) {
  S._addPropPageId = pageId;
  S._addPropType = 'text';
  S._addPropName = '';
  S._addPropChoices = [
    {id:uid(), name:'Option 1', color:'blue'},
    {id:uid(), name:'Option 2', color:'green'},
    {id:uid(), name:'Option 3', color:'orange'}
  ];
  S._addPropColorPicker = null;
  S._addPropCurrency = 'USD';
  S._addPropExpression = '';
  const modal = document.getElementById('add-prop-modal');
  modal.classList.add('visible');
  renderAddPropModal();
  setTimeout(() => document.getElementById('new-prop-name')?.focus(), 100);
}

function closeAddPropModal() {
  document.getElementById('add-prop-modal').classList.remove('visible');
  S._addPropPageId = null;
  S._addPropColorPicker = null;
}

function renderAddPropModal() {
  const content = document.getElementById('add-prop-content');
  const selected = S._addPropType || 'text';
  const isSelectType = selected === 'select' || selected === 'multi_select';
  // Preserve name from input if it exists
  const nameVal = document.getElementById('new-prop-name')?.value ?? S._addPropName ?? '';
  S._addPropName = nameVal;

  let choicesHtml = '';
  if(isSelectType) {
    choicesHtml = `
      <div class="choices-editor">
        <label class="choices-editor-label">Options</label>
        ${(S._addPropChoices||[]).map((ch, i) => `
          <div class="choice-row" data-choice-idx="${i}">
            <div style="position:relative">
              <div class="choice-color-btn" style="background:${TAG_COLORS[ch.color]?.bg||'#f3f2f1'};border-left:4px solid ${TAG_COLORS[ch.color]?.fg||'#605e5c'}" onclick="toggleChoiceColorPicker(${i})" title="Change color"></div>
              ${S._addPropColorPicker === i ? `
                <div class="color-picker-dropdown">
                  ${CHOICE_COLORS.map(c => `
                    <div class="color-swatch${ch.color===c?' active':''}" style="background:${TAG_COLORS[c].bg};border-left:3px solid ${TAG_COLORS[c].fg}" onclick="event.stopPropagation();setChoiceColor(${i},'${c}')" title="${c}"></div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
            <input type="text" value="${esc(ch.name)}" placeholder="Option name" oninput="updateChoiceName(${i},this.value)">
            ${(S._addPropChoices||[]).length > 1 ? `<div class="choice-remove-btn" onclick="removeChoice(${i})" title="Remove"><i data-lucide="x" style="width:14px;height:14px"></i></div>` : '<div style="width:30px"></div>'}
          </div>
        `).join('')}
        <div class="choice-add-btn" onclick="addChoice()"><i data-lucide="plus" style="width:14px;height:14px"></i> Add option</div>
      </div>
    `;
  }

  let currencyHtml = '';
  if(selected === 'currency') {
    const selCur = S._addPropCurrency || 'USD';
    currencyHtml = `
      <div class="choices-editor">
        <label class="choices-editor-label">Currency</label>
        <select id="add-prop-currency" onchange="S._addPropCurrency=this.value" style="width:100%;height:36px;border:1px solid #8a8886;padding:0 10px;font-size:13px;outline:none;background:#fff">
          ${CURRENCIES.map(c => `<option value="${c.code}"${c.code===selCur?' selected':''}>${c.symbol}  ${c.name} (${c.code})</option>`).join('')}
        </select>
        <div style="margin-top:8px;font-size:11px;color:#605e5c">Values will be displayed with the selected currency symbol.</div>
      </div>
    `;
  }

  let formulaHtml = '';
  if(selected === 'formula') {
    const exprVal = S._addPropExpression || '';
    formulaHtml = `
      <div class="choices-editor">
        <label class="choices-editor-label">Formula Expression</label>
        <textarea id="add-prop-formula" rows="2"
          style="width:100%;border:1px solid #8a8886;padding:8px 10px;font-size:13px;font-family:monospace;outline:none;background:#fff;resize:vertical"
          oninput="S._addPropExpression=this.value"
          placeholder="e.g. Price * Quantity">${esc(exprVal)}</textarea>
        <div style="margin-top:10px;font-size:11px;color:#605e5c;line-height:1.7">
          <div style="font-weight:600;margin-bottom:4px">Reference columns by name. Use [brackets] for multi-word names.</div>
          <div><code style="background:#f3f2f1;padding:1px 4px">Price * Quantity</code> — multiply two columns</div>
          <div><code style="background:#f3f2f1;padding:1px 4px">[Visitors] + [Domain Visitors]</code> — add columns</div>
          <div><code style="background:#f3f2f1;padding:1px 4px">IF(Status = "Done", "Complete", "Pending")</code> — conditional</div>
          <div><code style="background:#f3f2f1;padding:1px 4px">UPPER([Name]) &amp; " - " &amp; Status</code> — text join</div>
          <div><code style="background:#f3f2f1;padding:1px 4px">ROUND(Price * 1.1, 2)</code> — round to decimals</div>
          <div style="margin-top:6px"><b>Functions:</b> IF, SUM, MIN, MAX, ROUND, ABS, CONCAT, UPPER, LOWER, LEN</div>
        </div>
      </div>
    `;
  }

  content.innerHTML = `
    <div class="modal-header">
      <h2>Add Property</h2>
      <button class="panel-close" onclick="closeAddPropModal()"><i data-lucide="x"></i></button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:16px">
        <label style="display:block;font-size:12px;font-weight:600;color:#605e5c;margin-bottom:6px">Property Name</label>
        <input type="text" id="new-prop-name" value="${esc(nameVal)}" placeholder="e.g. Status, Priority, Due Date..." style="width:100%;height:36px;border:1px solid #8a8886;padding:0 10px;font-size:14px;outline:none" onfocus="this.style.borderColor='#0078d4'" onblur="this.style.borderColor='#8a8886'" oninput="S._addPropName=this.value">
      </div>
      <div>
        <label style="display:block;font-size:12px;font-weight:600;color:#605e5c;margin-bottom:6px">Property Type</label>
        <div class="prop-type-grid">
          ${PROP_TYPES.map(pt => `
            <div class="prop-type-option${pt.type===selected?' selected':''}" onclick="selectPropType('${pt.type}')">
              <i data-lucide="${pt.icon}"></i>
              <span>${pt.name}</span>
            </div>
          `).join('')}
        </div>
        <div style="margin-top:8px;padding:10px;background:#faf9f8;border:1px solid #ddd9d7">
          <div style="font-size:12px;font-weight:600;color:#323130;margin-bottom:2px">${PROP_TYPES.find(pt=>pt.type===selected)?.name||'Text'}</div>
          <div style="font-size:11px;color:#605e5c">${PROP_TYPES.find(pt=>pt.type===selected)?.desc||''}</div>
        </div>
      </div>
      ${choicesHtml}
      ${currencyHtml}
      ${formulaHtml}
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeAddPropModal()">Cancel</button>
      <button class="btn-primary" onclick="confirmAddProperty()">Add Property</button>
    </div>
  `;
  renderIcons(content);
}

function selectPropType(type) {
  // Preserve name and formula expression
  S._addPropName = document.getElementById('new-prop-name')?.value ?? S._addPropName ?? '';
  S._addPropExpression = document.getElementById('add-prop-formula')?.value ?? S._addPropExpression ?? '';
  S._addPropType = type;
  S._addPropColorPicker = null;
  renderAddPropModal();
}

function toggleChoiceColorPicker(idx) {
  S._addPropName = document.getElementById('new-prop-name')?.value ?? S._addPropName ?? '';
  S._addPropColorPicker = S._addPropColorPicker === idx ? null : idx;
  renderAddPropModal();
}

function setChoiceColor(idx, color) {
  S._addPropName = document.getElementById('new-prop-name')?.value ?? S._addPropName ?? '';
  if(S._addPropChoices[idx]) S._addPropChoices[idx].color = color;
  S._addPropColorPicker = null;
  renderAddPropModal();
}

function updateChoiceName(idx, name) {
  if(S._addPropChoices[idx]) S._addPropChoices[idx].name = name;
}

function addChoice() {
  S._addPropName = document.getElementById('new-prop-name')?.value ?? S._addPropName ?? '';
  const usedColors = (S._addPropChoices||[]).map(c => c.color);
  const nextColor = CHOICE_COLORS.find(c => !usedColors.includes(c)) || CHOICE_COLORS[S._addPropChoices.length % CHOICE_COLORS.length];
  S._addPropChoices.push({id:uid(), name:'', color:nextColor});
  renderAddPropModal();
  // Focus the new input
  setTimeout(() => {
    const rows = document.querySelectorAll('.choice-row input[type="text"]');
    if(rows.length) rows[rows.length-1].focus();
  }, 50);
}

function removeChoice(idx) {
  S._addPropName = document.getElementById('new-prop-name')?.value ?? S._addPropName ?? '';
  S._addPropChoices.splice(idx, 1);
  S._addPropColorPicker = null;
  renderAddPropModal();
}

async function confirmAddProperty() {
  const nameEl = document.getElementById('new-prop-name');
  const name = nameEl?.value?.trim();
  if(!name) { nameEl?.focus(); toast('Please enter a property name','error'); return; }
  const type = S._addPropType || 'text';
  const pageId = S._addPropPageId;
  const schema = S.dbSchemas[pageId];
  if(!schema) return;

  const newProp = {id:uid(), name, type, options:{}, sort_order:schema.data.properties.length, visible:true, width:150};
  if(type === 'select' || type === 'multi_select') {
    const validChoices = (S._addPropChoices||[]).filter(c => c.name.trim());
    if(validChoices.length === 0) { toast('Add at least one option','error'); return; }
    newProp.options = {choices: validChoices.map(c => ({id:c.id, name:c.name.trim(), color:c.color}))};
  }
  if(type === 'currency') {
    newProp.options = {currency: S._addPropCurrency || 'USD'};
  }
  if(type === 'formula') {
    const expr = (S._addPropExpression || '').trim();
    if(!expr) { toast('Please enter a formula expression','error'); return; }
    newProp.options = {expression: expr};
  }
  schema.data.properties.push(newProp);
  await api.update('database_schemas', schema.id, {properties:schema.data.properties});

  // Update views to include new property
  for(const v of (S.dbViews[pageId]||[])) {
    if(v.data.visible_property_ids) {
      v.data.visible_property_ids.push(newProp.id);
      await api.update('database_views', v.id, {visible_property_ids:v.data.visible_property_ids});
    }
  }

  closeAddPropModal();
  renderDatabasePage();
  toast('Property "' + name + '" added');
}

// ============================================================
// EDIT PROPERTY MODAL
// ============================================================
function openEditPropModal(pageId, propId) {
  const schema = S.dbSchemas[pageId]?.data;
  if(!schema) return;
  const prop = schema.properties.find(p => p.id === propId);
  if(!prop) return;

  S._editPropPageId = pageId;
  S._editPropId = propId;
  S._editPropName = prop.name;
  S._editPropType = prop.type;
  S._editPropOrigType = prop.type;
  S._editPropChoices = prop.options?.choices ? JSON.parse(JSON.stringify(prop.options.choices)) : [
    {id:uid(), name:'Option 1', color:'blue'},
    {id:uid(), name:'Option 2', color:'green'},
    {id:uid(), name:'Option 3', color:'orange'}
  ];
  S._editPropColorPicker = null;
  S._editPropCurrency = prop.options?.currency || 'USD';
  S._editPropExpression = prop.options?.expression || '';

  document.getElementById('edit-prop-modal').classList.add('visible');
  renderEditPropModal();
  setTimeout(() => document.getElementById('edit-prop-name')?.focus(), 100);
}

function closeEditPropModal() {
  document.getElementById('edit-prop-modal').classList.remove('visible');
  S._editPropPageId = null;
  S._editPropId = null;
  S._editPropColorPicker = null;
}

function renderEditPropModal() {
  const content = document.getElementById('edit-prop-content');
  const selected = S._editPropType || 'text';
  const isSelectType = selected === 'select' || selected === 'multi_select';
  const nameVal = document.getElementById('edit-prop-name')?.value ?? S._editPropName ?? '';
  S._editPropName = nameVal;
  const isTitle = S._editPropOrigType === 'title';

  let choicesHtml = '';
  if(isSelectType) {
    choicesHtml = `
      <div class="choices-editor">
        <label class="choices-editor-label">Options</label>
        ${(S._editPropChoices||[]).map((ch, i) => `
          <div class="choice-row" data-choice-idx="${i}">
            <div style="position:relative">
              <div class="choice-color-btn" style="background:${TAG_COLORS[ch.color]?.bg||'#f3f2f1'};border-left:4px solid ${TAG_COLORS[ch.color]?.fg||'#605e5c'}" onclick="toggleEditChoiceColorPicker(${i})" title="Change color"></div>
              ${S._editPropColorPicker === i ? `
                <div class="color-picker-dropdown">
                  ${CHOICE_COLORS.map(c => `
                    <div class="color-swatch${ch.color===c?' active':''}" style="background:${TAG_COLORS[c].bg};border-left:3px solid ${TAG_COLORS[c].fg}" onclick="event.stopPropagation();setEditChoiceColor(${i},'${c}')" title="${c}"></div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
            <input type="text" value="${esc(ch.name)}" placeholder="Option name" oninput="updateEditChoiceName(${i},this.value)">
            ${(S._editPropChoices||[]).length > 1 ? `<div class="choice-remove-btn" onclick="removeEditChoice(${i})" title="Remove"><i data-lucide="x" style="width:14px;height:14px"></i></div>` : '<div style="width:30px"></div>'}
          </div>
        `).join('')}
        <div class="choice-add-btn" onclick="addEditChoice()"><i data-lucide="plus" style="width:14px;height:14px"></i> Add option</div>
      </div>
    `;
  }

  let editCurrencyHtml = '';
  if(selected === 'currency') {
    const selCur = S._editPropCurrency || 'USD';
    editCurrencyHtml = `
      <div class="choices-editor">
        <label class="choices-editor-label">Currency</label>
        <select id="edit-prop-currency" onchange="S._editPropCurrency=this.value" style="width:100%;height:36px;border:1px solid #8a8886;padding:0 10px;font-size:13px;outline:none;background:#fff">
          ${CURRENCIES.map(c => `<option value="${c.code}"${c.code===selCur?' selected':''}>${c.symbol}  ${c.name} (${c.code})</option>`).join('')}
        </select>
        <div style="margin-top:8px;font-size:11px;color:#605e5c">Values will be displayed with the selected currency symbol.</div>
      </div>
    `;
  }

  let editFormulaHtml = '';
  if(selected === 'formula') {
    const exprVal = S._editPropExpression || '';
    editFormulaHtml = `
      <div class="choices-editor">
        <label class="choices-editor-label">Formula Expression</label>
        <textarea id="edit-prop-formula" rows="2"
          style="width:100%;border:1px solid #8a8886;padding:8px 10px;font-size:13px;font-family:monospace;outline:none;background:#fff;resize:vertical"
          oninput="S._editPropExpression=this.value"
          placeholder="e.g. Price * Quantity">${esc(exprVal)}</textarea>
        <div style="margin-top:10px;font-size:11px;color:#605e5c;line-height:1.7">
          <div style="font-weight:600;margin-bottom:4px">Reference columns by name. Use [brackets] for multi-word names.</div>
          <div><code style="background:#f3f2f1;padding:1px 4px">Price * Quantity</code> — multiply two columns</div>
          <div><code style="background:#f3f2f1;padding:1px 4px">[Visitors] + [Domain Visitors]</code> — add columns</div>
          <div><code style="background:#f3f2f1;padding:1px 4px">IF(Status = "Done", "Complete", "Pending")</code> — conditional</div>
          <div><code style="background:#f3f2f1;padding:1px 4px">ROUND(Price * 1.1, 2)</code> — round to decimals</div>
          <div style="margin-top:6px"><b>Functions:</b> IF, SUM, MIN, MAX, ROUND, ABS, CONCAT, UPPER, LOWER, LEN</div>
        </div>
      </div>
    `;
  }

  content.innerHTML = `
    <div class="modal-header">
      <h2>Edit Property</h2>
      <button class="panel-close" onclick="closeEditPropModal()"><i data-lucide="x"></i></button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:16px">
        <label style="display:block;font-size:12px;font-weight:600;color:#605e5c;margin-bottom:6px">Property Name</label>
        <input type="text" id="edit-prop-name" value="${esc(nameVal)}" placeholder="Property name" style="width:100%;height:36px;border:1px solid #8a8886;padding:0 10px;font-size:14px;outline:none" onfocus="this.style.borderColor='#0078d4'" onblur="this.style.borderColor='#8a8886'" oninput="S._editPropName=this.value">
      </div>
      <div>
        <label style="display:block;font-size:12px;font-weight:600;color:#605e5c;margin-bottom:6px">Property Type${isTitle?' <span style="font-weight:400;color:#a19f9d">(title property type cannot be changed)</span>':''}</label>
        ${isTitle ? `
          <div style="padding:10px;background:#faf9f8;border:1px solid #ddd9d7;font-size:13px;color:#605e5c">Title (primary identifier)</div>
        ` : `
        <div class="prop-type-grid">
          ${PROP_TYPES.map(pt => `
            <div class="prop-type-option${pt.type===selected?' selected':''}" onclick="selectEditPropType('${pt.type}')">
              <i data-lucide="${pt.icon}"></i>
              <span>${pt.name}</span>
            </div>
          `).join('')}
        </div>
        <div style="margin-top:8px;padding:10px;background:#faf9f8;border:1px solid #ddd9d7">
          <div style="font-size:12px;font-weight:600;color:#323130;margin-bottom:2px">${PROP_TYPES.find(pt=>pt.type===selected)?.name||'Text'}</div>
          <div style="font-size:11px;color:#605e5c">${PROP_TYPES.find(pt=>pt.type===selected)?.desc||''}</div>
        </div>
        `}
      </div>
      ${choicesHtml}
      ${editCurrencyHtml}
      ${editFormulaHtml}
    </div>
    <div class="modal-footer" style="justify-content:space-between">
      <div>${!isTitle ? `<button class="btn-danger" onclick="deleteProperty()">Delete Property</button>` : ''}</div>
      <div style="display:flex;gap:8px">
        <button class="btn-secondary" onclick="closeEditPropModal()">Cancel</button>
        <button class="btn-primary" onclick="confirmEditProperty()">Save Changes</button>
      </div>
    </div>
  `;
  renderIcons(content);
}

function selectEditPropType(type) {
  S._editPropName = document.getElementById('edit-prop-name')?.value ?? S._editPropName ?? '';
  S._editPropExpression = document.getElementById('edit-prop-formula')?.value ?? S._editPropExpression ?? '';
  S._editPropType = type;
  S._editPropColorPicker = null;
  if((type === 'select' || type === 'multi_select') && (!S._editPropChoices || S._editPropChoices.length === 0)) {
    S._editPropChoices = [
      {id:uid(), name:'Option 1', color:'blue'},
      {id:uid(), name:'Option 2', color:'green'},
      {id:uid(), name:'Option 3', color:'orange'}
    ];
  }
  renderEditPropModal();
}

function toggleEditChoiceColorPicker(idx) {
  S._editPropName = document.getElementById('edit-prop-name')?.value ?? S._editPropName ?? '';
  S._editPropColorPicker = S._editPropColorPicker === idx ? null : idx;
  renderEditPropModal();
}

function setEditChoiceColor(idx, color) {
  S._editPropName = document.getElementById('edit-prop-name')?.value ?? S._editPropName ?? '';
  if(S._editPropChoices[idx]) S._editPropChoices[idx].color = color;
  S._editPropColorPicker = null;
  renderEditPropModal();
}

function updateEditChoiceName(idx, name) {
  if(S._editPropChoices[idx]) S._editPropChoices[idx].name = name;
}

function addEditChoice() {
  S._editPropName = document.getElementById('edit-prop-name')?.value ?? S._editPropName ?? '';
  const usedColors = (S._editPropChoices||[]).map(c => c.color);
  const nextColor = CHOICE_COLORS.find(c => !usedColors.includes(c)) || CHOICE_COLORS[S._editPropChoices.length % CHOICE_COLORS.length];
  S._editPropChoices.push({id:uid(), name:'', color:nextColor});
  renderEditPropModal();
  setTimeout(() => {
    const rows = document.querySelectorAll('#edit-prop-content .choice-row input[type="text"]');
    if(rows.length) rows[rows.length-1].focus();
  }, 50);
}

function removeEditChoice(idx) {
  S._editPropName = document.getElementById('edit-prop-name')?.value ?? S._editPropName ?? '';
  S._editPropChoices.splice(idx, 1);
  S._editPropColorPicker = null;
  renderEditPropModal();
}

async function confirmEditProperty() {
  const nameEl = document.getElementById('edit-prop-name');
  const name = nameEl?.value?.trim();
  if(!name) { nameEl?.focus(); toast('Please enter a property name','error'); return; }

  const pageId = S._editPropPageId;
  const propId = S._editPropId;
  const schema = S.dbSchemas[pageId];
  if(!schema) return;
  const prop = schema.data.properties.find(p => p.id === propId);
  if(!prop) return;

  const newType = S._editPropOrigType === 'title' ? 'title' : S._editPropType;

  prop.name = name;
  prop.type = newType;

  if(newType === 'select' || newType === 'multi_select') {
    const validChoices = (S._editPropChoices||[]).filter(c => c.name.trim());
    if(validChoices.length === 0) { toast('Add at least one option','error'); return; }
    prop.options = {choices: validChoices.map(c => ({id:c.id, name:c.name.trim(), color:c.color}))};
  } else if(newType === 'currency') {
    prop.options = {currency: S._editPropCurrency || 'USD'};
  } else if(newType === 'formula') {
    const expr = (S._editPropExpression || '').trim();
    if(!expr) { toast('Please enter a formula expression','error'); return; }
    prop.options = {expression: expr};
  } else {
    prop.options = prop.options || {};
    delete prop.options.choices;
    delete prop.options.expression;
  }

  await api.update('database_schemas', schema.id, {properties:schema.data.properties});
  closeEditPropModal();
  renderDatabasePage();
  toast('Property updated');
}

async function deleteProperty() {
  if(!confirm('Delete this property? Data in this column will be lost.')) return;
  const pageId = S._editPropPageId;
  const propId = S._editPropId;
  const schema = S.dbSchemas[pageId];
  if(!schema) return;

  schema.data.properties = schema.data.properties.filter(p => p.id !== propId);
  await api.update('database_schemas', schema.id, {properties:schema.data.properties});

  // Remove from views
  for(const v of (S.dbViews[pageId]||[])) {
    if(v.data.visible_property_ids) {
      v.data.visible_property_ids = v.data.visible_property_ids.filter(id => id !== propId);
      await api.update('database_views', v.id, {visible_property_ids:v.data.visible_property_ids});
    }
  }

  closeEditPropModal();
  renderDatabasePage();
  toast('Property deleted');
}

function toggleDbFilter(e) {
  // Simple filter dialog
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  const schema = S.dbSchemas[S.currentPageId]?.data;
  if(!schema) return;
  const propName = prompt('Filter by property name:');
  if(!propName) return;
  const prop = schema.properties.find(p => p.name.toLowerCase() === propName.toLowerCase());
  if(!prop) { toast('Property not found','error'); return; }
  const value = prompt('Filter value (equals):');
  if(value === null) return;
  currentView.data.filter_rules = currentView.data.filter_rules || [];
  if(value === '') {
    currentView.data.filter_rules = currentView.data.filter_rules.filter(r => r.property_id !== prop.id);
  } else {
    currentView.data.filter_rules.push({property_id:prop.id, operator:'equals', value, conjunction:'and'});
  }
  api.update('database_views', currentView.id, {filter_rules:currentView.data.filter_rules});
  renderDatabasePage();
}

function toggleDbSort(e) {
  openSortModal();
}

function openSortModal() {
  renderSortModal();
  document.getElementById('sort-modal').classList.add('visible');
}

function closeSortModal() {
  document.getElementById('sort-modal').classList.remove('visible');
}

function renderSortModal() {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  const schema = S.dbSchemas[S.currentPageId]?.data;
  if(!schema) return;
  const props = schema.properties || [];
  const rules = currentView.data.sort_rules || [];

  let html = `<div class="modal-header"><h2>Sort</h2><button class="btn-icon" onclick="closeSortModal()"><i data-lucide="x" style="width:18px;height:18px"></i></button></div>`;
  html += `<div class="modal-body">`;

  if(rules.length === 0) {
    html += `<div class="sort-empty">No sort rules applied. Rows are in manual order.</div>`;
  } else {
    rules.forEach((rule, i) => {
      const propOpts = props.map(p => `<option value="${p.id}"${p.id===rule.property_id?' selected':''}>${esc(p.name)}</option>`).join('');
      html += `<div class="sort-rule-row">
        <span style="font-size:12px;color:#a19f9d;min-width:50px">${i===0?'Sort by':'Then by'}</span>
        <select onchange="updateSortRule(${i},'property',this.value)">${propOpts}</select>
        <select style="flex:0 0 110px" onchange="updateSortRule(${i},'direction',this.value)">
          <option value="asc"${rule.direction==='asc'?' selected':''}>Ascending</option>
          <option value="desc"${rule.direction==='desc'?' selected':''}>Descending</option>
        </select>
        <button class="sort-rule-remove" onclick="removeSortRule(${i})" title="Remove"><i data-lucide="x" style="width:14px;height:14px"></i></button>
      </div>`;
    });
  }

  html += `</div>`;
  html += `<div class="modal-footer" style="justify-content:space-between">
    <button class="btn-ghost" onclick="addSortRule()"><i data-lucide="plus" style="width:14px;height:14px"></i> Add sort</button>
    ${rules.length > 0 ? '<button class="btn-ghost" style="color:#d13438" onclick="clearSortRules()">Remove all</button>' : ''}
  </div>`;

  document.getElementById('sort-modal-content').innerHTML = html;
  renderIcons(document.getElementById('sort-modal-content'));
}

function addSortRule() {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  const schema = S.dbSchemas[S.currentPageId]?.data;
  if(!schema || !schema.properties.length) return;
  currentView.data.sort_rules = currentView.data.sort_rules || [];
  const usedIds = new Set(currentView.data.sort_rules.map(r => r.property_id));
  const nextProp = schema.properties.find(p => !usedIds.has(p.id)) || schema.properties[0];
  currentView.data.sort_rules.push({property_id:nextProp.id, direction:'asc'});
  applySortAndSave();
  renderSortModal();
}

function removeSortRule(idx) {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  currentView.data.sort_rules.splice(idx, 1);
  applySortAndSave();
  renderSortModal();
}

function clearSortRules() {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  currentView.data.sort_rules = [];
  applySortAndSave();
  renderSortModal();
}

function updateSortRule(idx, field, value) {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView || !currentView.data.sort_rules[idx]) return;
  if(field === 'property') currentView.data.sort_rules[idx].property_id = value;
  else if(field === 'direction') currentView.data.sort_rules[idx].direction = value;
  applySortAndSave();
}

function applySortAndSave() {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  api.update('database_views', currentView.id, {sort_rules:currentView.data.sort_rules});
  const dbContent = document.getElementById('db-content');
  if(dbContent) renderDatabaseContent(dbContent, S.currentPageId);
}

// ============================================================
// COLUMNS VISIBILITY MODAL
// ============================================================
function openColumnsModal() {
  renderColumnsModal();
  document.getElementById('columns-modal').classList.add('visible');
}

function closeColumnsModal() {
  document.getElementById('columns-modal').classList.remove('visible');
}

function renderColumnsModal() {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  const schema = S.dbSchemas[S.currentPageId]?.data;
  if(!schema) return;
  const props = schema.properties || [];
  const vpIds = currentView.data.visible_property_ids || props.map(p => p.id);

  let html = `<div class="modal-header"><h2>Columns</h2><button class="btn-icon" onclick="closeColumnsModal()"><i data-lucide="x" style="width:18px;height:18px"></i></button></div>`;
  html += `<div class="modal-body" style="padding:4px 0">`;

  props.forEach(p => {
    const isVisible = vpIds.includes(p.id);
    const isTitle = p.type === 'title';
    const pt = PROP_TYPES.find(t => t.type === p.type);
    const icon = pt?.icon || 'type';
    html += `<div class="col-toggle-row${isTitle ? ' disabled' : ''}">
      <span class="col-toggle-name"><i data-lucide="${icon}"></i> ${esc(p.name)}</span>
      ${isTitle ? '<span class="col-toggle-tag">Always visible</span>' : ''}
      <label class="col-toggle-switch">
        <input type="checkbox" ${isVisible ? 'checked' : ''} ${isTitle ? 'disabled' : ''} onchange="toggleColumnVisibility('${p.id}',this.checked)">
        <span class="slider"></span>
      </label>
    </div>`;
  });

  html += `</div>`;
  html += `<div class="modal-footer" style="justify-content:space-between">
    <button class="btn-ghost" onclick="showAllColumns()"><i data-lucide="eye" style="width:14px;height:14px"></i> Show all</button>
    <button class="btn-ghost" onclick="hideAllColumns()"><i data-lucide="eye-off" style="width:14px;height:14px"></i> Hide all</button>
  </div>`;

  document.getElementById('columns-modal-content').innerHTML = html;
  renderIcons(document.getElementById('columns-modal-content'));
}

function toggleColumnVisibility(propId, visible) {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  const schema = S.dbSchemas[S.currentPageId]?.data;
  const props = schema?.properties || [];
  let vpIds = currentView.data.visible_property_ids || props.map(p => p.id);

  if(visible) {
    if(!vpIds.includes(propId)) vpIds.push(propId);
  } else {
    vpIds = vpIds.filter(id => id !== propId);
  }
  // Reorder to match schema property order
  vpIds = props.filter(p => vpIds.includes(p.id)).map(p => p.id);
  currentView.data.visible_property_ids = vpIds;
  applyColumnsAndSave();
}

function showAllColumns() {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  const schema = S.dbSchemas[S.currentPageId]?.data;
  currentView.data.visible_property_ids = (schema?.properties || []).map(p => p.id);
  applyColumnsAndSave();
  renderColumnsModal();
}

function hideAllColumns() {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  const schema = S.dbSchemas[S.currentPageId]?.data;
  // Keep title column always visible
  currentView.data.visible_property_ids = (schema?.properties || []).filter(p => p.type === 'title').map(p => p.id);
  applyColumnsAndSave();
  renderColumnsModal();
}

function applyColumnsAndSave() {
  const currentView = (S.dbViews[S.currentPageId]||[]).find(v => v.id === S.currentViewId);
  if(!currentView) return;
  api.update('database_views', currentView.id, {visible_property_ids:currentView.data.visible_property_ids});
  const dbContent = document.getElementById('db-content');
  if(dbContent) renderDatabaseContent(dbContent, S.currentPageId);
}

// ============================================================
// RECORD DETAIL MODAL
// ============================================================
function openRecord(recordId, pageId) {
  S.editingRecordId = recordId;
  S.editingDbPageId = pageId;
  renderRecordModal();
  document.getElementById('record-modal').classList.add('visible');
}

function closeRecordModal() {
  document.getElementById('record-modal').classList.remove('visible');
  S.editingRecordId = null;
  S.editingDbPageId = null;
}

function renderRecordModal() {
  const container = document.getElementById('record-content');
  if(!container || !S.editingRecordId || !S.editingDbPageId) return;
  const record = (S.dbRecords[S.editingDbPageId]||[]).find(r => r.id === S.editingRecordId);
  const schema = S.dbSchemas[S.editingDbPageId]?.data;
  if(!record || !schema) return;

  const props = schema.properties || [];
  const titleProp = props.find(p => p.type === 'title');
  const title = record.data.values?.[titleProp?.id] || 'Untitled';

  const titleLabel = titleProp?.name || 'Title';
  let html = `<div class="modal-header" style="flex-direction:column;align-items:stretch;gap:0;padding:16px 16px 12px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <span style="font-size:11px;font-weight:600;color:#a19f9d;text-transform:uppercase;letter-spacing:0.5px">${esc(titleLabel)}</span>
      <button class="panel-close" onclick="closeRecordModal()"><i data-lucide="x"></i></button>
    </div>
    <div style="position:relative">
      <input type="text" value="${esc(typeof title==='string'?title:String(title))}" id="rec-prop-${titleProp?.id}" style="border:1px solid #d2d0ce;font-size:20px;font-weight:600;width:100%;outline:none;padding:8px 36px 8px 10px;background:#faf9f8;color:#323130;transition:border-color 100ms,background 100ms" onfocus="this.style.borderColor='#0078d4';this.style.background='#fff'" onblur="this.style.borderColor='#d2d0ce';this.style.background='#faf9f8'" oninput="updateRecordValue('${titleProp?.id}',this.value)" placeholder="Enter ${titleLabel.toLowerCase()} name...">
      <i data-lucide="pencil" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:#a19f9d;pointer-events:none"></i>
    </div>
  </div>`;
  html += '<div class="modal-body"><div class="record-props">';

  props.forEach(p => {
    if(p.type === 'title') return; // Title is shown in header above
    const val = record.data.values?.[p.id];
    html += `<div class="record-prop"><div class="record-prop-label">${esc(p.name)}</div><div class="record-prop-value">${renderRecordInput(p, val, record, props)}</div></div>`;
  });

  html += '</div></div>';
  html += `<div class="modal-footer">
    <button class="btn-danger" onclick="deleteRecord()">Delete</button>
    <button class="btn-primary" onclick="saveRecord()">Save</button>
  </div>`;

  container.innerHTML = html;
  renderIcons(container);
}

function renderRecordInput(prop, val, record, allProps) {
  const id = `rec-prop-${prop.id}`;
  switch(prop.type) {
    case 'formula': {
      if(!record || !allProps || !prop.options?.expression)
        return `<span style="font-size:13px;color:#a19f9d;font-style:italic">No formula</span>`;
      const result = evaluateFormula(prop.options.expression, record, allProps);
      return `<div style="padding:6px 0;font-size:13px;color:#605e5c;min-height:20px">${esc(result !== '' && result != null ? String(result) : '')}</div>`;
    }
    case 'title':
    case 'text':
    case 'url':
    case 'email':
    case 'phone':
      return `<input type="text" id="${id}" value="${esc(val||'')}" oninput="updateRecordValue('${prop.id}',this.value)">`;
    case 'number':
      return `<input type="number" id="${id}" value="${val||''}" oninput="updateRecordValue('${prop.id}',parseFloat(this.value))">`;
    case 'select':
      const choices = prop.options?.choices || [];
      const selected = val?.selected || val || '';
      return `<select id="${id}" onchange="updateRecordValue('${prop.id}',{selected:this.value})">
        <option value="">-- Select --</option>
        ${choices.map(c => `<option value="${esc(c.name)}"${c.name===selected?' selected':''}>${esc(c.name)}</option>`).join('')}
      </select>`;
    case 'multi_select':
      const ms = val?.selected || val || [];
      const msChoices = prop.options?.choices || [];
      return msChoices.map(c => {
        const checked = Array.isArray(ms) && ms.includes(c.name);
        return `<label style="display:inline-flex;align-items:center;gap:4px;margin-right:8px;font-size:12px">
          <input type="checkbox" ${checked?'checked':''} onchange="toggleMultiSelect('${prop.id}','${esc(c.name)}',this.checked)"> ${esc(c.name)}</label>`;
      }).join('');
    case 'date':
      const dv = val?.start || val || '';
      return `<input type="date" id="${id}" value="${esc(dv)}" onchange="updateRecordValue('${prop.id}',{start:this.value})">`;
    case 'checkbox':
      return `<input type="checkbox" id="${id}" ${val?'checked':''} onchange="updateRecordValue('${prop.id}',this.checked)">`;
    case 'currency':
      const curOpt = prop.options?.currency || 'USD';
      const curInfo = CURRENCIES.find(c => c.code === curOpt) || CURRENCIES[0];
      return `<div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:13px;color:#605e5c;font-weight:600;min-width:24px">${curInfo.symbol}</span>
        <input type="number" id="${id}" value="${val||''}" step="0.01" oninput="updateRecordValue('${prop.id}',parseFloat(this.value))" style="flex:1">
      </div>`;
    case 'files':
      const fileList = Array.isArray(val) ? val : [];
      return `<div id="${id}" data-prop-type="files">
        <div class="file-list">
          ${fileList.map((f, fi) => `
            <div class="file-item">
              <span class="file-item-icon"><i data-lucide="${getFileIcon(f.content_type||f.filename)}" style="width:16px;height:16px"></i></span>
              <span class="file-item-name" onclick="openFileUrl('${f.file_id||''}','${esc(f.url||'')}')">${esc(f.filename||'file')}</span>
              <span class="file-item-size">${formatFileSize(f.size)}</span>
              <span class="file-item-remove" onclick="removeRecordFile('${prop.id}',${fi})" title="Remove file"><i data-lucide="x" style="width:12px;height:12px"></i></span>
            </div>
          `).join('')}
        </div>
        <label class="file-upload-btn" id="file-upload-${prop.id}">
          <i data-lucide="upload" style="width:14px;height:14px"></i> Upload file
          <input type="file" style="display:none" onchange="uploadRecordFile('${prop.id}',this.files)" multiple>
        </label>
      </div>`;
    default:
      return `<input type="text" id="${id}" value="${esc(val!=null?String(val):'')}" oninput="updateRecordValue('${prop.id}',this.value)">`;
  }
}

function updateRecordValue(propId, value) {
  const record = (S.dbRecords[S.editingDbPageId]||[]).find(r => r.id === S.editingRecordId);
  if(!record) return;
  if(!record.data.values) record.data.values = {};
  record.data.values[propId] = value;
}

function toggleMultiSelect(propId, name, checked) {
  const record = (S.dbRecords[S.editingDbPageId]||[]).find(r => r.id === S.editingRecordId);
  if(!record) return;
  if(!record.data.values) record.data.values = {};
  let current = record.data.values[propId]?.selected || record.data.values[propId] || [];
  if(!Array.isArray(current)) current = [];
  if(checked) { if(!current.includes(name)) current.push(name); }
  else { current = current.filter(c => c !== name); }
  record.data.values[propId] = {selected: current};
}

// ============================================================
// FILE UPLOAD HELPERS
// ============================================================
function getFileIcon(nameOrType) {
  const s = (nameOrType || '').toLowerCase();
  if(s.includes('image') || /\.(jpg|jpeg|png|gif|svg|webp)$/i.test(s)) return 'image';
  if(s.includes('pdf') || /\.pdf$/i.test(s)) return 'file-text';
  if(s.includes('video') || /\.(mp4|mov|avi|webm)$/i.test(s)) return 'film';
  if(s.includes('audio') || /\.(mp3|wav|ogg)$/i.test(s)) return 'music';
  if(s.includes('zip') || /\.(zip|rar|gz|tar)$/i.test(s)) return 'archive';
  if(s.includes('sheet') || /\.(xlsx|csv|xls)$/i.test(s)) return 'table';
  if(s.includes('presentation') || /\.(pptx|ppt)$/i.test(s)) return 'presentation';
  if(s.includes('word') || /\.(docx|doc)$/i.test(s)) return 'file-text';
  return 'file';
}

function openFileUrl(fileId, fallbackUrl) {
  let url = fallbackUrl;
  if(fileId && typeof TeamData !== 'undefined') url = TeamData.getDownloadUrl(fileId);
  if(url) window.open(url, '_blank');
}

function formatFileSize(bytes) {
  if(!bytes && bytes !== 0) return '';
  if(bytes < 1024) return bytes + ' B';
  if(bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(1) + ' MB';
}

async function uploadRecordFile(propId, fileList) {
  if(!fileList || fileList.length === 0) return;
  const record = (S.dbRecords[S.editingDbPageId]||[]).find(r => r.id === S.editingRecordId);
  if(!record) return;
  if(!record.data.values) record.data.values = {};
  if(!Array.isArray(record.data.values[propId])) record.data.values[propId] = [];

  const uploadBtn = document.getElementById(`file-upload-${propId}`);
  if(uploadBtn) { uploadBtn.classList.add('uploading'); uploadBtn.querySelector('input').disabled = true; }

  for(const file of fileList) {
    try {
      const result = await TeamData.uploadFile(file);
      const downloadUrl = TeamData.getDownloadUrl(result.id);
      record.data.values[propId].push({
        file_id: result.id,
        filename: result.filename,
        content_type: result.content_type,
        size: result.size,
        url: downloadUrl
      });
    } catch(e) {
      toast('Upload failed: ' + e.message, 'error');
    }
  }

  if(uploadBtn) { uploadBtn.classList.remove('uploading'); uploadBtn.querySelector('input').disabled = false; }
  renderRecordModal();
  renderIcons(document.getElementById('record-content'));
}

function removeRecordFile(propId, fileIdx) {
  const record = (S.dbRecords[S.editingDbPageId]||[]).find(r => r.id === S.editingRecordId);
  if(!record) return;
  const files = record.data.values?.[propId];
  if(!Array.isArray(files) || !files[fileIdx]) return;

  const file = files[fileIdx];
  files.splice(fileIdx, 1);
  record.data.values[propId] = files;

  // Delete file from server (best-effort, don't block UI)
  if(file.file_id) {
    TeamData.deleteFile(file.file_id).catch(()=>{});
  }

  renderRecordModal();
  renderIcons(document.getElementById('record-content'));
}

async function saveRecord() {
  const record = (S.dbRecords[S.editingDbPageId]||[]).find(r => r.id === S.editingRecordId);
  if(!record) return;
  if(!record.data.values) record.data.values = {};
  // Collect current values from DOM inputs before saving
  const schema = S.dbSchemas[S.editingDbPageId]?.data;
  if(schema) {
    (schema.properties || []).forEach(p => {
      const el = document.getElementById(`rec-prop-${p.id}`);
      if(!el) return;
      switch(p.type) {
        case 'title': case 'text': case 'url': case 'email': case 'phone':
          record.data.values[p.id] = el.value;
          break;
        case 'number':
        case 'currency':
          record.data.values[p.id] = el.value ? parseFloat(el.value) : null;
          break;
        case 'select':
          record.data.values[p.id] = el.value ? {selected: el.value} : null;
          break;
        case 'date':
          record.data.values[p.id] = el.value ? {start: el.value} : null;
          break;
        case 'checkbox':
          record.data.values[p.id] = el.checked;
          break;
        case 'files':
        case 'multi_select':
          // Managed via state (updateRecordValue), not DOM
          break;
        case 'formula':
          // Computed property, not persisted
          break;
      }
    });
  }
  await api.update('database_records', record.id, record.data);
  closeRecordModal();
  renderDatabasePage();
  toast('Record saved');
}

async function deleteRecord() {
  if(!confirm('Delete this record?')) return;
  await api.delete('database_records', S.editingRecordId);
  S.dbRecords[S.editingDbPageId] = (S.dbRecords[S.editingDbPageId]||[]).filter(r => r.id !== S.editingRecordId);
  closeRecordModal();
  renderDatabasePage();
  toast('Record deleted');
}
// ============================================================
// RIGHT PANELS (COMMENTS & HISTORY)
// ============================================================
function togglePanel(panel) {
  const rp = document.getElementById('right-panel');
  if(S.rightPanel === panel) {
    S.rightPanel = null;
    rp.classList.remove('open');
  } else {
    S.rightPanel = panel;
    rp.classList.add('open');
    if(panel === 'comments') renderCommentsPanel();
    else if(panel === 'history') renderHistoryPanel();
  }
  renderTopbar();
}

async function renderCommentsPanel() {
  const rp = document.getElementById('right-panel');
  if(!rp || !S.currentPageId) return;

  // Load comments
  try {
    const res = await api.list('comments', {where:{page_id:S.currentPageId}, orderBy:'created_at', order:'desc'});
    S.comments = res.records || [];
  } catch(e) { S.comments = []; }

  const topLevel = S.comments.filter(c => !c.data.parent_comment_id && !c.data.is_resolved);
  const resolved = S.comments.filter(c => !c.data.parent_comment_id && c.data.is_resolved);

  rp.innerHTML = `
    <div class="panel-header">
      <span class="panel-header-title">Comments</span>
      <button class="panel-close" onclick="togglePanel('comments')"><i data-lucide="x"></i></button>
    </div>
    <div class="panel-body">
      ${topLevel.length === 0 && resolved.length === 0 ? '<div style="text-align:center;color:#a19f9d;padding:20px">No comments yet</div>' : ''}
      ${topLevel.map(c => renderComment(c)).join('')}
      ${resolved.length > 0 ? `
        <div style="margin-top:16px;border-top:1px solid #ddd9d7;padding-top:8px">
          <div style="font-size:11px;color:#a19f9d;font-weight:600;text-transform:uppercase;margin-bottom:8px">Resolved (${resolved.length})</div>
          ${resolved.map(c => renderComment(c, true)).join('')}
        </div>
      ` : ''}
    </div>
    <div class="panel-footer">
      <textarea class="comment-input" id="comment-input" placeholder="Add a comment..."></textarea>
      <button class="comment-submit" onclick="addComment()">Comment</button>
    </div>
  `;
  renderIcons(rp);
  renderTopbar();
}

function renderComment(comment, isResolved) {
  const d = comment.data;
  const author = comment.createdBy?.username || 'Unknown';
  const initial = author.charAt(0).toUpperCase();
  const replies = S.comments.filter(c => c.data.parent_comment_id === comment.id);
  const content = rtToHtml(d.content) || esc(String(d.content || ''));

  return `<div class="comment-item${isResolved?' comment-resolved':''}">
    <div class="comment-author">
      <span class="comment-avatar">${initial}</span>
      <span class="comment-name">${esc(author)}</span>
      <span class="comment-time">${relTime(comment.createdAt)}</span>
    </div>
    <div class="comment-body">${content}</div>
    <div class="comment-actions">
      <button onclick="replyToComment('${comment.id}')">Reply</button>
      ${!isResolved ? `<button onclick="resolveComment('${comment.id}')">Resolve</button>` : `<button onclick="unresolveComment('${comment.id}')">Unresolve</button>`}
      ${comment.createdBy?.id === S.user?.id ? `<button onclick="deleteComment('${comment.id}')">Delete</button>` : ''}
    </div>
    ${replies.map(r => `
      <div style="margin-left:30px;margin-top:8px">
        <div class="comment-author">
          <span class="comment-avatar" style="width:20px;height:20px;font-size:9px">${(r.createdBy?.username||'U').charAt(0).toUpperCase()}</span>
          <span class="comment-name">${esc(r.createdBy?.username||'Unknown')}</span>
          <span class="comment-time">${relTime(r.createdAt)}</span>
        </div>
        <div class="comment-body" style="margin-left:26px">${rtToHtml(r.data.content) || esc(String(r.data.content||''))}</div>
      </div>
    `).join('')}
  </div>`;
}

async function addComment() {
  const input = document.getElementById('comment-input');
  if(!input || !input.value.trim()) return;
  await api.create('comments', {
    page_id: S.currentPageId,
    content: plainRt(input.value.trim()),
    is_resolved: false
  });
  input.value = '';
  renderCommentsPanel();
  toast('Comment added');
}

async function replyToComment(parentId) {
  const text = prompt('Reply:');
  if(!text) return;
  await api.create('comments', {
    page_id: S.currentPageId,
    parent_comment_id: parentId,
    content: plainRt(text),
    is_resolved: false
  });
  renderCommentsPanel();
}

async function resolveComment(commentId) {
  const c = S.comments.find(c => c.id === commentId);
  if(!c) return;
  await api.update('comments', commentId, {is_resolved:true, resolved_by_user_id:S.user?.id, resolved_at:new Date().toISOString()});
  renderCommentsPanel();
}

async function unresolveComment(commentId) {
  await api.update('comments', commentId, {is_resolved:false, resolved_by_user_id:null, resolved_at:null});
  renderCommentsPanel();
}

async function deleteComment(commentId) {
  if(!confirm('Delete this comment?')) return;
  await api.delete('comments', commentId);
  renderCommentsPanel();
}

async function renderHistoryPanel() {
  const rp = document.getElementById('right-panel');
  if(!rp || !S.currentPageId) return;

  let history = [];
  try {
    const res = await api.list('page_history', {where:{page_id:S.currentPageId}, orderBy:'created_at', order:'desc', limit:20});
    history = res.records || [];
  } catch(e) {}

  rp.innerHTML = `
    <div class="panel-header">
      <span class="panel-header-title">Version History</span>
      <button class="panel-close" onclick="togglePanel('history')"><i data-lucide="x"></i></button>
    </div>
    <div class="panel-body">
      <div style="margin-bottom:12px;font-size:12px;color:#605e5c">
        <div style="padding:8px;background:#f0f6ff;border:1px solid #d0e7f5;margin-bottom:8px">
          <strong>Current Version</strong><br>
          <span style="font-size:11px;color:#a19f9d">${S.currentPage?.data.last_edited_by_username ? 'By ' + esc(S.currentPage.data.last_edited_by_username) : ''} ${relTime(S.currentPage?.updatedAt)}</span>
        </div>
      </div>
      ${history.length === 0 ? '<div style="text-align:center;color:#a19f9d;padding:20px">No version history yet</div>' : ''}
      ${history.map(h => `
        <div style="padding:8px;border-bottom:1px solid #ddd9d7;cursor:pointer" onclick="restoreVersion('${h.id}')">
          <div style="font-size:12px;font-weight:600">${esc(h.data.edit_description || 'Edit')}</div>
          <div style="font-size:11px;color:#a19f9d">${esc(h.data.edited_by_username || 'Unknown')} · ${relTime(h.createdAt)}</div>
        </div>
      `).join('')}
    </div>
  `;
  renderIcons(rp);
}

async function restoreVersion(historyId) {
  if(!confirm('Restore this version? Current content will be overwritten.')) return;
  try {
    const h = await api.get('page_history', historyId);
    if(h?.data?.snapshot_blocks) {
      S.currentPage.data.content_blocks = h.data.snapshot_blocks;
      S.currentPage.data.title = h.data.snapshot_title || S.currentPage.data.title;
      await api.update('pages', S.currentPageId, {
        content_blocks: S.currentPage.data.content_blocks,
        title: S.currentPage.data.title
      });
      renderPage();
      toast('Version restored');
    }
  } catch(e) { toast('Failed to restore','error'); }
}

// ============================================================
// TRASH VIEW
// ============================================================
function showTrash() {
  S.trashView = true;
  S.currentPageId = null;
  S.currentPage = null;
  renderPage();
  renderTopbar();
  renderSidebar();
}

function renderTrashView(area) {
  const archived = S.pages.filter(p => p.data.is_archived);
  area.innerHTML = `
    <div class="page-header">
      <h1 style="font-size:24px;font-weight:600;margin-bottom:16px">Trash</h1>
      <p style="font-size:13px;color:#605e5c;margin-bottom:24px">Archived pages are kept for ${S.settings?.data?.trash_retention_days||30} days before permanent deletion.</p>
    </div>
    <div class="page-content">
      ${archived.length === 0 ? '<div class="empty-state"><i data-lucide="trash-2"></i><p>Trash is empty</p></div>' : `
        <table class="trash-table">
          <thead><tr><th>Page</th><th>Archived by</th><th>Archived at</th><th>Actions</th></tr></thead>
          <tbody>
            ${archived.map(p => `<tr>
              <td>${p.data.icon||'📄'} ${esc(p.data.title||'Untitled')}</td>
              <td>${esc(p.data.archived_by||'Unknown')}</td>
              <td>${relTime(p.data.archived_at)}</td>
              <td>
                <button class="btn-ghost" onclick="restorePage('${p.id}')">Restore</button>
                <button class="btn-ghost" style="color:#d13438" onclick="permanentlyDelete('${p.id}')">Delete</button>
              </td>
            </tr>`).join('')}
          </tbody>
        </table>
      `}
    </div>
  `;
  renderIcons(area);
}

async function restorePage(pageId) {
  const page = S.pages.find(p => p.id === pageId);
  if(!page) return;
  page.data.is_archived = false;
  page.data.archived_at = null;
  page.data.archived_by = null;
  await api.update('pages', pageId, {is_archived:false, archived_at:null, archived_by:null});
  renderPage();
  renderSidebar();
  toast('Page restored');
}

async function permanentlyDelete(pageId) {
  if(!confirm('Permanently delete this page? This cannot be undone.')) return;
  await api.delete('pages', pageId);
  S.pages = S.pages.filter(p => p.id !== pageId);
  renderPage();
  renderSidebar();
  toast('Page permanently deleted');
}
// ============================================================
// SEARCH MODAL
// ============================================================
function openSearch() {
  const modal = document.getElementById('search-modal');
  modal.classList.add('visible');
  const content = document.getElementById('search-content');
  content.innerHTML = `
    <input type="text" class="search-input" id="search-input" placeholder="Search pages, databases, and more..." oninput="performSearch(this.value)" autofocus>
    <div class="search-results" id="search-results">
      <div class="search-empty">Type to search</div>
    </div>
  `;
  setTimeout(() => document.getElementById('search-input')?.focus(), 100);
}

function closeSearch() {
  document.getElementById('search-modal').classList.remove('visible');
}

function performSearch(query) {
  const results = document.getElementById('search-results');
  if(!query.trim()) {
    // Show recent pages
    const recent = S.pages.filter(p => !p.data.is_archived && !p.data.is_template).slice(0,8);
    results.innerHTML = recent.length ? `
      <div class="search-result-group">
        <div class="search-result-group-title">Recent Pages</div>
        ${recent.map(p => searchResultItem(p)).join('')}
      </div>
    ` : '<div class="search-empty">Type to search</div>';
    return;
  }

  const q = query.toLowerCase();
  const pages = S.pages.filter(p => {
    if(p.data.is_archived || p.data.is_template) return false;
    const title = (p.data.title||'').toLowerCase();
    if(title.includes(q)) return true;
    const blocks = p.data.content_blocks || [];
    return blocks.some(b => rtToText(b.content).toLowerCase().includes(q));
  });

  // Search database records
  const dbResults = [];
  Object.entries(S.dbRecords).forEach(([pageId, records]) => {
    records.forEach(r => {
      if(r.data.is_archived) return;
      const vals = Object.values(r.data.values || {});
      if(vals.some(v => String(v?.selected || v || '').toLowerCase().includes(q))) {
        const dbPage = S.pages.find(p => p.id === pageId);
        dbResults.push({record:r, dbPage});
      }
    });
  });

  let html = '';
  if(pages.length > 0) {
    html += `<div class="search-result-group">
      <div class="search-result-group-title">Pages (${pages.length})</div>
      ${pages.map(p => searchResultItem(p)).join('')}
    </div>`;
  }
  if(dbResults.length > 0) {
    html += `<div class="search-result-group">
      <div class="search-result-group-title">Database Records (${dbResults.length})</div>
      ${dbResults.map(({record,dbPage}) => `
        <div class="search-result-item" onclick="closeSearch();navigateTo('${dbPage?.id||''}');setTimeout(()=>openRecord('${record.id}','${dbPage?.id||''}'),500)">
          <span class="result-icon">🗃️</span>
          <div class="result-info">
            <div class="result-title">${esc(Object.values(record.data.values||{})[0]?.toString()||'Record')}</div>
            <div class="result-path">${esc(dbPage?.data?.title||'Database')}</div>
          </div>
        </div>
      `).join('')}
    </div>`;
  }
  if(!html) html = '<div class="search-empty">No results found</div>';
  results.innerHTML = html;
  renderIcons(results);
}

function searchResultItem(page) {
  const d = page.data;
  const icon = d.icon || (d.page_type === 'database' ? '🗃️' : '📄');
  const breadcrumbs = getBreadcrumbs(page.id).map(b => b.title || 'Untitled').join(' / ');
  return `<div class="search-result-item" onclick="closeSearch();navigateTo('${page.id}')">
    <span class="result-icon">${icon}</span>
    <div class="result-info">
      <div class="result-title">${esc(d.title || 'Untitled')}</div>
      <div class="result-path">${esc(breadcrumbs)}</div>
    </div>
  </div>`;
}

// ============================================================
// TEMPLATE GALLERY
// ============================================================
const BUILT_IN_TEMPLATES = [
  {
    title:'Blank Page', icon:'📄', category:'blank', page_type:'page',
    description:'Start from scratch with an empty page.',
    content_blocks:[{id:'tpl-1',type:'paragraph',content:[],properties:{},children:[],indent_level:0}]
  },
  {
    title:'Meeting Notes', icon:'📝', category:'meeting_notes', page_type:'page',
    description:'Template for meeting agendas and notes.',
    content_blocks:[
      {id:'tpl-mn1',type:'heading_2',content:plainRt('Meeting Details'),properties:{},children:[],indent_level:0},
      {id:'tpl-mn2',type:'callout',content:plainRt('Date: [date] | Attendees: [names]'),properties:{icon:'📅',color:'blue'},children:[],indent_level:0},
      {id:'tpl-mn3',type:'heading_2',content:plainRt('Agenda'),properties:{},children:[],indent_level:0},
      {id:'tpl-mn4',type:'to_do',content:plainRt('Agenda item 1'),properties:{checked:false},children:[],indent_level:0},
      {id:'tpl-mn5',type:'to_do',content:plainRt('Agenda item 2'),properties:{checked:false},children:[],indent_level:0},
      {id:'tpl-mn6',type:'heading_2',content:plainRt('Discussion Notes'),properties:{},children:[],indent_level:0},
      {id:'tpl-mn7',type:'paragraph',content:[],properties:{},children:[],indent_level:0},
      {id:'tpl-mn8',type:'heading_2',content:plainRt('Action Items'),properties:{},children:[],indent_level:0},
      {id:'tpl-mn9',type:'to_do',content:plainRt('Action item - @assignee - due date'),properties:{checked:false},children:[],indent_level:0},
    ]
  },
  {
    title:'Wiki Page', icon:'📚', category:'wiki', page_type:'page',
    description:'Documentation page with table of contents.',
    content_blocks:[
      {id:'tpl-w1',type:'callout',content:plainRt('This is a wiki page. Use headings to organize content and create a clear structure.'),properties:{icon:'💡',color:'blue'},children:[],indent_level:0},
      {id:'tpl-w2',type:'heading_1',content:plainRt('Overview'),properties:{},children:[],indent_level:0},
      {id:'tpl-w3',type:'paragraph',content:plainRt('Brief description of this topic.'),properties:{},children:[],indent_level:0},
      {id:'tpl-w4',type:'heading_2',content:plainRt('Key Concepts'),properties:{},children:[],indent_level:0},
      {id:'tpl-w5',type:'toggle',content:plainRt('Concept 1'),properties:{open:false},children:[{id:'tpl-w5a',type:'paragraph',content:plainRt('Details about concept 1...'),properties:{},children:[],indent_level:0}],indent_level:0},
      {id:'tpl-w6',type:'toggle',content:plainRt('Concept 2'),properties:{open:false},children:[{id:'tpl-w6a',type:'paragraph',content:plainRt('Details about concept 2...'),properties:{},children:[],indent_level:0}],indent_level:0},
      {id:'tpl-w7',type:'heading_2',content:plainRt('Resources'),properties:{},children:[],indent_level:0},
      {id:'tpl-w8',type:'bulleted_list',content:plainRt('Resource 1'),properties:{},children:[],indent_level:0},
      {id:'tpl-w9',type:'bulleted_list',content:plainRt('Resource 2'),properties:{},children:[],indent_level:0},
    ]
  },
  {
    title:'Engineering Spec', icon:'🔧', category:'engineering', page_type:'page',
    description:'Technical specification template.',
    content_blocks:[
      {id:'tpl-e1',type:'heading_1',content:plainRt('Technical Specification'),properties:{},children:[],indent_level:0},
      {id:'tpl-e2',type:'heading_2',content:plainRt('Overview'),properties:{},children:[],indent_level:0},
      {id:'tpl-e3',type:'paragraph',content:plainRt('Brief description of what this spec covers.'),properties:{},children:[],indent_level:0},
      {id:'tpl-e4',type:'heading_2',content:plainRt('Goals'),properties:{},children:[],indent_level:0},
      {id:'tpl-e5',type:'bulleted_list',content:plainRt('Goal 1'),properties:{},children:[],indent_level:0},
      {id:'tpl-e6',type:'heading_2',content:plainRt('Non-Goals'),properties:{},children:[],indent_level:0},
      {id:'tpl-e7',type:'bulleted_list',content:plainRt('Non-goal 1'),properties:{},children:[],indent_level:0},
      {id:'tpl-e8',type:'heading_2',content:plainRt('Technical Design'),properties:{},children:[],indent_level:0},
      {id:'tpl-e9',type:'toggle',content:plainRt('Architecture'),properties:{open:true},children:[{id:'tpl-e9a',type:'paragraph',content:plainRt('Describe the architecture...'),properties:{},children:[],indent_level:0}],indent_level:0},
      {id:'tpl-e10',type:'heading_2',content:plainRt('Open Questions'),properties:{},children:[],indent_level:0},
      {id:'tpl-e11',type:'callout',content:plainRt('List open questions here'),properties:{icon:'❓',color:'yellow'},children:[],indent_level:0},
      {id:'tpl-e12',type:'heading_2',content:plainRt('Timeline'),properties:{},children:[],indent_level:0},
      {id:'tpl-e13',type:'to_do',content:plainRt('Phase 1 - [date]'),properties:{checked:false},children:[],indent_level:0},
      {id:'tpl-e14',type:'to_do',content:plainRt('Phase 2 - [date]'),properties:{checked:false},children:[],indent_level:0},
    ]
  },
  {
    title:'Project Tracker', icon:'🎯', category:'project', page_type:'database',
    description:'Track projects with status, priority, and assignments.',
    database_schema:{
      properties:[
        {id:'pt-title',name:'Task',type:'title',options:{},sort_order:0,visible:true,width:250},
        {id:'pt-status',name:'Status',type:'select',options:{choices:[
          {id:'s1',name:'Not Started',color:'light_gray'},{id:'s2',name:'In Progress',color:'blue'},
          {id:'s3',name:'Done',color:'green'}
        ]},sort_order:1,visible:true,width:140},
        {id:'pt-priority',name:'Priority',type:'select',options:{choices:[
          {id:'p1',name:'Low',color:'gray'},{id:'p2',name:'Medium',color:'yellow'},
          {id:'p3',name:'High',color:'orange'},{id:'p4',name:'Urgent',color:'red'}
        ]},sort_order:2,visible:true,width:120},
        {id:'pt-due',name:'Due Date',type:'date',options:{include_time:false},sort_order:3,visible:true,width:140},
        {id:'pt-notes',name:'Notes',type:'text',options:{},sort_order:4,visible:true,width:200}
      ],
      title_property_id:'pt-title'
    }
  },
  {
    title:'Sprint Board', icon:'🏃', category:'engineering', page_type:'database',
    description:'Kanban board for sprint management.',
    database_schema:{
      properties:[
        {id:'sb-title',name:'Story',type:'title',options:{},sort_order:0,visible:true,width:250},
        {id:'sb-status',name:'Status',type:'select',options:{choices:[
          {id:'ss1',name:'Backlog',color:'light_gray'},{id:'ss2',name:'To Do',color:'gray'},
          {id:'ss3',name:'In Progress',color:'blue'},{id:'ss4',name:'In Review',color:'purple'},
          {id:'ss5',name:'Done',color:'green'}
        ]},sort_order:1,visible:true,width:140},
        {id:'sb-points',name:'Points',type:'number',options:{format:'number'},sort_order:2,visible:true,width:80},
        {id:'sb-sprint',name:'Sprint',type:'select',options:{choices:[
          {id:'sp1',name:'Sprint 1',color:'blue'},{id:'sp2',name:'Sprint 2',color:'green'}
        ]},sort_order:3,visible:true,width:120}
      ],
      title_property_id:'sb-title'
    }
  },
  {
    title:'Content Calendar', icon:'📅', category:'marketing', page_type:'database',
    description:'Plan and track content across channels.',
    database_schema:{
      properties:[
        {id:'cc-title',name:'Content',type:'title',options:{},sort_order:0,visible:true,width:250},
        {id:'cc-date',name:'Publish Date',type:'date',options:{include_time:false},sort_order:1,visible:true,width:140},
        {id:'cc-channel',name:'Channel',type:'select',options:{choices:[
          {id:'ch1',name:'Blog',color:'blue'},{id:'ch2',name:'Social',color:'pink'},
          {id:'ch3',name:'Email',color:'green'},{id:'ch4',name:'Video',color:'red'}
        ]},sort_order:2,visible:true,width:120},
        {id:'cc-status',name:'Status',type:'select',options:{choices:[
          {id:'cs1',name:'Draft',color:'light_gray'},{id:'cs2',name:'Review',color:'yellow'},
          {id:'cs3',name:'Scheduled',color:'blue'},{id:'cs4',name:'Published',color:'green'}
        ]},sort_order:3,visible:true,width:120}
      ],
      title_property_id:'cc-title'
    }
  }
];

function openTemplates() {
  const modal = document.getElementById('template-modal');
  modal.classList.add('visible');
  const content = document.getElementById('template-content');

  const categories = {};
  BUILT_IN_TEMPLATES.forEach(t => {
    const cat = t.category || 'other';
    if(!categories[cat]) categories[cat] = [];
    categories[cat].push(t);
  });

  const catNames = {
    blank:'Getting Started', meeting_notes:'Meetings', wiki:'Documentation',
    engineering:'Engineering', project:'Projects', marketing:'Marketing'
  };

  let html = `<div class="modal-header"><h2>Templates</h2><button class="panel-close" onclick="closeTemplates()"><i data-lucide="x"></i></button></div>`;
  html += '<div class="modal-body">';
  Object.entries(categories).forEach(([cat, templates]) => {
    html += `<div class="template-category-title">${catNames[cat]||cat}</div>`;
    html += '<div class="template-grid">';
    templates.forEach((t,i) => {
      html += `<div class="template-card" onclick="useTemplate(${BUILT_IN_TEMPLATES.indexOf(t)})">
        <div class="template-card-icon">${t.icon}</div>
        <div class="template-card-title">${esc(t.title)}</div>
        <div class="template-card-desc">${esc(t.description)}</div>
      </div>`;
    });
    html += '</div>';
  });
  html += '</div>';

  content.innerHTML = html;
  renderIcons(content);
}

function closeTemplates() {
  document.getElementById('template-modal').classList.remove('visible');
}

async function useTemplate(idx) {
  const tpl = BUILT_IN_TEMPLATES[idx];
  if(!tpl) return;
  closeTemplates();

  if(tpl.page_type === 'database') {
    await createNewDatabaseFromTemplate(tpl);
  } else {
    const blocks = JSON.parse(JSON.stringify(tpl.content_blocks || []));
    // Generate new IDs
    const reId = (blocks) => { blocks.forEach(b => { b.id = uid(); if(b.children) reId(b.children); }); };
    reId(blocks);
    const pageData = {
      title: tpl.title, icon: tpl.icon, page_type:'page',
      content_blocks: blocks, parent_page_id: null,
      is_archived:false, sort_order: S.pages.length,
      full_width:false, small_text:false, font:'sans'
    };
    const rec = await api.create('pages', pageData);
    S.pages.push(rec);
    // User identity obtained from TeamData.getCurrentUser() at init
    navigateTo(rec.id);
    renderSidebar();
    toast('Page created from template');
  }
}

async function createNewDatabaseFromTemplate(tpl) {
  const dbCount = S.pages.filter(p => p.data.page_type === 'database' && !p.data.is_archived).length;
  if(dbCount >= PLAN.maxTables) {
    if(PLAN.showUpgrade) {
      showUpgradeModal('Table limit reached', `The Free plan supports up to ${PLAN.maxTables} tables. Upgrade to Pro for up to 1,000 tables and 10,000 rows per table.`);
    }
    return;
  }
  const schema = JSON.parse(JSON.stringify(tpl.database_schema));
  // Generate new property IDs
  const idMap = {};
  schema.properties.forEach(p => {
    const oldId = p.id;
    p.id = uid();
    idMap[oldId] = p.id;
    if(p.options?.choices) p.options.choices.forEach(c => { c.id = uid(); });
  });
  schema.title_property_id = idMap[schema.title_property_id] || schema.properties[0]?.id;

  const pageData = {
    title: tpl.title, icon: tpl.icon, page_type:'database',
    content_blocks:[], parent_page_id:null,
    is_archived:false, sort_order: S.pages.length,
    full_width:true, small_text:false, font:'sans'
  };
  const pageRec = await api.create('pages', pageData);
  S.pages.push(pageRec);
  // User identity obtained from TeamData.getCurrentUser() at init

  schema.page_id = pageRec.id;
  await api.create('database_schemas', schema);

  // Create default views
  const viewProps = schema.properties.map(p => p.id);
  await api.create('database_views', {
    database_page_id:pageRec.id, name:'Table', view_type:'table',
    filter_rules:[], sort_rules:[], visible_property_ids:viewProps,
    is_default:true, sort_order:0
  });
  const selectProp = schema.properties.find(p => p.type === 'select');
  if(selectProp) {
    await api.create('database_views', {
      database_page_id:pageRec.id, name:'Board', view_type:'board',
      filter_rules:[], sort_rules:[], group_by_property_id:selectProp.id,
      visible_property_ids:viewProps, is_default:false, sort_order:1
    });
  }

  navigateTo(pageRec.id);
  renderSidebar();
  toast('Database created from template');
}

// ============================================================
// SHARE MODAL
// ============================================================
function openShare() {
  if(!S.currentPageId) return;
  const modal = document.getElementById('share-modal');
  modal.classList.add('visible');
  renderShareModal();
}

function closeShare() {
  document.getElementById('share-modal').classList.remove('visible');
}

function showUpgradeModal(title, msg) {
  const el = document.getElementById('upgrade-modal');
  document.getElementById('upgrade-content').innerHTML = `
    <div class="upgrade-icon">🚀</div>
    <div class="upgrade-title">${title}</div>
    <div class="upgrade-msg">${msg}</div>
    <a href="${PLAN.upgradeUrl}" target="_blank" class="upgrade-btn"><i data-lucide="zap" style="width:16px;height:16px"></i> Upgrade to Pro</a>
    <button class="upgrade-dismiss" onclick="closeUpgradeModal()">Maybe later</button>
  `;
  el.style.display = '';
  el.classList.add('visible');
  renderIcons(el);
}

function closeUpgradeModal() {
  const el = document.getElementById('upgrade-modal');
  el.classList.remove('visible');
  el.style.display = 'none';
}

async function renderShareModal() {
  const content = document.getElementById('share-content');
  if(!content) return;

  let perms = [];
  try {
    const res = await api.list('page_permissions', {where:{page_id:S.currentPageId}});
    perms = res.records || [];
  } catch(e) {}

  content.innerHTML = `
    <div class="modal-header"><h2>Share</h2><button class="panel-close" onclick="closeShare()"><i data-lucide="x"></i></button></div>
    <div class="modal-body">
      <div style="margin-bottom:16px">
        <button class="btn-secondary" onclick="copyPageLink()" style="width:100%"><i data-lucide="link" style="width:14px;height:14px"></i> Copy Link</button>
      </div>
      <div style="font-size:12px;font-weight:600;color:#605e5c;margin-bottom:8px">Permissions</div>
      <div class="perm-list">
        ${perms.length === 0 ? '<div style="color:#a19f9d;font-size:12px;padding:8px 0">No explicit permissions set. Team members have default access.</div>' : ''}
        ${perms.map(p => `
          <div class="perm-item">
            <span class="perm-avatar">${(p.data.target_id||'E').toString().charAt(0).toUpperCase()}</span>
            <span class="perm-name">${esc(p.data.target_type==='everyone'?'Everyone':p.data.target_id||'User')}</span>
            <select onchange="updatePermission('${p.id}',this.value)">
              <option value="full_access"${p.data.permission_level==='full_access'?' selected':''}>Full Access</option>
              <option value="can_edit"${p.data.permission_level==='can_edit'?' selected':''}>Can Edit</option>
              <option value="can_comment"${p.data.permission_level==='can_comment'?' selected':''}>Can Comment</option>
              <option value="can_view"${p.data.permission_level==='can_view'?' selected':''}>Can View</option>
            </select>
          </div>
        `).join('')}
      </div>
      <div style="border-top:1px solid #ddd9d7;padding-top:12px">
        <div style="font-size:12px;font-weight:600;color:#605e5c;margin-bottom:8px">Add Permission</div>
        <div style="display:flex;gap:8px">
          <select id="perm-level" style="border:1px solid #8a8886;height:32px;padding:0 8px;font-size:12px;flex:1">
            <option value="can_edit">Can Edit</option>
            <option value="can_view">Can View</option>
            <option value="can_comment">Can Comment</option>
            <option value="full_access">Full Access</option>
          </select>
          <button class="btn-primary" onclick="addEveryonePermission()">Add for Everyone</button>
        </div>
      </div>
    </div>
  `;
  renderIcons(content);
}

async function addEveryonePermission() {
  const level = document.getElementById('perm-level')?.value || 'can_edit';
  await api.create('page_permissions', {
    page_id: S.currentPageId, target_type:'everyone', target_id:null,
    permission_level:level, inherited:false,
    granted_by_user_id:S.user?.id, granted_at:new Date().toISOString()
  });
  renderShareModal();
  toast('Permission added');
}

async function updatePermission(permId, level) {
  await api.update('page_permissions', permId, {permission_level:level});
  toast('Permission updated');
}

function copyPageLink() {
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => toast('Link copied'));
}
// ============================================================
// PAGE OPERATIONS
// ============================================================
async function createNewPage(parentId) {
  const pageData = {
    title:'', icon:'📄', page_type:'page',
    content_blocks:[{id:uid(),type:'paragraph',content:[],properties:{},children:[],indent_level:0}],
    parent_page_id: parentId || null,
    is_archived:false, sort_order: S.pages.length,
    full_width:false, small_text:false, font:'sans'
  };
  const rec = await api.create('pages', pageData);
  S.pages.push(rec);
  if(!S.user && rec.createdBy) S.user = rec.createdBy;
  if(parentId) S.expandedPages.add(parentId);
  navigateTo(rec.id);
  renderSidebar();
  // Focus title
  setTimeout(() => {
    const titleInput = document.querySelector('.page-title-input');
    if(titleInput) titleInput.focus();
  }, 200);
}

async function createSubPage(parentId) {
  await createNewPage(parentId);
}

async function createNewDatabase() {
  const dbCount = S.pages.filter(p => p.data.page_type === 'database' && !p.data.is_archived).length;
  if(dbCount >= PLAN.maxTables) {
    if(PLAN.showUpgrade) {
      showUpgradeModal('Table limit reached', `The Free plan supports up to ${PLAN.maxTables} tables. Upgrade to Pro for up to 1,000 tables and 10,000 rows per table.`);
    }
    return;
  }
  const pageData = {
    title:'', icon:'🗃️', page_type:'database',
    content_blocks:[], parent_page_id:null,
    is_archived:false, sort_order: S.pages.length,
    full_width:true, small_text:false, font:'sans'
  };
  const rec = await api.create('pages', pageData);
  S.pages.push(rec);
  if(!S.user && rec.createdBy) S.user = rec.createdBy;
  navigateTo(rec.id);
  renderSidebar();
  setTimeout(() => {
    const titleInput = document.querySelector('.page-title-input');
    if(titleInput) titleInput.focus();
  }, 200);
}

async function archivePage(pageId) {
  const page = S.pages.find(p => p.id === pageId);
  if(!page) return;
  closeContextMenu();
  page.data.is_archived = true;
  page.data.archived_at = new Date().toISOString();
  page.data.archived_by = S.user?.username || 'Unknown';
  await api.update('pages', pageId, {is_archived:true, archived_at:page.data.archived_at, archived_by:page.data.archived_by});

  // Archive children too
  const children = S.pages.filter(p => p.data.parent_page_id === pageId);
  for(const child of children) {
    child.data.is_archived = true;
    child.data.archived_at = page.data.archived_at;
    child.data.archived_by = page.data.archived_by;
    await api.update('pages', child.id, {is_archived:true, archived_at:child.data.archived_at, archived_by:child.data.archived_by});
  }

  if(S.currentPageId === pageId) {
    const nextPage = S.pages.find(p => !p.data.is_archived && !p.data.is_template);
    if(nextPage) navigateTo(nextPage.id);
    else { S.currentPageId = null; S.currentPage = null; renderPage(); }
  }
  renderSidebar();
  toast('Moved to Trash');
}

async function duplicatePage(pageId) {
  const page = S.pages.find(p => p.id === pageId);
  if(!page) return;
  closeContextMenu();
  const newData = JSON.parse(JSON.stringify(page.data));
  newData.title = (newData.title || 'Untitled') + ' (copy)';
  newData.sort_order = S.pages.length;
  // Regenerate block IDs
  if(newData.content_blocks) {
    const reId = (blocks) => { blocks.forEach(b => { b.id = uid(); if(b.children) reId(b.children); }); };
    reId(newData.content_blocks);
  }
  const rec = await api.create('pages', newData);
  S.pages.push(rec);
  navigateTo(rec.id);
  renderSidebar();
  toast('Page duplicated');
}

async function addFavorite(pageId) {
  const rec = await api.create('favorites', {user_id:S.user?.id, page_id:pageId, sort_order:S.favorites.length});
  S.favorites.push(rec);
  S.favMap[pageId] = rec.id;
  renderSidebar();
  renderTopbar();
  toast('Added to favorites');
}

async function removeFavorite(pageId) {
  const favId = S.favMap[pageId];
  if(!favId) return;
  closeContextMenu();
  await api.delete('favorites', favId);
  S.favorites = S.favorites.filter(f => f.id !== favId);
  delete S.favMap[pageId];
  renderSidebar();
  renderTopbar();
  toast('Removed from favorites');
}

function addCover() {
  const url = prompt('Enter cover image URL:');
  if(!url) return;
  S.currentPage.data.cover_image_url = url;
  S.currentPage.data.cover_position_y = 50;
  api.update('pages', S.currentPageId, {cover_image_url:url, cover_position_y:50});
  renderPage();
}

function changeCover() {
  const url = prompt('Enter new cover image URL:', S.currentPage?.data.cover_image_url || '');
  if(!url) return;
  S.currentPage.data.cover_image_url = url;
  api.update('pages', S.currentPageId, {cover_image_url:url});
  renderPage();
}

function removeCover() {
  S.currentPage.data.cover_image_url = null;
  api.update('pages', S.currentPageId, {cover_image_url:null});
  renderPage();
}

// ============================================================
// NAVIGATION
// ============================================================
async function navigateTo(pageId) {
  if(!pageId) return;
  S.trashView = false;
  S.currentPageId = pageId;
  S.currentViewId = null;
  S.rightPanel = null;
  document.getElementById('right-panel')?.classList.remove('open');

  // Find page in local state
  let page = S.pages.find(p => p.id === pageId);
  if(!page) {
    try {
      page = await api.get('pages', pageId);
      if(page) S.pages.push(page);
    } catch(e) { toast('Page not found','error'); return; }
  }
  S.currentPage = page;

  // Update URL query parameter
  const url = new URL(window.location);
  url.searchParams.set('page', pageId);
  history.replaceState(null, '', url);

  // Expand parent chain
  let p = page;
  while(p?.data.parent_page_id) {
    S.expandedPages.add(p.data.parent_page_id);
    p = S.pages.find(pp => pp.id === p.data.parent_page_id);
  }

  // Load comments
  try {
    const res = await api.list('comments', {where:{page_id:pageId}, limit:50});
    S.comments = res.records || [];
  } catch(e) { S.comments = []; }

  renderSidebar();
  renderTopbar();
  renderPage();
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    // Ctrl+K: Search
    if((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      openSearch();
    }
    // Ctrl+N: New page
    if((e.ctrlKey || e.metaKey) && e.key === 'n' && !e.shiftKey) {
      e.preventDefault();
      createNewPage();
    }
    // Ctrl+Shift+N: New database
    if((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'N') {
      e.preventDefault();
      createNewDatabase();
    }
    // Escape: close modals and menus
    if(e.key === 'Escape') {
      closeSearch();
      closeTemplates();
      closeShare();
      closeRecordModal();
      closeSlashMenu();
      closeFormatToolbar();
      closeContextMenu();
      document.getElementById('emoji-picker')?.classList.remove('visible');
    }
  });
}

// ============================================================
// INITIALIZATION
// ============================================================
async function initApp() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <aside id="sidebar"></aside>
    <div id="main-wrapper">
      <header id="topbar"></header>
      <div id="page-area"><div class="loading"><div class="spinner"></div> Loading workspace...</div></div>
    </div>
    <aside id="right-panel"></aside>
  `;

  setupKeyboardShortcuts();

  try {
    // Wait for TeamData SDK to be ready
    await TeamData.ready;

    // Check authentication
    if(!TeamData.isAuthenticated()) {
      TeamData.promptLogin();
      return;
    }

    // Get current user from TeamData SDK
    S.user = TeamData.getCurrentUser();

    // Load workspace settings
    const settingsRes = await api.list('workspace_settings', {limit:1});
    if(settingsRes.records?.length > 0) {
      S.settings = settingsRes.records[0];
      S.settingsId = settingsRes.records[0].id;
    } else {
      // First-time setup
      await firstTimeSetup();
    }

    // Load all pages
    const pagesRes = await api.list('pages', {limit:100, orderBy:'created_at', order:'asc'});
    S.pages = pagesRes.records || [];

    // Load favorites
    try {
      const favRes = await api.list('favorites', {limit:50});
      S.favorites = favRes.records || [];
      S.favorites.forEach(f => { S.favMap[f.data.page_id] = f.id; });
    } catch(e) { S.favorites = []; }

    S.loading = false;
    renderSidebar();

    // Navigate to page from URL query param, or first page
    const urlPageId = new URLSearchParams(window.location.search).get('page');
    const targetPage = urlPageId && S.pages.find(p => p.id === urlPageId && !p.data.is_archived)
      ? S.pages.find(p => p.id === urlPageId)
      : S.pages.find(p => !p.data.is_archived && !p.data.is_template);
    if(targetPage) {
      navigateTo(targetPage.id);
    } else {
      renderTopbar();
      renderPage();
    }

  } catch(err) {
    console.error('Init error:', err);
    document.getElementById('page-area').innerHTML = `
      <div class="empty-state">
        <i data-lucide="alert-circle" style="width:48px;height:48px;color:#d13438"></i>
        <p style="color:#d13438">Failed to load workspace</p>
        <p class="sub">${esc(err.message)}</p>
        <button class="btn-primary" style="margin-top:16px" onclick="initApp()">Retry</button>
      </div>
    `;
    renderIcons(document.getElementById('page-area'));
  }
}

async function firstTimeSetup() {
  // Create workspace settings
  const settings = {
    sidebar_width: 240,
    default_page_icon: '📄',
    default_cover_style: 'gradient',
    allowed_fonts: ['sans','serif','mono'],
    enable_comments: true,
    enable_page_history: true,
    enable_ai_assist: false,
    trash_retention_days: 30
  };
  const settingsRec = await api.create('workspace_settings', settings);
  S.settings = settingsRec;
  S.settingsId = settingsRec.id;
  // User identity obtained from TeamData.getCurrentUser() at init

  // Create Getting Started page
  const gettingStarted = await api.create('pages', {
    title: 'Getting Started',
    icon: '🚀',
    page_type: 'page',
    content_blocks: [
      {id:uid(),type:'heading_1',content:plainRt('Welcome to Team Wiki'),properties:{},children:[],indent_level:0},
      {id:uid(),type:'paragraph',content:plainRt('This is your team\'s knowledge base and workspace. Here\'s how to get started:'),properties:{},children:[],indent_level:0},
      {id:uid(),type:'heading_2',content:plainRt('Quick Start'),properties:{},children:[],indent_level:0},
      {id:uid(),type:'to_do',content:plainRt('Create your first page using the "+ New Page" button in the sidebar'),properties:{checked:false},children:[],indent_level:0},
      {id:uid(),type:'to_do',content:plainRt('Try the slash command (/) to add different block types'),properties:{checked:false},children:[],indent_level:0},
      {id:uid(),type:'to_do',content:plainRt('Create a database to track projects, tasks, or any structured data'),properties:{checked:false},children:[],indent_level:0},
      {id:uid(),type:'to_do',content:plainRt('Use templates to quickly create pages with pre-built structures'),properties:{checked:false},children:[],indent_level:0},
      {id:uid(),type:'to_do',content:plainRt('Invite your team members to collaborate'),properties:{checked:false},children:[],indent_level:0},
      {id:uid(),type:'divider',content:null,properties:{},children:[],indent_level:0},
      {id:uid(),type:'heading_2',content:plainRt('Features'),properties:{},children:[],indent_level:0},
      {id:uid(),type:'callout',content:plainRt('Pages — Create documents with rich text, headings, lists, code blocks, and more'),properties:{icon:'📄',color:'blue'},children:[],indent_level:0},
      {id:uid(),type:'callout',content:plainRt('Databases — Track structured data with table, board, list, calendar, and gallery views'),properties:{icon:'🗃️',color:'green'},children:[],indent_level:0},
      {id:uid(),type:'callout',content:plainRt('Comments — Discuss and collaborate inline or at the page level'),properties:{icon:'💬',color:'yellow'},children:[],indent_level:0},
      {id:uid(),type:'callout',content:plainRt('Templates — Start from pre-built templates for meetings, specs, wikis, and more'),properties:{icon:'📋',color:'purple'},children:[],indent_level:0},
      {id:uid(),type:'divider',content:null,properties:{},children:[],indent_level:0},
      {id:uid(),type:'heading_2',content:plainRt('Keyboard Shortcuts'),properties:{},children:[],indent_level:0},
      {id:uid(),type:'toggle',content:plainRt('View all shortcuts'),properties:{open:false},children:[
        {id:uid(),type:'bulleted_list',content:plainRt('Ctrl+K — Quick search'),properties:{},children:[],indent_level:0},
        {id:uid(),type:'bulleted_list',content:plainRt('Ctrl+N — New page'),properties:{},children:[],indent_level:0},
        {id:uid(),type:'bulleted_list',content:plainRt('Ctrl+B/I/U — Bold / Italic / Underline'),properties:{},children:[],indent_level:0},
        {id:uid(),type:'bulleted_list',content:plainRt('/ — Slash commands to insert blocks'),properties:{},children:[],indent_level:0},
        {id:uid(),type:'bulleted_list',content:plainRt('Tab / Shift+Tab — Indent / Outdent'),properties:{},children:[],indent_level:0},
        {id:uid(),type:'bulleted_list',content:plainRt('Ctrl+D — Duplicate block'),properties:{},children:[],indent_level:0},
      ],indent_level:0},
    ],
    parent_page_id: null,
    is_archived: false,
    sort_order: 0,
    full_width: false,
    small_text: false,
    font: 'sans'
  });

  // Create Team Tasks database
  const teamTasks = await api.create('pages', {
    title: 'Team Tasks',
    icon: '🎯',
    page_type: 'database',
    content_blocks: [],
    parent_page_id: null,
    is_archived: false,
    sort_order: 1,
    full_width: true,
    small_text: false,
    font: 'sans'
  });

  // Create schema for Team Tasks
  const titleId = uid(), statusId = uid(), priorityId = uid(), dueId = uid(), notesId = uid();
  await api.create('database_schemas', {
    page_id: teamTasks.id,
    properties: [
      {id:titleId, name:'Task', type:'title', options:{}, sort_order:0, visible:true, width:250},
      {id:statusId, name:'Status', type:'select', options:{choices:[
        {id:uid(),name:'Not Started',color:'light_gray'},
        {id:uid(),name:'In Progress',color:'blue'},
        {id:uid(),name:'Done',color:'green'}
      ]}, sort_order:1, visible:true, width:140},
      {id:priorityId, name:'Priority', type:'select', options:{choices:[
        {id:uid(),name:'Low',color:'gray'},
        {id:uid(),name:'Medium',color:'yellow'},
        {id:uid(),name:'High',color:'orange'},
        {id:uid(),name:'Urgent',color:'red'}
      ]}, sort_order:2, visible:true, width:120},
      {id:dueId, name:'Due Date', type:'date', options:{include_time:false}, sort_order:3, visible:true, width:140},
      {id:notesId, name:'Notes', type:'text', options:{}, sort_order:4, visible:true, width:200}
    ],
    title_property_id: titleId
  });

  // Create default views
  const allPropIds = [titleId, statusId, priorityId, dueId, notesId];
  await api.create('database_views', {
    database_page_id: teamTasks.id, name:'Table', view_type:'table',
    filter_rules:[], sort_rules:[], visible_property_ids:allPropIds,
    is_default:true, sort_order:0
  });
  await api.create('database_views', {
    database_page_id: teamTasks.id, name:'Board', view_type:'board',
    filter_rules:[], sort_rules:[], group_by_property_id:statusId,
    visible_property_ids:allPropIds, is_default:false, sort_order:1
  });
  await api.create('database_views', {
    database_page_id: teamTasks.id, name:'Calendar', view_type:'calendar',
    filter_rules:[], sort_rules:[], calendar_by_property_id:dueId,
    visible_property_ids:allPropIds, is_default:false, sort_order:2
  });

  // Create sample records
  const sampleTasks = [
    {[titleId]:'Set up project repository', [statusId]:{selected:'Done'}, [priorityId]:{selected:'High'}, [dueId]:{start:new Date().toISOString().split('T')[0]}, [notesId]:'Initial repo setup complete'},
    {[titleId]:'Write project documentation', [statusId]:{selected:'In Progress'}, [priorityId]:{selected:'Medium'}, [dueId]:{start:new Date(Date.now()+86400000*3).toISOString().split('T')[0]}, [notesId]:'Working on README and architecture docs'},
    {[titleId]:'Design system components', [statusId]:{selected:'Not Started'}, [priorityId]:{selected:'High'}, [dueId]:{start:new Date(Date.now()+86400000*7).toISOString().split('T')[0]}, [notesId]:'Button, input, modal components'},
    {[titleId]:'API integration', [statusId]:{selected:'Not Started'}, [priorityId]:{selected:'Urgent'}, [dueId]:{start:new Date(Date.now()+86400000*5).toISOString().split('T')[0]}, [notesId]:'Connect to backend services'},
    {[titleId]:'User testing', [statusId]:{selected:'Not Started'}, [priorityId]:{selected:'Low'}, [dueId]:{start:new Date(Date.now()+86400000*14).toISOString().split('T')[0]}, [notesId]:'Schedule user testing sessions'},
  ];
  for(const task of sampleTasks) {
    await api.create('database_records', {database_page_id:teamTasks.id, values:task, sub_page_content_blocks:[], is_archived:false});
  }
}

// Start the app
document.addEventListener('DOMContentLoaded', initApp);

</script>
</body>
</html>